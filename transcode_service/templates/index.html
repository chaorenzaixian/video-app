<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬ç ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 200px; background: #16213e; padding: 20px 0; display: flex; flex-direction: column; }
        .logo { padding: 0 20px 20px; font-size: 18px; font-weight: 600; color: #00d4ff; border-bottom: 1px solid #2a2a4a; }
        .nav { flex: 1; padding: 15px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; color: #888; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(0,212,255,0.1); color: #fff; }
        .nav-item.active { background: rgba(0,212,255,0.15); color: #00d4ff; border-left-color: #00d4ff; }
        .nav-item .icon { margin-right: 10px; font-size: 16px; }
        .nav-item .badge { margin-left: auto; background: #ff4757; color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; }
        .sys-info { padding: 15px 20px; border-top: 1px solid #2a2a4a; font-size: 12px; color: #666; }
        .sys-info .disk { color: #00ff88; }
        .sys-info .disk.warning { color: #ffd700; }
        .sys-info .disk.critical { color: #ff4444; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 20px 30px; background: #16213e; border-bottom: 1px solid #2a2a4a; }
        .header h2 { font-size: 20px; font-weight: 500; }
        .content { flex: 1; padding: 25px 30px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .upload-box { border: 2px dashed #3a3a5a; border-radius: 12px; padding: 50px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-box:hover { border-color: #00d4ff; background: rgba(0,212,255,0.05); }
        .upload-box .icon { font-size: 48px; margin-bottom: 15px; }
        .list-item { display: flex; align-items: center; padding: 15px; background: #0f0f23; border-radius: 10px; margin-bottom: 10px; }
        .list-item:hover { background: #1a1a35; }
        .list-item .thumb { width: 100px; height: 56px; background: #2a2a4a; border-radius: 6px; margin-right: 15px; object-fit: cover; }
        .list-item .info { flex: 1; min-width: 0; }
        .list-item .title { font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .meta { font-size: 12px; color: #666; }
        .list-item .status { padding: 4px 12px; border-radius: 15px; font-size: 12px; }
        .status-pending { background: rgba(255,215,0,0.2); color: #ffd700; }
        .status-processing { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .status-ready { background: rgba(0,255,136,0.2); color: #00ff88; }
        .status-completed { background: rgba(0,255,136,0.2); color: #00ff88; }
        .progress { height: 4px; background: #2a2a4a; border-radius: 2px; margin-top: 8px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #00d4ff, #00ff88); border-radius: 2px; transition: width 0.3s; }
        .btn { padding: 8px 20px; border-radius: 20px; border: none; cursor: pointer; font-size: 13px; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #00ff88); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #3a3a5a; color: #888; }
        .btn-outline:hover { border-color: #00d4ff; color: #00d4ff; }
        .btn-danger { background: transparent; border: 1px solid #ff4757; color: #ff4757; }
        .btn-danger:hover { background: #ff4757; color: #fff; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #0f0f23; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-card .value { font-size: 28px; font-weight: 600; color: #00d4ff; }
        .stat-card .label { font-size: 12px; color: #666; margin-top: 5px; }
        .empty { text-align: center; padding: 60px; color: #666; }
        .empty .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; color: #888; margin-bottom: 6px; }
        .form-control { width: 100%; padding: 10px 15px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 8px; color: #e0e0e0; }
        .form-control:focus { outline: none; border-color: #00d4ff; }
        .covers { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .cover-item { aspect-ratio: 16/9; border-radius: 6px; overflow: hidden; cursor: pointer; border: 2px solid transparent; }
        .cover-item:hover { opacity: 0.8; }
        .cover-item.selected { border-color: #00ff88; }
        .cover-item img { width: 100%; height: 100%; object-fit: cover; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #16213e; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #2a2a4a; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #2a2a4a; display: flex; justify-content: flex-end; gap: 10px; }
        .close-btn { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto; padding: 8px; background: #0f0f23; border-radius: 8px; border: 1px solid #2a2a4a; }
        .tag-item { padding: 4px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; transition: all 0.2s; background: #2a2a4a; color: #888; }
        .tag-item:hover { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .tag-item.selected { background: #00d4ff; color: #000; }
        .tab-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #2a2a4a; background: #0f0f23; color: #888; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .tab-btn:hover { border-color: #00d4ff; color: #00d4ff; }
        .tab-btn.active { background: linear-gradient(135deg, #00d4ff, #00ff88); border-color: transparent; color: #000; font-weight: 500; }
        .tab-btn span { margin-left: 5px; padding: 2px 8px; border-radius: 10px; background: rgba(0,0,0,0.2); font-size: 12px; }
        .pagination-bar { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 20px; }
        .page-btn { padding: 8px 14px; border: 1px solid #2a2a4a; background: #0f0f23; color: #888; cursor: pointer; border-radius: 6px; font-size: 13px; }
        .page-btn:hover { border-color: #00d4ff; color: #00d4ff; }
        .page-btn.active { background: #00d4ff; border-color: #00d4ff; color: #000; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { color: #666; font-size: 13px; margin: 0 15px; }
        .item-checkbox { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; accent-color: #00d4ff; }
        .category-selector { position: relative; }
        .category-display { width: 100%; padding: 10px 15px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 8px; color: #e0e0e0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .category-display:hover { border-color: #00d4ff; }
        .category-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #16213e; border: 1px solid #2a2a4a; border-radius: 8px; margin-top: 4px; max-height: 300px; overflow-y: auto; z-index: 100; display: none; }
        .category-dropdown.show { display: block; }
        .category-group { border-bottom: 1px solid #2a2a4a; }
        .category-group:last-child { border-bottom: none; }
        .category-parent { padding: 10px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #00d4ff; font-weight: 500; }
        .category-parent:hover { background: rgba(0,212,255,0.1); }
        .category-parent .arrow { transition: transform 0.2s; }
        .category-parent.expanded .arrow { transform: rotate(90deg); }
        .category-children { display: none; background: #0f0f23; }
        .category-children.show { display: block; }
        .category-child { padding: 8px 15px 8px 30px; cursor: pointer; color: #888; }
        .category-child:hover { background: rgba(0,212,255,0.1); color: #fff; }
        .category-child.selected { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .category-flat { padding: 8px 15px; cursor: pointer; color: #888; }
        .category-flat:hover { background: rgba(0,212,255,0.1); color: #fff; }
        .category-flat.selected { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .list-item .actions { display: flex; gap: 8px; }
        /* å°é¢æ”¾å¤§é¢„è§ˆ */
        .cover-preview-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .cover-preview-modal.show { display: flex; }
        .cover-preview-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .cover-preview-modal .close-btn { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; }
        /* ä¸Šä¼ å°é¢æŒ‰é’® */
        .cover-upload-item { aspect-ratio: 16/9; border-radius: 6px; border: 2px dashed #3a3a5a; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; flex-direction: column; gap: 4px; }
        .cover-upload-item:hover { border-color: #00d4ff; background: rgba(0,212,255,0.05); }
        .cover-upload-item .icon { font-size: 20px; }
        .cover-upload-item .text { font-size: 11px; color: #888; }
        .cover-item .zoom-icon { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .cover-item .zoom-icon:hover { background: rgba(0,212,255,0.8); transform: scale(1.1); }
        .cover-item:hover .zoom-icon { opacity: 1; }
        .cover-item img { cursor: pointer; }
        .cover-item { position: relative; }
        /* æ–‡ä»¶æµè§ˆå™¨æ ·å¼ */
        .file-item { display: flex; align-items: center; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .file-item:hover { background: rgba(0,212,255,0.1); }
        .file-item .icon { font-size: 20px; margin-right: 12px; }
        .file-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-item .size { color: #666; font-size: 12px; margin-left: 10px; }
        .file-item.folder { color: #ffd700; }
        .file-item.video { color: #00d4ff; }
        .file-item.drive { color: #00ff88; }
        .file-item.selected { background: rgba(0,212,255,0.2); border: 1px solid #00d4ff; }
        .file-item .checkbox { width: 18px; height: 18px; margin-right: 10px; accent-color: #00d4ff; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">ğŸ¬ è½¬ç ç®¡ç†</div>
        <div class="nav">
            <div class="nav-item active" data-page="upload"><span class="icon">ğŸ“¤</span>ä¸Šä¼ è§†é¢‘</div>
            <div class="nav-item" data-page="queue"><span class="icon">ğŸ“‹</span>è½¬ç é˜Ÿåˆ—<span class="badge" id="queueBadge">0</span></div>
            <div class="nav-item" data-page="pending"><span class="icon">âœï¸</span>å¾…å‘å¸ƒ<span class="badge" id="pendingBadge">0</span></div>
            <div class="nav-item" data-page="history"><span class="icon">ğŸ“œ</span>å‘å¸ƒå†å²</div>
        </div>
        <div class="sys-info">
            <div>ç£ç›˜ç©ºé—´</div>
            <div id="diskInfo" class="disk">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <div class="main">
        <div class="header"><h2 id="pageTitle">ä¸Šä¼ è§†é¢‘</h2></div>
        <div class="content">
            <!-- ä¸Šä¼ é¡µ -->
            <div class="page active" id="page-upload">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:20px">
                    <div style="background:#0f0f23;border-radius:12px;padding:20px">
                        <h3 style="margin-bottom:15px;color:#00d4ff">ğŸ“º é•¿è§†é¢‘</h3>
                        <div style="margin-bottom:15px;color:#888;font-size:13px">è¾“å…¥æœåŠ¡å™¨æœ¬åœ°è§†é¢‘è·¯å¾„</div>
                        <div style="display:flex;gap:8px;margin-bottom:10px">
                            <input type="text" class="form-control" id="longLocalPath" placeholder="D:\videos\xxx.mp4" style="flex:1">
                            <button class="btn btn-outline" onclick="openFileBrowser('long')" title="æµè§ˆ">ğŸ“</button>
                        </div>
                        <button class="btn btn-primary" style="width:100%" onclick="addLocalFile('long')">ğŸ“¤ æ·»åŠ åˆ°è½¬ç é˜Ÿåˆ—</button>
                    </div>
                    <div style="background:#0f0f23;border-radius:12px;padding:20px">
                        <h3 style="margin-bottom:15px;color:#ff6b9d">ğŸ“± çŸ­è§†é¢‘</h3>
                        <div style="margin-bottom:15px;color:#888;font-size:13px">è¾“å…¥æœåŠ¡å™¨æœ¬åœ°è§†é¢‘è·¯å¾„</div>
                        <div style="display:flex;gap:8px;margin-bottom:10px">
                            <input type="text" class="form-control" id="shortLocalPath" placeholder="D:\videos\xxx.mp4" style="flex:1">
                            <button class="btn btn-outline" onclick="openFileBrowser('short')" title="æµè§ˆ">ğŸ“</button>
                        </div>
                        <button class="btn btn-primary" style="width:100%" onclick="addLocalFile('short')">ğŸ“¤ æ·»åŠ åˆ°è½¬ç é˜Ÿåˆ—</button>
                    </div>
                    <div style="background:#0f0f23;border-radius:12px;padding:20px;border:1px solid #8b0000">
                        <h3 style="margin-bottom:15px;color:#ff4444">ğŸ” æš—ç½‘è§†é¢‘</h3>
                        <div style="margin-bottom:15px;color:#888;font-size:13px">è¾“å…¥æœåŠ¡å™¨æœ¬åœ°è§†é¢‘è·¯å¾„</div>
                        <div style="display:flex;gap:8px;margin-bottom:10px">
                            <input type="text" class="form-control" id="darkwebLocalPath" placeholder="D:\videos\xxx.mp4" style="flex:1">
                            <button class="btn btn-outline" onclick="openFileBrowser('darkweb')" title="æµè§ˆ">ğŸ“</button>
                        </div>
                        <button class="btn btn-primary" style="width:100%;background:linear-gradient(135deg,#ff4444,#8b0000)" onclick="addLocalFile('darkweb')">ğŸ“¤ æ·»åŠ åˆ°è½¬ç é˜Ÿåˆ—</button>
                    </div>
                    <div style="background:#0f0f23;border-radius:12px;padding:20px;border:1px solid #3a3a5a">
                        <h3 style="margin-bottom:15px;color:#888">ğŸŒ æµè§ˆå™¨ä¸Šä¼ </h3>
                        <div style="margin-bottom:10px">
                            <select class="form-control" id="browserUploadType" style="margin-bottom:10px">
                                <option value="long">é•¿è§†é¢‘</option>
                                <option value="short">çŸ­è§†é¢‘</option>
                                <option value="darkweb">æš—ç½‘è§†é¢‘</option>
                            </select>
                        </div>
                        <div class="upload-box" style="padding:15px;cursor:pointer" onclick="document.getElementById('browserFileInput').click()">
                            <div class="icon" style="font-size:32px">ğŸ“¤</div>
                            <div style="font-size:12px">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                            <input type="file" id="browserFileInput" accept="video/*" multiple hidden>
                        </div>
                    </div>
                </div>
                <div id="uploadProgress" style="display:none;margin-top:25px">
                    <div class="progress"><div class="progress-bar" style="width:0%"></div></div>
                    <div style="text-align:center;margin-top:10px;font-size:13px;color:#888" id="uploadStatus">å‡†å¤‡ä¸­...</div>
                </div>
            </div>
            
            <!-- é˜Ÿåˆ—é¡µ -->
            <div class="page" id="page-queue">
                <div id="queueStats" style="margin-bottom:15px;color:#888;font-size:13px"></div>
                <div id="queueList"></div>
            </div>
            
            <!-- å¾…å‘å¸ƒé¡µ -->
            <div class="page" id="page-pending">
                <div class="pending-tabs" style="display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap">
                    <button class="tab-btn active" data-type="all" onclick="switchPendingTab('all')">å…¨éƒ¨ <span id="pendingAllCount">0</span></button>
                    <button class="tab-btn" data-type="long" onclick="switchPendingTab('long')">ğŸ“º é•¿è§†é¢‘ <span id="pendingLongCount">0</span></button>
                    <button class="tab-btn" data-type="short" onclick="switchPendingTab('short')">ğŸ“± çŸ­è§†é¢‘ <span id="pendingShortCount">0</span></button>
                    <button class="tab-btn" data-type="darkweb" onclick="switchPendingTab('darkweb')" style="border-color:#8b0000;color:#ff4444">ğŸ” æš—ç½‘ <span id="pendingDarkwebCount">0</span></button>
                    <div style="flex:1"></div>
                    <input type="text" class="form-control" id="pendingSearch" placeholder="æœç´¢æ ‡é¢˜..." style="width:180px" onkeyup="if(event.key==='Enter')renderPendingList()">
                    <button class="btn btn-outline" onclick="renderPendingList()">ğŸ”</button>
                </div>
                <div class="pending-actions" style="display:flex;gap:10px;margin-bottom:15px;align-items:center">
                    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;color:#888;font-size:13px">
                        <input type="checkbox" id="selectAllPending" onchange="toggleSelectAll()"> å…¨é€‰
                    </label>
                    <span id="selectedCount" style="color:#888;font-size:13px"></span>
                    <button class="btn btn-primary" id="batchPublishBtn" style="display:none" onclick="batchPublish()">ğŸš€ æ‰¹é‡å‘å¸ƒ</button>
                    <button class="btn btn-danger" id="batchDeleteBtn" style="display:none" onclick="batchDelete()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                    <div style="flex:1"></div>
                    <button class="btn btn-danger" onclick="deleteAllPending()" style="opacity:0.8">ğŸ—‘ï¸ ä¸€é”®åˆ é™¤å…¨éƒ¨</button>
                </div>
                <div id="pendingList"></div>
                <div id="pendingPagination" class="pagination-bar" style="display:none"></div>
            </div>
            
            <!-- å†å²é¡µ -->
            <div class="page" id="page-history">
                <div class="stats" id="historyStats"></div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘è§†é¢‘ä¿¡æ¯</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:25px">
                    <div>
                        <video id="previewVideo" controls style="width:100%;border-radius:8px;background:#000;max-height:200px"></video>
                        <div class="form-group" style="margin-top:15px">
                            <label class="form-label">é€‰æ‹©å°é¢</label>
                            <div id="coversGrid" class="covers"></div>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label">è§†é¢‘ç±»å‹</label>
                            <div style="display:flex;gap:10px">
                                <button class="tab-btn" id="typeBtn-long" onclick="switchVideoType('long')">ğŸ“º é•¿è§†é¢‘</button>
                                <button class="tab-btn" id="typeBtn-short" onclick="switchVideoType('short')">ğŸ“± çŸ­è§†é¢‘</button>
                                <button class="tab-btn" id="typeBtn-darkweb" onclick="switchVideoType('darkweb')" style="border-color:#8b0000">ğŸ” æš—ç½‘</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="editTitle">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æè¿°</label>
                            <textarea class="form-control" id="editDescription" rows="2" style="resize:vertical"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆ†ç±»</label>
                            <div class="category-selector">
                                <div class="category-display" onclick="toggleCategoryDropdown()">
                                    <span id="selectedCategoryText">é€‰æ‹©åˆ†ç±»</span>
                                    <span>â–¼</span>
                                </div>
                                <div class="category-dropdown" id="categoryDropdown"></div>
                                <input type="hidden" id="editCategory" value="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ ‡ç­¾ <span style="color:#666;font-size:11px">(å¯å¤šé€‰)</span></label>
                            <div id="tagsContainer" class="tags-container"></div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                            <div class="form-group">
                                <label class="form-label">é‡‘å¸ä»·æ ¼</label>
                                <input type="number" class="form-control" id="editCoin" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å…è´¹é¢„è§ˆ(ç§’)</label>
                                <input type="number" class="form-control" id="editPreview" value="15">
                            </div>
                        </div>
                        <div style="display:flex;gap:20px">
                            <div class="form-group">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                    <input type="checkbox" id="editVipOnly"> VIPä¸“å±
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                    <input type="checkbox" id="editFeatured"> â­ æ¨è
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="publishVideo()">ğŸš€ å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- å°é¢æ”¾å¤§é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="cover-preview-modal" id="coverPreviewModal" onclick="closeCoverPreview()">
        <button class="close-btn" onclick="closeCoverPreview()">&times;</button>
        <img id="coverPreviewImg" src="" alt="å°é¢é¢„è§ˆ">
    </div>
    
    <!-- æ–‡ä»¶æµè§ˆå™¨æ¨¡æ€æ¡† -->
    <div class="modal" id="fileBrowserModal">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3>ğŸ“ é€‰æ‹©è§†é¢‘æ–‡ä»¶</h3>
                <button class="close-btn" onclick="closeFileBrowser()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px">
                    <button class="btn btn-outline" onclick="browseParent()" id="btnParent">â¬†ï¸ ä¸Šçº§</button>
                    <div id="currentPath" style="flex:1;color:#888;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
                    <span id="selectedCount" style="color:#00d4ff;font-size:13px"></span>
                </div>
                <div id="fileList" style="max-height:350px;overflow-y:auto"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeFileBrowser()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="btnConfirmSelect" onclick="confirmFileSelection()" style="display:none">âœ“ æ·»åŠ é€‰ä¸­æ–‡ä»¶</button>
            </div>
        </div>
    </div>
    
    <!-- éšè—çš„å°é¢ä¸Šä¼ input -->
    <input type="file" id="customCoverInput" accept="image/*" hidden onchange="handleCustomCover(event)">

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
let currentTaskId = null, selectedCover = 1, selectedTags = [];
let videoCategories = [], shortCategories = [], darkwebCategories = [], allTags = [], darkwebTags = [];
let currentIsShort = false, currentIsDarkweb = false;
let pendingItems = [], pendingFilter = 'all', selectedPendingIds = [];
let pendingPage = 1, pendingPageSize = 10;
let publishingTasks = {}; // è®°å½•æ­£åœ¨å‘å¸ƒçš„ä»»åŠ¡çŠ¶æ€: { taskId: 'publishing' | 'success' | 'failed' }
const titles = { upload: 'ä¸Šä¼ è§†é¢‘', queue: 'è½¬ç é˜Ÿåˆ—', pending: 'å¾…å‘å¸ƒ', history: 'å‘å¸ƒå†å²' };

document.addEventListener('DOMContentLoaded', () => {
    loadSystemInfo(); loadCategories(); loadTags(); loadQueue(); loadPending(); loadHistory();
    setInterval(() => { loadSystemInfo(); loadQueue(); loadPending(); }, 8000);
    document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = () => {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            item.classList.add('active');
            document.getElementById('page-' + item.dataset.page).classList.add('active');
            document.getElementById('pageTitle').textContent = titles[item.dataset.page];
        };
    });
    // æµè§ˆå™¨ä¸Šä¼ äº‹ä»¶ç»‘å®š
    document.getElementById('browserFileInput').onchange = e => {
        const type = document.getElementById('browserUploadType').value;
        handleFiles(e.target.files, type);
    };
});

async function loadSystemInfo() {
    try {
        const r = await fetch('/api/system'), d = await r.json();
        const el = document.getElementById('diskInfo');
        el.textContent = d.disk_free_gb + ' GB å¯ç”¨';
        el.className = 'disk' + (d.disk_critical ? ' critical' : d.disk_warning ? ' warning' : '');
    } catch(e) {}
}

async function loadCategories() {
    try {
        const r = await fetch('/api/categories'), d = await r.json();
        videoCategories = d.video_categories || [];
        shortCategories = d.short_categories || [];
        darkwebCategories = d.darkweb_categories || [];
    } catch(e) { console.error('Failed to load categories:', e); }
}

let selectedCategoryId = null;

function renderCategories(isShort, isDarkweb) {
    const dropdown = document.getElementById('categoryDropdown');
    let html = '';
    
    if (isDarkweb) {
        // æš—ç½‘åˆ†ç±»
        darkwebCategories.forEach((parent, idx) => {
            if (parent.children && parent.children.length > 0) {
                html += '<div class="category-group">';
                html += '<div class="category-parent" onclick="toggleCategoryGroup(' + idx + ')">';
                html += '<span>' + parent.name + ' (' + parent.children.length + ')</span>';
                html += '<span class="arrow">â–¶</span>';
                html += '</div>';
                html += '<div class="category-children" id="catGroup' + idx + '">';
                parent.children.forEach(child => {
                    html += '<div class="category-child" data-id="' + child.id + '" onclick="selectCategory(' + child.id + ', \'' + child.name.replace(/'/g, "\\'") + '\')">' + child.name + '</div>';
                });
                html += '</div></div>';
            } else {
                html += '<div class="category-flat" data-id="' + parent.id + '" onclick="selectCategory(' + parent.id + ', \'' + parent.name.replace(/'/g, "\\'") + '\')">' + parent.name + '</div>';
            }
        });
    } else if (isShort) {
        // çŸ­è§†é¢‘åˆ†ç±»æ˜¯æ‰å¹³åˆ—è¡¨
        shortCategories.forEach(cat => {
            html += '<div class="category-flat" data-id="' + cat.id + '" onclick="selectCategory(' + cat.id + ', \'' + cat.name.replace(/'/g, "\\'") + '\')">' + cat.name + '</div>';
        });
    } else {
        // é•¿è§†é¢‘åˆ†ç±»æ˜¯æ ‘å½¢ç»“æ„ï¼Œå¯æŠ˜å 
        videoCategories.forEach((parent, idx) => {
            if (parent.children && parent.children.length > 0) {
                html += '<div class="category-group">';
                html += '<div class="category-parent" onclick="toggleCategoryGroup(' + idx + ')">';
                html += '<span>' + parent.name + ' (' + parent.children.length + ')</span>';
                html += '<span class="arrow">â–¶</span>';
                html += '</div>';
                html += '<div class="category-children" id="catGroup' + idx + '">';
                parent.children.forEach(child => {
                    html += '<div class="category-child" data-id="' + child.id + '" onclick="selectCategory(' + child.id + ', \'' + child.name.replace(/'/g, "\\'") + '\')">' + child.name + '</div>';
                });
                html += '</div></div>';
            } else {
                html += '<div class="category-flat" data-id="' + parent.id + '" onclick="selectCategory(' + parent.id + ', \'' + parent.name.replace(/'/g, "\\'") + '\')">' + parent.name + '</div>';
            }
        });
    }
    
    dropdown.innerHTML = html;
    document.getElementById('editCategory').value = '';
    document.getElementById('selectedCategoryText').textContent = 'é€‰æ‹©åˆ†ç±»';
    selectedCategoryId = null;
}

function toggleCategoryDropdown() {
    document.getElementById('categoryDropdown').classList.toggle('show');
}

function toggleCategoryGroup(idx) {
    const group = document.getElementById('catGroup' + idx);
    const parent = group.previousElementSibling;
    group.classList.toggle('show');
    parent.classList.toggle('expanded');
    event.stopPropagation();
}

function selectCategory(id, name) {
    selectedCategoryId = id;
    document.getElementById('editCategory').value = id;
    document.getElementById('selectedCategoryText').textContent = name;
    document.getElementById('categoryDropdown').classList.remove('show');
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.category-child, .category-flat').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.id) === id);
    });
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰
document.addEventListener('click', function(e) {
    if (!e.target.closest('.category-selector')) {
        document.getElementById('categoryDropdown')?.classList.remove('show');
    }
});

async function loadTags() {
    try {
        const r = await fetch('/api/tags'), d = await r.json();
        allTags = d.tags || [];
        darkwebTags = d.darkweb_tags || [];
    } catch(e) { console.error('Failed to load tags:', e); }
}

function renderTags(isShort, isDarkweb) {
    const tags = isDarkweb ? darkwebTags : allTags;
    const container = document.getElementById('tagsContainer');
    if (tags.length === 0) {
        container.innerHTML = '<span style="color:#666;font-size:12px">æš‚æ— æ ‡ç­¾</span>';
        return;
    }
    container.innerHTML = tags.map(t => 
        '<span class="tag-item ' + (selectedTags.includes(t.id) ? 'selected' : '') + '" data-id="' + t.id + '">' + t.name + '</span>'
    ).join('');
    container.querySelectorAll('.tag-item').forEach(el => {
        el.onclick = () => {
            const id = parseInt(el.dataset.id);
            if (selectedTags.includes(id)) {
                selectedTags = selectedTags.filter(x => x !== id);
                el.classList.remove('selected');
            } else {
                selectedTags.push(id);
                el.classList.add('selected');
            }
        };
    });
}

async function handleFiles(files, videoType) {
    if (!files.length) return;
    const formData = new FormData();
    for (let f of files) formData.append('video', f);
    formData.append('video_type', videoType);
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadStatus').textContent = 'ä¸Šä¼ ä¸­...';
    try {
        const r = await fetch('/api/upload', { method: 'POST', body: formData });
        const d = await r.json();
        if (d.tasks && d.tasks.length > 0) {
            // ä¸Šä¼ æˆåŠŸï¼Œéšè—è¿›åº¦æ¡ï¼Œåˆ‡æ¢åˆ°è½¬ç é˜Ÿåˆ—é¡µé¢
            document.getElementById('uploadProgress').style.display = 'none';
            document.querySelector('#uploadProgress .progress-bar').style.width = '0%';
            
            // åˆ‡æ¢åˆ°è½¬ç é˜Ÿåˆ—é¡µé¢
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('.nav-item[data-page="queue"]').classList.add('active');
            document.getElementById('page-queue').classList.add('active');
            document.getElementById('pageTitle').textContent = 'è½¬ç é˜Ÿåˆ—';
            
            // åˆ·æ–°é˜Ÿåˆ—å¹¶å¼€å§‹è½®è¯¢
            loadQueue();
            for (let t of d.tasks) pollTranscodeStatus(t.task_id);
        }
    } catch(e) { alert('ä¸Šä¼ å¤±è´¥'); document.getElementById('uploadProgress').style.display = 'none'; }
}

// è®°å½•æ‰¹é‡æ·»åŠ çš„ä»»åŠ¡æ•°é‡
let batchAddCount = 0;
let batchCompletedCount = 0;

// è½®è¯¢è½¬ç çŠ¶æ€ï¼ˆåœ¨è½¬ç é˜Ÿåˆ—é¡µé¢æ˜¾ç¤ºè¿›åº¦ï¼‰
async function pollTranscodeStatus(taskId) {
    try {
        const r = await fetch('/api/status/' + taskId);
        if (r.status === 404) { setTimeout(() => pollTranscodeStatus(taskId), 1000); return; }
        const d = await r.json();
        
        // åˆ·æ–°é˜Ÿåˆ—åˆ—è¡¨æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
        loadQueue();
        
        if (d.status === 'ready') {
            // è½¬ç å®Œæˆï¼Œåˆ·æ–°å¾…å‘å¸ƒåˆ—è¡¨
            loadPending();
            batchCompletedCount++;
            
            // å¦‚æœæ˜¯æ‰¹é‡æ·»åŠ ï¼Œç­‰æ‰€æœ‰ä»»åŠ¡å®Œæˆååˆ‡æ¢åˆ°å¾…å‘å¸ƒé¡µé¢
            if (batchAddCount > 1) {
                if (batchCompletedCount >= batchAddCount) {
                    // æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œåˆ‡æ¢åˆ°å¾…å‘å¸ƒé¡µé¢
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.querySelector('.nav-item[data-page="pending"]').classList.add('active');
                    document.getElementById('page-pending').classList.add('active');
                    document.getElementById('pageTitle').textContent = 'å¾…å‘å¸ƒ';
                    batchAddCount = 0;
                    batchCompletedCount = 0;
                }
            } else {
                // å•ä¸ªä»»åŠ¡ï¼Œå¼¹å‡ºç¼–è¾‘çª—å£
                showEditModal(taskId, d);
            }
        } else if (d.error) {
            // è½¬ç å¤±è´¥
            loadQueue();
            batchCompletedCount++;
        } else {
            // ç»§ç»­è½®è¯¢
            setTimeout(() => pollTranscodeStatus(taskId), 2000);
        }
    } catch(e) { setTimeout(() => pollTranscodeStatus(taskId), 2000); }
}

// æ—§çš„pollStatusä¿ç•™ç”¨äºå…¼å®¹
async function pollStatus(taskId) {
    try {
        const r = await fetch('/api/status/' + taskId);
        if (r.status === 404) { setTimeout(() => pollStatus(taskId), 1000); return; }
        const d = await r.json();
        const bar = document.querySelector('#uploadProgress .progress-bar');
        const status = document.getElementById('uploadStatus');
        if (d.status === 'uploading') {
            bar.style.width = '5%';
            status.textContent = 'å‡†å¤‡è½¬ç ...';
            setTimeout(() => pollStatus(taskId), 1000);
        } else if (d.status === 'processing' || d.status === 'transcoding') {
            bar.style.width = Math.max(10, d.progress) + '%';
            status.textContent = 'è½¬ç ä¸­ ' + Math.round(d.progress) + '%';
            setTimeout(() => pollStatus(taskId), 1000);
        } else if (d.status === 'generating_covers') {
            bar.style.width = '95%';
            status.textContent = 'ç”Ÿæˆå°é¢...';
            setTimeout(() => pollStatus(taskId), 1000);
        } else if (d.status === 'ready') {
            document.getElementById('uploadProgress').style.display = 'none';
            bar.style.width = '0%';
            loadPending();
            showEditModal(taskId, d);
        } else if (d.error) {
            status.textContent = 'å¤±è´¥: ' + d.error;
        } else {
            setTimeout(() => pollStatus(taskId), 1000);
        }
    } catch(e) { setTimeout(() => pollStatus(taskId), 2000); }
}

function showEditModal(taskId, data) {
    currentTaskId = taskId;
    selectedCover = data.best_cover || 1;
    selectedTags = [];
    currentIsShort = data.is_short || false;
    currentIsDarkweb = data.is_darkweb || false;
    customCoverUrl = null; // é‡ç½®è‡ªå®šä¹‰å°é¢
    document.getElementById('editTitle').value = data.name || '';
    document.getElementById('editDescription').value = '';
    document.getElementById('editFeatured').checked = false;
    const video = document.getElementById('previewVideo');
    if (data.video_preview_url && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(data.video_preview_url);
        hls.attachMedia(video);
    }
    // æ¸²æŸ“å°é¢ç½‘æ ¼ï¼ˆåŒ…å«ä¸Šä¼ æŒ‰é’®ï¼‰
    renderCoversGrid(data.covers || []);
    // æ›´æ–°è§†é¢‘ç±»å‹æŒ‰é’®çŠ¶æ€
    updateVideoTypeButtons();
    // æ ¹æ®è§†é¢‘ç±»å‹æ¸²æŸ“åˆ†ç±»å’Œæ ‡ç­¾
    renderCategories(currentIsShort, currentIsDarkweb);
    renderTags(currentIsShort, currentIsDarkweb);
    document.getElementById('editModal').classList.add('show');
}

function updateVideoTypeButtons() {
    document.getElementById('typeBtn-long').classList.toggle('active', !currentIsShort && !currentIsDarkweb);
    document.getElementById('typeBtn-short').classList.toggle('active', currentIsShort && !currentIsDarkweb);
    document.getElementById('typeBtn-darkweb').classList.toggle('active', currentIsDarkweb);
}

async function switchVideoType(type) {
    const oldIsShort = currentIsShort;
    const oldIsDarkweb = currentIsDarkweb;
    
    currentIsShort = type === 'short';
    currentIsDarkweb = type === 'darkweb';
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    updateVideoTypeButtons();
    
    // é‡æ–°æ¸²æŸ“åˆ†ç±»å’Œæ ‡ç­¾
    renderCategories(currentIsShort, currentIsDarkweb);
    renderTags(currentIsShort, currentIsDarkweb);
    
    // è°ƒç”¨APIæ›´æ–°æœåŠ¡å™¨ç«¯çš„ç±»å‹
    try {
        await fetch('/api/set-type/' + currentTaskId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_type: type })
        });
    } catch(e) {
        console.error('Failed to update video type:', e);
    }
}

let customCoverUrl = null; // è‡ªå®šä¹‰å°é¢URL
let currentCovers = []; // å½“å‰å°é¢åˆ—è¡¨

function renderCoversGrid(covers) {
    currentCovers = covers;
    let html = '';
    
    // ä¸Šä¼ è‡ªå®šä¹‰å°é¢æŒ‰é’®
    html += '<div class="cover-upload-item" onclick="document.getElementById(\'customCoverInput\').click()">' +
        '<span class="icon">ğŸ“¤</span>' +
        '<span class="text">ä¸Šä¼ å°é¢</span>' +
        '</div>';
    
    // è‡ªå®šä¹‰å°é¢ï¼ˆå¦‚æœæœ‰ï¼‰
    if (customCoverUrl) {
        html += '<div class="cover-item selected" data-idx="custom">' +
            '<img src="' + customCoverUrl + '" onclick="selectCover(\'custom\')">' +
            '<span class="zoom-icon" onclick="event.stopPropagation();previewCover(\'' + customCoverUrl + '\')">ğŸ”</span>' +
            '</div>';
    }
    
    // ç³»ç»Ÿç”Ÿæˆçš„å°é¢
    covers.forEach(c => {
        const isSelected = !customCoverUrl && c.index === selectedCover;
        html += '<div class="cover-item ' + (isSelected ? 'selected' : '') + '" data-idx="' + c.index + '">' +
            '<img src="' + c.url + '" onclick="selectCover(' + c.index + ')">' +
            '<span class="zoom-icon" onclick="event.stopPropagation();previewCover(\'' + c.url + '\')">ğŸ”</span>' +
            '</div>';
    });
    
    document.getElementById('coversGrid').innerHTML = html;
}

function selectCover(idx) {
    if (idx === 'custom') {
        selectedCover = 'custom';
    } else {
        selectedCover = idx;
        customCoverUrl = null; // é€‰æ‹©ç³»ç»Ÿå°é¢æ—¶æ¸…é™¤è‡ªå®šä¹‰å°é¢é€‰ä¸­çŠ¶æ€
    }
    renderCoversGrid(currentCovers);
}

function previewCover(url) {
    document.getElementById('coverPreviewImg').src = url;
    document.getElementById('coverPreviewModal').classList.add('show');
}

function closeCoverPreview() {
    document.getElementById('coverPreviewModal').classList.remove('show');
}

async function handleCustomCover(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // ä¸Šä¼ å°é¢
    const formData = new FormData();
    formData.append('cover', file);
    formData.append('task_id', currentTaskId);
    
    try {
        const r = await fetch('/api/upload-cover', { method: 'POST', body: formData });
        const d = await r.json();
        if (d.success && d.url) {
            customCoverUrl = d.url;
            selectedCover = 'custom';
            renderCoversGrid(currentCovers);
        } else {
            alert(d.error || 'ä¸Šä¼ å¤±è´¥');
        }
    } catch(e) {
        alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
    }
    
    // æ¸…ç©ºinputä»¥ä¾¿é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
    event.target.value = '';
}

function closeModal() { document.getElementById('editModal').classList.remove('show'); }

async function publishVideo() {
    if (!currentTaskId) return;
    
    const taskId = currentTaskId;
    const publishData = {
        task_id: taskId,
        title: document.getElementById('editTitle').value,
        description: document.getElementById('editDescription').value,
        category_id: document.getElementById('editCategory').value || null,
        tag_ids: selectedTags.length ? selectedTags : null,
        selected_cover: selectedCover === 'custom' ? 1 : selectedCover,
        custom_cover_url: customCoverUrl, // è‡ªå®šä¹‰å°é¢URL
        coin_price: parseInt(document.getElementById('editCoin').value) || 0,
        free_preview_seconds: parseInt(document.getElementById('editPreview').value) || 15,
        is_vip_only: document.getElementById('editVipOnly').checked,
        is_featured: document.getElementById('editFeatured').checked,
        is_darkweb: currentIsDarkweb
    };
    
    // ç«‹å³å…³é—­å¼¹çª—ï¼Œè®¾ç½®ä¸ºå‘å¸ƒä¸­çŠ¶æ€
    closeModal();
    publishingTasks[taskId] = 'publishing';
    renderPendingList();
    
    // é€‰æ‹©å‘å¸ƒAPI
    const publishUrl = currentIsDarkweb ? '/api/publish-darkweb' : '/api/publish';
    
    // åå°å¼‚æ­¥å‘å¸ƒ
    try {
        const r = await fetch(publishUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(publishData)
        });
        const d = await r.json();
        if (d.success) {
            publishingTasks[taskId] = 'success';
            // ç«‹å³åˆ·æ–°å†å²åˆ—è¡¨
            loadHistory();
            // 2ç§’åä»å¾…å‘å¸ƒåˆ—è¡¨ç§»é™¤
            setTimeout(() => {
                delete publishingTasks[taskId];
                loadPending();
            }, 2000);
        } else {
            publishingTasks[taskId] = 'failed';
            publishingTasks[taskId + '_error'] = d.error || 'å‘å¸ƒå¤±è´¥';
            publishingTasks[taskId + '_data'] = publishData; // ä¿å­˜æ•°æ®ç”¨äºé‡è¯•
        }
        renderPendingList();
    } catch(e) {
        publishingTasks[taskId] = 'failed';
        publishingTasks[taskId + '_error'] = 'ç½‘ç»œé”™è¯¯';
        publishingTasks[taskId + '_data'] = publishData;
        renderPendingList();
    }
}

async function retryPublish(taskId) {
    const publishData = publishingTasks[taskId + '_data'];
    if (!publishData) {
        alert('æ— æ³•é‡è¯•ï¼Œè¯·é‡æ–°ç¼–è¾‘å‘å¸ƒ');
        return;
    }
    
    // é‡ç½®ä¸ºå‘å¸ƒä¸­çŠ¶æ€
    publishingTasks[taskId] = 'publishing';
    delete publishingTasks[taskId + '_error'];
    renderPendingList();
    
    try {
        const r = await fetch('/api/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(publishData)
        });
        const d = await r.json();
        if (d.success) {
            publishingTasks[taskId] = 'success';
            // ç«‹å³åˆ·æ–°å†å²åˆ—è¡¨
            loadHistory();
            setTimeout(() => {
                delete publishingTasks[taskId];
                delete publishingTasks[taskId + '_data'];
                loadPending();
            }, 2000);
        } else {
            publishingTasks[taskId] = 'failed';
            publishingTasks[taskId + '_error'] = d.error || 'å‘å¸ƒå¤±è´¥';
        }
        renderPendingList();
    } catch(e) {
        publishingTasks[taskId] = 'failed';
        publishingTasks[taskId + '_error'] = 'ç½‘ç»œé”™è¯¯';
        renderPendingList();
    }
}

async function loadQueue() {
    try {
        const r = await fetch('/api/queue'), d = await r.json();
        const tasks = Array.isArray(d) ? d : (d.tasks || []);
        document.getElementById('queueBadge').textContent = tasks.length;
        document.getElementById('queueBadge').style.display = tasks.length ? '' : 'none';
        document.getElementById('queueList').innerHTML = tasks.length ? tasks.map(t => {
            let statusText = 'ç­‰å¾…ä¸­', statusClass = 'status-pending';
            if (t.status === 'uploading') {
                statusText = 'ä¸Šä¼ ä¸­...';
                statusClass = 'status-pending';
            } else if (t.status === 'processing' || t.status === 'transcoding') {
                statusText = 'è½¬ç ä¸­ ' + Math.round(t.progress || 0) + '%';
                statusClass = 'status-processing';
            } else if (t.status === 'generating_covers') {
                statusText = 'ç”Ÿæˆå°é¢...';
                statusClass = 'status-processing';
            }
            return '<div class="list-item"><div class="info"><div class="title">' + (t.filename || '') + '</div>' +
                '<div class="progress"><div class="progress-bar" style="width:' + (t.progress || 0) + '%"></div></div>' +
                '</div><span class="status ' + statusClass + '">' + statusText + '</span></div>';
        }).join('') : '<div class="empty"><div class="icon">ğŸ“­</div><div>é˜Ÿåˆ—ä¸ºç©º</div></div>';
    } catch(e) {}
}

async function loadPending() {
    try {
        const r = await fetch('/api/pending'), d = await r.json();
        pendingItems = Array.isArray(d) ? d : (d.items || []);
        const longCount = pendingItems.filter(t => !t.is_short && !t.is_darkweb).length;
        const shortCount = pendingItems.filter(t => t.is_short && !t.is_darkweb).length;
        const darkwebCount = pendingItems.filter(t => t.is_darkweb).length;
        document.getElementById('pendingBadge').textContent = pendingItems.length;
        document.getElementById('pendingBadge').style.display = pendingItems.length ? '' : 'none';
        document.getElementById('pendingAllCount').textContent = pendingItems.length;
        document.getElementById('pendingLongCount').textContent = longCount;
        document.getElementById('pendingShortCount').textContent = shortCount;
        document.getElementById('pendingDarkwebCount').textContent = darkwebCount;
        renderPendingList();
    } catch(e) {}
}

function switchPendingTab(type) {
    pendingFilter = type;
    pendingPage = 1;
    selectedPendingIds = [];
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));
    renderPendingList();
}

function getFilteredItems() {
    let items = pendingItems;
    if (pendingFilter === 'long') items = pendingItems.filter(t => !t.is_short && !t.is_darkweb);
    else if (pendingFilter === 'short') items = pendingItems.filter(t => t.is_short && !t.is_darkweb);
    else if (pendingFilter === 'darkweb') items = pendingItems.filter(t => t.is_darkweb);
    const search = document.getElementById('pendingSearch').value.trim().toLowerCase();
    if (search) items = items.filter(t => (t.filename || '').toLowerCase().includes(search));
    return items;
}

function renderPendingList() {
    const items = getFilteredItems();
    const totalPages = Math.ceil(items.length / pendingPageSize) || 1;
    if (pendingPage > totalPages) pendingPage = totalPages;
    const start = (pendingPage - 1) * pendingPageSize;
    const pageItems = items.slice(start, start + pendingPageSize);
    
    document.getElementById('pendingList').innerHTML = pageItems.length ? pageItems.map(t => {
        const pubStatus = publishingTasks[t.task_id];
        let statusHtml = '';
        let actionsHtml = '';
        
        if (pubStatus === 'publishing') {
            statusHtml = '<span class="status status-processing">ğŸš€ å‘å¸ƒä¸­...</span>';
            actionsHtml = ''; // å‘å¸ƒä¸­ä¸æ˜¾ç¤ºæŒ‰é’®
        } else if (pubStatus === 'success') {
            statusHtml = '<span class="status status-completed">âœ… å‘å¸ƒæˆåŠŸ</span>';
            actionsHtml = '';
        } else if (pubStatus === 'failed') {
            const errMsg = publishingTasks[t.task_id + '_error'] || 'å‘å¸ƒå¤±è´¥';
            statusHtml = '<span class="status status-failed" style="background:rgba(255,71,87,0.2);color:#ff4757">âŒ ' + errMsg + '</span>';
            actionsHtml = '<div class="actions">' +
                '<button class="btn btn-primary" onclick="retryPublish(\'' + t.task_id + '\')">ğŸ”„ é‡è¯•</button>' +
                '<button class="btn btn-outline" onclick="editTask(\'' + t.task_id + '\')">ç¼–è¾‘</button>' +
                '<button class="btn btn-danger" onclick="deleteTask(\'' + t.task_id + '\')">åˆ é™¤</button>' +
                '</div>';
        } else {
            actionsHtml = '<div class="actions">' +
                '<button class="btn btn-primary" onclick="editTask(\'' + t.task_id + '\')">ç¼–è¾‘å‘å¸ƒ</button>' +
                '<button class="btn btn-danger" onclick="deleteTask(\'' + t.task_id + '\')">åˆ é™¤</button>' +
                '</div>';
        }
        
        return '<div class="list-item">' +
            '<input type="checkbox" class="item-checkbox" data-id="' + t.task_id + '" ' + (selectedPendingIds.includes(t.task_id) ? 'checked' : '') + ' onchange="toggleSelectItem(\'' + t.task_id + '\')">' +
            (t.covers?.[0]?.url ? '<img src="' + t.covers[0].url + '" class="thumb">' : '<div class="thumb"></div>') +
            '<div class="info"><div class="title">' + (t.filename || '') + '</div><div class="meta">' + 
            (t.duration ? Math.round(t.duration) + 'ç§’' : '') + ' Â· ' + (t.is_darkweb ? 'ğŸ” æš—ç½‘' : t.is_short ? 'ğŸ“± çŸ­è§†é¢‘' : 'ğŸ“º é•¿è§†é¢‘') + '</div></div>' +
            statusHtml +
            actionsHtml +
            '</div>';
    }).join('') : '<div class="empty"><div class="icon">ğŸ“</div><div>æš‚æ— ' + (pendingFilter === 'all' ? 'å¾…å‘å¸ƒ' : pendingFilter === 'long' ? 'é•¿è§†é¢‘' : 'çŸ­è§†é¢‘') + '</div></div>';
    
    renderPagination(items.length, totalPages);
    updateSelectedCount();
}

function renderPagination(total, totalPages) {
    const pag = document.getElementById('pendingPagination');
    if (totalPages <= 1) { pag.style.display = 'none'; return; }
    pag.style.display = 'flex';
    let html = '<button class="page-btn" onclick="goPage(' + (pendingPage - 1) + ')" ' + (pendingPage <= 1 ? 'disabled' : '') + '>ä¸Šä¸€é¡µ</button>';
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= pendingPage - 2 && i <= pendingPage + 2)) {
            html += '<button class="page-btn ' + (i === pendingPage ? 'active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
        } else if (i === pendingPage - 3 || i === pendingPage + 3) {
            html += '<span class="page-info">...</span>';
        }
    }
    html += '<button class="page-btn" onclick="goPage(' + (pendingPage + 1) + ')" ' + (pendingPage >= totalPages ? 'disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';
    html += '<span class="page-info">å…± ' + total + ' æ¡</span>';
    pag.innerHTML = html;
}

function goPage(p) { pendingPage = p; renderPendingList(); }

function toggleSelectAll() {
    const checked = document.getElementById('selectAllPending').checked;
    const items = getFilteredItems();
    const start = (pendingPage - 1) * pendingPageSize;
    const pageItems = items.slice(start, start + pendingPageSize);
    if (checked) {
        pageItems.forEach(t => { if (!selectedPendingIds.includes(t.task_id)) selectedPendingIds.push(t.task_id); });
    } else {
        pageItems.forEach(t => { selectedPendingIds = selectedPendingIds.filter(id => id !== t.task_id); });
    }
    renderPendingList();
}

function toggleSelectItem(taskId) {
    if (selectedPendingIds.includes(taskId)) {
        selectedPendingIds = selectedPendingIds.filter(id => id !== taskId);
    } else {
        selectedPendingIds.push(taskId);
    }
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = selectedPendingIds.length;
    document.getElementById('selectedCount').textContent = count ? 'å·²é€‰ ' + count + ' é¡¹' : '';
    document.getElementById('batchPublishBtn').style.display = count ? '' : 'none';
    document.getElementById('batchDeleteBtn').style.display = count ? '' : 'none';
    const items = getFilteredItems();
    const start = (pendingPage - 1) * pendingPageSize;
    const pageItems = items.slice(start, start + pendingPageSize);
    const allSelected = pageItems.length > 0 && pageItems.every(t => selectedPendingIds.includes(t.task_id));
    document.getElementById('selectAllPending').checked = allSelected;
}

async function deleteTask(taskId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
    try {
        const r = await fetch('/api/delete/' + taskId, { method: 'DELETE' });
        const d = await r.json();
        if (d.success) {
            selectedPendingIds = selectedPendingIds.filter(id => id !== taskId);
            loadPending();
        } else {
            alert(d.error || 'åˆ é™¤å¤±è´¥');
        }
    } catch(e) { alert('åˆ é™¤å¤±è´¥'); }
}

async function batchDelete() {
    if (!selectedPendingIds.length) return;
    if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + selectedPendingIds.length + ' ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
    try {
        const r = await fetch('/api/delete-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_ids: selectedPendingIds })
        });
        const d = await r.json();
        if (d.success) {
            alert('æˆåŠŸåˆ é™¤ ' + d.deleted.length + ' ä¸ªè§†é¢‘');
            selectedPendingIds = [];
            loadPending();
        } else {
            alert('åˆ é™¤å¤±è´¥');
        }
    } catch(e) { alert('åˆ é™¤å¤±è´¥'); }
}

async function deleteAllPending() {
    if (!pendingItems.length) {
        alert('æ²¡æœ‰å¾…å‘å¸ƒçš„è§†é¢‘');
        return;
    }
    if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤å…¨éƒ¨ ' + pendingItems.length + ' ä¸ªå¾…å‘å¸ƒè§†é¢‘å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    try {
        const allIds = pendingItems.map(t => t.task_id);
        const r = await fetch('/api/delete-batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_ids: allIds })
        });
        const d = await r.json();
        if (d.success) {
            alert('æˆåŠŸåˆ é™¤ ' + d.deleted_count + ' ä¸ªè§†é¢‘');
            selectedPendingIds = [];
            loadPending();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch(e) { alert('åˆ é™¤å¤±è´¥: ' + e.message); }
}

async function batchPublish() {
    if (!selectedPendingIds.length) return;
    alert('æ‰¹é‡å‘å¸ƒåŠŸèƒ½ï¼šå°†ä¾æ¬¡æ‰“å¼€ç¼–è¾‘çª—å£å‘å¸ƒ ' + selectedPendingIds.length + ' ä¸ªè§†é¢‘');
    for (const taskId of selectedPendingIds) {
        try {
            const r = await fetch('/api/status/' + taskId), d = await r.json();
            if (d.status === 'ready' || d.status === 'scheduled') {
                showEditModal(taskId, d);
                break;
            }
        } catch(e) {}
    }
}

async function editTask(taskId) {
    try {
        const r = await fetch('/api/status/' + taskId), d = await r.json();
        if (d.status === 'ready' || d.status === 'scheduled') showEditModal(taskId, d);
    } catch(e) {}
}

async function loadHistory() {
    try {
        const r = await fetch('/api/history'), d = await r.json();
        const items = Array.isArray(d) ? d : (d.items || []);
        const stats = d.stats || { today: 0, this_week: 0, total: items.length };
        document.getElementById('historyStats').innerHTML = 
            '<div class="stat-card"><div class="value">' + (stats.today || 0) + '</div><div class="label">ä»Šæ—¥</div></div>' +
            '<div class="stat-card"><div class="value">' + (stats.this_week || 0) + '</div><div class="label">æœ¬å‘¨</div></div>' +
            '<div class="stat-card"><div class="value">' + (stats.total || items.length) + '</div><div class="label">æ€»è®¡</div></div>';
        document.getElementById('historyList').innerHTML = items.length ? items.map(h => 
            '<div class="list-item"><div class="info"><div class="title">' + (h.title || h.filename || '') + '</div>' +
            '<div class="meta">' + (h.published_at || '') + ' Â· ' + Math.round(h.duration || 0) + 'ç§’</div></div>' +
            '<span class="status status-completed">å·²å‘å¸ƒ</span></div>'
        ).join('') : '<div class="empty"><div class="icon">ğŸ“œ</div><div>æš‚æ— è®°å½•</div></div>';
    } catch(e) {}
}

// æ–‡ä»¶æµè§ˆå™¨ç›¸å…³å˜é‡å’Œå‡½æ•°
let fileBrowserTarget = 'long'; // å½“å‰æµè§ˆå™¨ç›®æ ‡ï¼šlong, short, darkweb
let currentBrowsePath = '';
let parentPath = '';
let selectedFiles = []; // å¤šé€‰çš„æ–‡ä»¶åˆ—è¡¨

function openFileBrowser(target) {
    fileBrowserTarget = target;
    selectedFiles = [];
    updateSelectedCount();
    document.getElementById('fileBrowserModal').classList.add('show');
    // ä»localStorageè¯»å–ä¸Šæ¬¡æµè§ˆçš„è·¯å¾„
    const lastPath = localStorage.getItem('lastBrowsePath_' + target) || '';
    browsePath(lastPath);
}

function closeFileBrowser() {
    document.getElementById('fileBrowserModal').classList.remove('show');
}

async function browsePath(path) {
    try {
        const r = await fetch('/api/browse?path=' + encodeURIComponent(path));
        const d = await r.json();
        if (d.error) { 
            // å¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼Œå›åˆ°æ ¹ç›®å½•
            if (path) {
                browsePath('');
            } else {
                alert(d.error);
            }
            return; 
        }
        
        currentBrowsePath = d.current;
        parentPath = d.parent;
        
        // ä¿å­˜å½“å‰è·¯å¾„åˆ°localStorage
        if (d.current) {
            localStorage.setItem('lastBrowsePath_' + fileBrowserTarget, d.current);
        }
        
        document.getElementById('currentPath').textContent = d.current || 'é€‰æ‹©é©±åŠ¨å™¨';
        document.getElementById('btnParent').style.display = d.parent !== undefined && d.current ? 'block' : 'none';
        
        let html = '';
        for (const item of d.items) {
            const icon = item.type === 'folder' ? 'ğŸ“' : item.type === 'drive' ? 'ğŸ’¾' : 'ğŸ¬';
            const sizeText = item.size ? formatSize(item.size) : '';
            const isSelected = selectedFiles.includes(item.path);
            
            if (item.type === 'video') {
                // è§†é¢‘æ–‡ä»¶æ˜¾ç¤ºå¤é€‰æ¡†
                html += '<div class="file-item ' + item.type + (isSelected ? ' selected' : '') + '" onclick="toggleFileSelect(\'' + item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\')">' +
                    '<input type="checkbox" class="checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation();toggleFileSelect(\'' + item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\')">' +
                    '<span class="icon">' + icon + '</span>' +
                    '<span class="name">' + item.name + '</span>' +
                    (sizeText ? '<span class="size">' + sizeText + '</span>' : '') +
                    '</div>';
            } else {
                // æ–‡ä»¶å¤¹å’Œé©±åŠ¨å™¨ç‚¹å‡»è¿›å…¥
                html += '<div class="file-item ' + item.type + '" onclick="selectFileItem(\'' + item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'") + '\', \'' + item.type + '\')">' +
                    '<span class="icon">' + icon + '</span>' +
                    '<span class="name">' + item.name + '</span>' +
                    '</div>';
            }
        }
        if (d.items.length === 0) {
            html = '<div style="text-align:center;padding:40px;color:#666">æ­¤ç›®å½•ä¸ºç©º</div>';
        }
        document.getElementById('fileList').innerHTML = html;
    } catch(e) { alert('æµè§ˆå¤±è´¥: ' + e.message); }
}

function browseParent() {
    if (parentPath !== undefined) {
        browsePath(parentPath);
    }
}

function selectFileItem(path, type) {
    if (type === 'folder' || type === 'drive') {
        browsePath(path);
    }
}

function toggleFileSelect(path) {
    const idx = selectedFiles.indexOf(path);
    if (idx >= 0) {
        selectedFiles.splice(idx, 1);
    } else {
        selectedFiles.push(path);
    }
    updateSelectedCount();
    // æ›´æ–°UI
    const items = document.querySelectorAll('.file-item.video');
    items.forEach(item => {
        const checkbox = item.querySelector('.checkbox');
        if (checkbox) {
            const itemPath = item.onclick.toString().match(/toggleFileSelect\('([^']+)'\)/)?.[1]?.replace(/\\\\/g, '\\');
            if (itemPath === path) {
                item.classList.toggle('selected', selectedFiles.includes(path));
                checkbox.checked = selectedFiles.includes(path);
            }
        }
    });
}

function updateSelectedCount() {
    const countEl = document.getElementById('selectedCount');
    const btnConfirm = document.getElementById('btnConfirmSelect');
    if (selectedFiles.length > 0) {
        countEl.textContent = 'å·²é€‰ ' + selectedFiles.length + ' ä¸ªæ–‡ä»¶';
        btnConfirm.style.display = 'block';
        btnConfirm.textContent = 'âœ“ æ·»åŠ  ' + selectedFiles.length + ' ä¸ªæ–‡ä»¶';
    } else {
        countEl.textContent = '';
        btnConfirm.style.display = 'none';
    }
}

async function confirmFileSelection() {
    if (selectedFiles.length === 0) return;
    
    closeFileBrowser();
    
    try {
        const r = await fetch('/api/add-local', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: selectedFiles, video_type: fileBrowserTarget })
        });
        const d = await r.json();
        
        if (d.error_count > 0) {
            alert('éƒ¨åˆ†æ–‡ä»¶æ·»åŠ å¤±è´¥:\n' + d.errors.map(e => e.path + ': ' + e.error).join('\n'));
        }
        
        if (d.count > 0) {
            // è®¾ç½®æ‰¹é‡æ·»åŠ è®¡æ•°
            batchAddCount = d.count;
            batchCompletedCount = 0;
            
            // æ˜¾ç¤ºæ·»åŠ æˆåŠŸæç¤º
            alert('å·²æ·»åŠ  ' + d.count + ' ä¸ªè§†é¢‘åˆ°è½¬ç é˜Ÿåˆ—');
            
            // åˆ‡æ¢åˆ°è½¬ç é˜Ÿåˆ—é¡µé¢
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('.nav-item[data-page="queue"]').classList.add('active');
            document.getElementById('page-queue').classList.add('active');
            document.getElementById('pageTitle').textContent = 'è½¬ç é˜Ÿåˆ—';
            
            // åˆ·æ–°é˜Ÿåˆ—å’Œå¾…å‘å¸ƒåˆ—è¡¨
            loadQueue();
            loadPending();
            
            // å¼€å§‹è½®è¯¢æ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€
            for (const task of d.tasks) {
                pollTranscodeStatus(task.task_id);
            }
        }
    } catch(e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
    
    selectedFiles = [];
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}

async function addLocalFile(videoType) {
    const inputId = videoType === 'short' ? 'shortLocalPath' : videoType === 'darkweb' ? 'darkwebLocalPath' : 'longLocalPath';
    const path = document.getElementById(inputId).value.trim();
    if (!path) { alert('è¯·è¾“å…¥æœ¬åœ°æ–‡ä»¶è·¯å¾„'); return; }
    try {
        const r = await fetch('/api/add-local', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path, video_type: videoType })
        });
        const d = await r.json();
        if (d.error) { alert(d.error); return; }
        document.getElementById(inputId).value = '';
        
        // åˆ‡æ¢åˆ°è½¬ç é˜Ÿåˆ—é¡µé¢
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelector('.nav-item[data-page="queue"]').classList.add('active');
        document.getElementById('page-queue').classList.add('active');
        document.getElementById('pageTitle').textContent = 'è½¬ç é˜Ÿåˆ—';
        
        // åˆ·æ–°é˜Ÿåˆ—å¹¶å¼€å§‹è½®è¯¢
        loadQueue();
        if (d.task_id) pollTranscodeStatus(d.task_id);
    } catch(e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
}
    </script>
</body>
</html>
