# è½¬ç æ¶æ„éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¶æ„æ¦‚è¿°

```
è½¬ç æœåŠ¡å™¨ (198.176.60.121)              ä¸»æœåŠ¡å™¨ (38.47.218.137)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸‹è½½/æ¥æ”¶è§†é¢‘            â”‚          â”‚                            â”‚
â”‚ 2. GPUè½¬ç                  â”‚          â”‚                            â”‚
â”‚ 3. ç”Ÿæˆå°é¢ (WebP)         â”‚ â”€â”€ä¸Šä¼ â”€â”€â†’ â”‚ â€¢ /uploads/videos/         â”‚
â”‚ 4. ç”Ÿæˆé¢„è§ˆ (10ç§’MP4)      â”‚          â”‚ â€¢ /uploads/thumbnails/     â”‚
â”‚ 5. ä¸Šä¼ å…¨éƒ¨æ–‡ä»¶            â”‚          â”‚ â€¢ /uploads/previews/       â”‚
â”‚ 6. æ¸…ç†æœ¬åœ°æ–‡ä»¶            â”‚          â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â†“
                                              ç”¨æˆ·è®¿é—®ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¸»æœåŠ¡å™¨é…ç½®

#### 1.1 åˆ›å»ºé¢„è§ˆç›®å½•

```bash
# SSH åˆ°ä¸»æœåŠ¡å™¨
ssh root@38.47.218.137

# åˆ›å»ºé¢„è§ˆç›®å½•
mkdir -p /www/wwwroot/video-app/backend/uploads/previews
chmod 755 /www/wwwroot/video-app/backend/uploads/previews
chown www-data:www-data /www/wwwroot/video-app/backend/uploads/previews
```

#### 1.2 æ›´æ–° Nginx é…ç½®

ç¼–è¾‘ `/etc/nginx/sites-available/default`ï¼Œæ·»åŠ é¢„è§ˆç›®å½•ï¼š

```nginx
# åœ¨ç°æœ‰é…ç½®ä¸­æ·»åŠ 
location /uploads/previews {
    alias /www/wwwroot/video-app/backend/uploads/previews;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

é‡æ–°åŠ è½½ Nginxï¼š
```bash
nginx -t && nginx -s reload
```

#### 1.3 æ›´æ–°åç«¯ä»£ç 

åç«¯å›è°ƒæ¥å£å·²æ›´æ–°ï¼Œæ”¯æŒæ¥æ”¶å°é¢å’Œé¢„è§ˆURLã€‚ç¡®ä¿ä»£ç å·²åŒæ­¥ï¼š

```bash
cd /www/wwwroot/video-app
git pull  # æˆ–æ‰‹åŠ¨æ›´æ–° backend/app/api/transcode_callback.py
```

é‡å¯åç«¯æœåŠ¡ï¼š
```bash
cd /www/wwwroot/video-app/backend
pkill -f "run.py"
python run.py &
```

---

### ç¬¬äºŒæ­¥ï¼šè½¬ç æœåŠ¡å™¨é…ç½®

#### 2.1 è¿æ¥åˆ°è½¬ç æœåŠ¡å™¨

```
è¿œç¨‹æ¡Œé¢è¿æ¥:
IP: 198.176.60.121
ç”¨æˆ·: Administrator
å¯†ç : jCkMIjNlnSd7f6GM
```

#### 2.2 åˆ›å»ºç›®å½•ç»“æ„

åœ¨è½¬ç æœåŠ¡å™¨ä¸Šæ‰“å¼€ PowerShellï¼Œæ‰§è¡Œï¼š

```powershell
# åˆ›å»ºç›®å½•
$dirs = @(
    "D:\VideoTranscode\downloads",
    "D:\VideoTranscode\processing",
    "D:\VideoTranscode\completed",
    "D:\VideoTranscode\logs",
    "D:\VideoTranscode\scripts"
)

foreach ($dir in $dirs) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force
        Write-Host "åˆ›å»ºç›®å½•: $dir" -ForegroundColor Green
    }
}
```

#### 2.3 éƒ¨ç½²è„šæœ¬æ–‡ä»¶

å°†ä»¥ä¸‹3ä¸ªè„šæœ¬æ–‡ä»¶å¤åˆ¶åˆ°è½¬ç æœåŠ¡å™¨ `D:\VideoTranscode\scripts\` ç›®å½•ï¼š

| æœ¬åœ°æ–‡ä»¶ | ç›®æ ‡ä½ç½® |
|---------|---------|
| `scripts/transcode_full.ps1` | `D:\VideoTranscode\scripts\transcode_full.ps1` |
| `scripts/upload_full.ps1` | `D:\VideoTranscode\scripts\upload_full.ps1` |
| `scripts/watcher_full.ps1` | `D:\VideoTranscode\scripts\watcher.ps1` |

**æ–¹æ³•1: é€šè¿‡è¿œç¨‹æ¡Œé¢å¤åˆ¶**
- ç›´æ¥æ‹–æ‹½æ–‡ä»¶åˆ°è¿œç¨‹æ¡Œé¢çª—å£

**æ–¹æ³•2: é€šè¿‡ PowerShell ä¸‹è½½**
```powershell
# å¦‚æœæ–‡ä»¶æ‰˜ç®¡åœ¨æŸå¤„ï¼Œå¯ä»¥ç”¨ Invoke-WebRequest ä¸‹è½½
```

#### 2.4 åˆ›å»º SSH å¯†é’¥

```powershell
$keyContent = @"
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACBE9vQLi1nGfWBVacAymJd/B6TeSVq6KeYxZBCd57L9gAAAAJDvzGZC78xm
QgAAAAtzc2gtZWQyNTUxOQAAACBE9vQLi1nGfWBVacAymJd/B6TeSVq6KeYxZBCd57L9gA
AAAECtAxcJq0SjnZjz4DYebdKR/2BX09k3EOCZniP9JI0SwkT29AuLWcZ9YFVpwDKYl38H
pN5JWrop5jFkEJ3nsv2AAAAADXJvb3RASEIxMzExMDM=
-----END OPENSSH PRIVATE KEY-----
"@

$keyContent | Out-File -FilePath "C:\server_key" -Encoding ASCII -NoNewline
Write-Host "SSH å¯†é’¥å·²åˆ›å»º: C:\server_key" -ForegroundColor Green
```

#### 2.5 æµ‹è¯• SSH è¿æ¥

```powershell
ssh -i C:\server_key -o StrictHostKeyChecking=no root@38.47.218.137 "echo è¿æ¥æˆåŠŸ"
```

---

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•éªŒè¯

#### 3.1 æµ‹è¯•è½¬ç è„šæœ¬

```powershell
# åˆ›å»ºæµ‹è¯•è§†é¢‘
ffmpeg -f lavfi -i testsrc=duration=30:size=1920x1080:rate=30 `
    -c:v libx264 -pix_fmt yuv420p `
    D:\VideoTranscode\downloads\test_video.mp4

# æ‰‹åŠ¨æµ‹è¯•è½¬ç 
powershell -ExecutionPolicy Bypass -File D:\VideoTranscode\scripts\transcode_full.ps1 `
    -InputFile D:\VideoTranscode\downloads\test_video.mp4 `
    -OutputDir D:\VideoTranscode\completed\test

# æ£€æŸ¥è¾“å‡º
Get-ChildItem D:\VideoTranscode\completed\test
```

é¢„æœŸè¾“å‡ºï¼š
- `test_video.mp4` (è½¬ç åè§†é¢‘)
- `test_video.webp` (å°é¢å›¾ç‰‡)
- `test_video_preview.mp4` (é¢„è§ˆè§†é¢‘)

#### 3.2 æµ‹è¯•ä¸Šä¼ è„šæœ¬

```powershell
powershell -ExecutionPolicy Bypass -File D:\VideoTranscode\scripts\upload_full.ps1 `
    -VideoFile D:\VideoTranscode\completed\test\test_video.mp4 `
    -CoverFile D:\VideoTranscode\completed\test\test_video.webp `
    -PreviewFile D:\VideoTranscode\completed\test\test_video_preview.mp4
```

#### 3.3 éªŒè¯ä¸»æœåŠ¡å™¨æ–‡ä»¶

```powershell
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/videos/ | tail -3"
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/thumbnails/ | tail -3"
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/previews/ | tail -3"
```

#### 3.4 å¯åŠ¨ç›‘æ§æœåŠ¡

```powershell
powershell -ExecutionPolicy Bypass -NoExit -File D:\VideoTranscode\scripts\watcher.ps1
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### è½¬ç æœåŠ¡å™¨æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| transcode_full.ps1 | D:\VideoTranscode\scripts\ | å®Œæ•´è½¬ç ï¼ˆè§†é¢‘+å°é¢+é¢„è§ˆï¼‰ |
| upload_full.ps1 | D:\VideoTranscode\scripts\ | ä¸Šä¼ åˆ°ä¸»æœåŠ¡å™¨ |
| watcher.ps1 | D:\VideoTranscode\scripts\ | ç›‘æ§æœåŠ¡ |
| server_key | C:\ | SSH å¯†é’¥ |

### ä¸»æœåŠ¡å™¨æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| transcode_callback.py | backend/app/api/ | å›è°ƒæ¥å£ |
| nginx.conf | /etc/nginx/ | é™æ€æ–‡ä»¶æœåŠ¡ |

### ç›®å½•ç»“æ„

**è½¬ç æœåŠ¡å™¨:**
```
D:\VideoTranscode\
â”œâ”€â”€ downloads\      # æ”¾å…¥å¾…å¤„ç†è§†é¢‘
â”œâ”€â”€ processing\     # å¤„ç†ä¸­
â”œâ”€â”€ completed\      # å¤„ç†å®Œæˆ
â”œâ”€â”€ logs\           # æ—¥å¿—
â””â”€â”€ scripts\        # è„šæœ¬
```

**ä¸»æœåŠ¡å™¨:**
```
/www/wwwroot/video-app/backend/uploads/
â”œâ”€â”€ videos/         # è½¬ç åè§†é¢‘
â”œâ”€â”€ thumbnails/     # å°é¢å›¾ç‰‡
â””â”€â”€ previews/       # é¢„è§ˆè§†é¢‘
```

---

## ğŸ”§ å¤„ç†æµç¨‹

```
1. è§†é¢‘æ”¾å…¥ D:\VideoTranscode\downloads\
        â†“
2. ç›‘æ§æœåŠ¡æ£€æµ‹åˆ°æ–°æ–‡ä»¶
        â†“
3. ç§»åŠ¨åˆ° processing\ ç›®å½•
        â†“
4. æ‰§è¡Œè½¬ç  (GPUåŠ é€Ÿ)
        â†“
5. ç”Ÿæˆå°é¢ (WebP, ~100KB)
        â†“
6. ç”Ÿæˆé¢„è§ˆ (10ç§’MP4, ~3MB)
        â†“
7. ä¸Šä¼ åˆ°ä¸»æœåŠ¡å™¨:
   - è§†é¢‘ â†’ /uploads/videos/
   - å°é¢ â†’ /uploads/thumbnails/
   - é¢„è§ˆ â†’ /uploads/previews/
        â†“
8. è°ƒç”¨å›è°ƒæ¥å£æ›´æ–°æ•°æ®åº“
        â†“
9. æ¸…ç†æœ¬åœ°æ–‡ä»¶
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | é¢„æœŸå€¼ |
|------|--------|
| è½¬ç é€Ÿåº¦ | 20-30x å®æ—¶ (GPU) |
| å°é¢ç”Ÿæˆ | < 3ç§’ |
| é¢„è§ˆç”Ÿæˆ | < 10ç§’ |
| ä¸Šä¼ é€Ÿåº¦ | 50+ MB/s |
| 1GBè§†é¢‘æ€»å¤„ç†æ—¶é—´ | 3-5åˆ†é’Ÿ |

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1: SSH è¿æ¥å¤±è´¥
```powershell
# æ£€æŸ¥å¯†é’¥æ–‡ä»¶
Get-Item C:\server_key

# æµ‹è¯•è¿æ¥
ssh -v -i C:\server_key root@38.47.218.137 "echo test"
```

### é—®é¢˜2: è½¬ç å¤±è´¥
```powershell
# æ£€æŸ¥ FFmpeg
ffmpeg -version

# æ£€æŸ¥ GPU
nvidia-smi

# æŸ¥çœ‹æ—¥å¿—
Get-Content D:\VideoTranscode\logs\transcode_*.log -Tail 50
```

### é—®é¢˜3: ä¸Šä¼ å¤±è´¥
```powershell
# æµ‹è¯•ç½‘ç»œ
ping 38.47.218.137

# æ£€æŸ¥æ—¥å¿—
Get-Content D:\VideoTranscode\logs\upload.log -Tail 20
```

### é—®é¢˜4: å›è°ƒå¤±è´¥
```powershell
# æµ‹è¯•å›è°ƒæ¥å£
Invoke-RestMethod -Uri "http://38.47.218.137:8000/api/v1/admin/transcode-status/1" -Method GET
```

---

## âœ… éªŒæ”¶æ¸…å•

### è½¬ç æœåŠ¡å™¨
- [ ] ç›®å½•ç»“æ„å·²åˆ›å»º
- [ ] è„šæœ¬æ–‡ä»¶å·²éƒ¨ç½²
- [ ] SSH å¯†é’¥å·²é…ç½®
- [ ] FFmpeg å¯ç”¨
- [ ] GPU åŠ é€Ÿå¯ç”¨

### ä¸»æœåŠ¡å™¨
- [ ] previews ç›®å½•å·²åˆ›å»º
- [ ] Nginx é…ç½®å·²æ›´æ–°
- [ ] å›è°ƒæ¥å£å·²æ›´æ–°
- [ ] åç«¯æœåŠ¡å·²é‡å¯

### åŠŸèƒ½æµ‹è¯•
- [ ] è½¬ç åŠŸèƒ½æ­£å¸¸
- [ ] å°é¢ç”Ÿæˆæ­£å¸¸
- [ ] é¢„è§ˆç”Ÿæˆæ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ æ­£å¸¸
- [ ] å›è°ƒé€šçŸ¥æ­£å¸¸
- [ ] å‰ç«¯æ˜¾ç¤ºæ­£å¸¸

---

**åˆ›å»ºæ—¶é—´**: 2026-01-16  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: å¾…éƒ¨ç½²
