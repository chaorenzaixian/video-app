# Windows 转码服务使用说明

## ✅ 配置完成状态

转码服务已通过 plink 远程配置完成！

### 已创建的文件

```
C:\VideoTranscode\
├── scripts\
│   ├── transcode.ps1      # 转码脚本
│   └── watcher.ps1         # 监控服务
├── downloads\              # 放入待转码视频
├── processing\             # 正在处理的视频
├── completed\              # 转码完成的视频
├── logs\                   # 日志文件
└── start.ps1               # 启动脚本
```

## 📋 下一步操作

### 1. 安装 FFmpeg（如果还没安装）

在服务器上执行：

```powershell
# 使用 Chocolatey 安装
choco install ffmpeg -y

# 或者手动下载
# 访问: https://www.gyan.dev/ffmpeg/builds/
# 下载 ffmpeg-release-essentials.zip
# 解压并添加到 PATH
```

### 2. 测试转码功能

在服务器上执行：

```powershell
# 测试 FFmpeg
ffmpeg -version

# 创建测试视频
ffmpeg -f lavfi -i testsrc=duration=5:size=1280x720:rate=30 -pix_fmt yuv420p C:\VideoTranscode\downloads\test.mp4

# 手动测试转码
powershell -ExecutionPolicy Bypass -File C:\VideoTranscode\scripts\transcode.ps1 -i C:\VideoTranscode\downloads\test.mp4 -o C:\VideoTranscode\completed\test_out.mp4
```

### 3. 启动监控服务

**方法1：双击启动**
- 双击桌面的 `C:\VideoTranscode\start.ps1`

**方法2：命令行启动**
```powershell
powershell -ExecutionPolicy Bypass -File C:\VideoTranscode\start.ps1
```

**方法3：直接运行监控服务**
```powershell
powershell -ExecutionPolicy Bypass -NoExit -File C:\VideoTranscode\scripts\watcher.ps1
```

### 4. 使用转码服务

1. **将视频文件放入** `C:\VideoTranscode\downloads`
2. **监控服务会自动**：
   - 检测新视频
   - 移动到 processing 目录
   - 开始转码
   - 转码完成后移动到 completed 目录
   - 删除原文件

3. **转码完成的视频在** `C:\VideoTranscode\completed`

## 🔧 转码参数

当前配置：
- 视频编码：H.264 (libx264)
- 预设：medium（平衡速度和质量）
- CRF：23（质量参数，越小质量越好）
- 音频编码：AAC
- 音频比特率：128k
- Fast Start：启用（适合网络播放）

## 📊 性能预估

根据网络测试结果：

### 从 Telegram/CDN 下载
- 下载速度：20-60 MB/s
- 1GB 视频下载：18-50 秒

### 转码性能
- CPU：Intel Xeon E5-2660 (8核16线程)
- 1GB 视频转码：5-8 分钟
- 并发处理：3-4 个视频

### 总处理时间
- 单个 1GB 视频：6-9 分钟
- 一天处理能力：480-720 个视频（3个并发）

## 🚀 优化建议

### 1. 提高转码速度
修改 `transcode.ps1` 中的参数：

```powershell
# 更快的预设（质量稍低）
-preset fast

# 或使用 veryfast
-preset veryfast
```

### 2. 并发处理
启动多个监控服务实例（修改监控目录）

### 3. 自动上传到主服务器
在 `watcher.ps1` 中添加上传逻辑：

```powershell
# 转码成功后上传
if($?){
    Remove-Item $pp -Force
    # 使用 scp 或 rsync 上传到主服务器
    pscp -pw 密码 $op root@38.47.218.137:/path/to/upload/
}
```

## 📝 日志文件

- 监控服务日志：`C:\VideoTranscode\logs\watcher.log`
- 转码日志：`C:\VideoTranscode\logs\transcode_*.log`
- 错误日志：`C:\VideoTranscode\logs\transcode_*.log.err`

## ❓ 常见问题

### Q: 监控服务没有反应？
A: 检查：
1. FFmpeg 是否已安装
2. 视频文件格式是否支持（.mp4, .avi, .mov, .mkv）
3. 查看日志文件

### Q: 转码失败？
A: 检查：
1. 输入文件是否损坏
2. 磁盘空间是否足够
3. 查看错误日志 `*.log.err`

### Q: 如何停止监控服务？
A: 在监控服务窗口按 `Ctrl+C`

### Q: 如何修改转码参数？
A: 编辑 `C:\VideoTranscode\scripts\transcode.ps1`

## 🎯 下一步计划

1. ✅ 转码服务配置完成
2. ⏭️ 安装 FFmpeg
3. ⏭️ 测试转码功能
4. ⏭️ 配置 Telegram 自动下载
5. ⏭️ 配置自动上传到主服务器
6. ⏭️ 设置开机自启动

## 📞 技术支持

如有问题，检查：
1. 日志文件
2. FFmpeg 版本
3. 磁盘空间
4. 文件权限

---

**配置完成时间**: 2026-01-16
**服务器**: 198.176.60.121 (香港)
**状态**: ✅ 已配置，等待安装 FFmpeg
