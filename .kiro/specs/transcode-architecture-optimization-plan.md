# è½¬ç æ¶æ„ä¼˜åŒ–å®æ–½è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**: ä¼˜åŒ–è§†é¢‘å¤„ç†æ¶æ„ï¼Œè®©è½¬ç æœåŠ¡å™¨ç›´æ¥å¤„ç†æœ¬åœ°ä¸‹è½½çš„è§†é¢‘ï¼Œé¿å…ä¸å¿…è¦çš„ç½‘ç»œä¼ è¾“

**é¢„æœŸæ”¶ç›Š**:
- å¸¦å®½èŠ‚çœ 60-70%
- å¤„ç†æ—¶é—´å‡å°‘ 50%
- æ¶æ„æ›´æ¸…æ™°åˆç†

## ğŸ—ï¸ ç›®æ ‡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è½¬ç æœåŠ¡å™¨ (198.176.60.121)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è§†é¢‘ä¸‹è½½  â”‚ â†’  â”‚ GPUè½¬ç   â”‚ â†’  â”‚ ç”Ÿæˆå°é¢  â”‚ â†’  â”‚ ç”Ÿæˆé¢„è§ˆ  â”‚  â”‚
â”‚  â”‚ (æœ¬åœ°)   â”‚    â”‚ (NVENC)  â”‚    â”‚ (FFmpeg) â”‚    â”‚ (FFmpeg) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                       â†“         â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                              â”‚  æ‰“åŒ…ä¸Šä¼      â”‚   â”‚
â”‚                                              â”‚  â€¢ è§†é¢‘.mp4  â”‚   â”‚
â”‚                                              â”‚  â€¢ å°é¢.webp â”‚   â”‚
â”‚                                              â”‚  â€¢ é¢„è§ˆ.mp4  â”‚   â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“ SCPä¸Šä¼  (50MB/s)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸»æœåŠ¡å™¨ (38.47.218.137)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /uploads/videos/      â† è½¬ç åè§†é¢‘                              â”‚
â”‚  /uploads/thumbnails/  â† å°é¢å›¾ç‰‡                                â”‚
â”‚  /uploads/previews/    â† é¢„è§ˆè§†é¢‘                                â”‚
â”‚                                                                  â”‚
â”‚  æ¥æ”¶å›è°ƒ â†’ æ›´æ–°æ•°æ®åº“ â†’ å‘å¸ƒè§†é¢‘                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“… å®æ–½é˜¶æ®µ

### é˜¶æ®µ1: è½¬ç è„šæœ¬å‡çº§ (Day 1)

#### ä»»åŠ¡1.1: ä¿®æ”¹è½¬ç è„šæœ¬ï¼Œå¢åŠ å°é¢å’Œé¢„è§ˆç”Ÿæˆ

**æ–‡ä»¶**: `scripts/gpu_transcode_v2.sh` (è½¬ç æœåŠ¡å™¨)

**æ–°å¢åŠŸèƒ½**:
```bash
# ç”Ÿæˆå°é¢ (åœ¨è§†é¢‘30%ä½ç½®æˆªå›¾)
generate_cover() {
    local input="$1"
    local output="$2"
    local duration=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$input")
    local position=$(echo "$duration * 0.3" | bc)
    
    ffmpeg -ss "$position" -i "$input" \
        -vframes 1 \
        -vf "scale=480:-1" \
        -q:v 2 \
        "$output"
}

# ç”Ÿæˆé¢„è§ˆ (æˆªå–10ç§’ç²¾å½©ç‰‡æ®µ)
generate_preview() {
    local input="$1"
    local output="$2"
    local duration=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$input")
    local start=$(echo "$duration * 0.2" | bc)
    
    ffmpeg -ss "$start" -i "$input" \
        -t 10 \
        -vf "scale=720:-1" \
        -c:v h264_nvenc \
        -preset fast \
        -b:v 1M \
        -an \
        "$output"
}
```

#### ä»»åŠ¡1.2: ä¿®æ”¹ä¸Šä¼ è„šæœ¬ï¼Œæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 

**æ–‡ä»¶**: `scripts/upload_to_main.ps1` (è½¬ç æœåŠ¡å™¨)

**ä¿®æ”¹å†…å®¹**:
```powershell
# ä¸Šä¼ è½¬ç ç»“æœï¼ˆè§†é¢‘+å°é¢+é¢„è§ˆï¼‰
function Upload-TranscodeResult {
    param(
        [string]$VideoFile,
        [string]$CoverFile,
        [string]$PreviewFile,
        [string]$VideoId
    )
    
    # ä¸Šä¼ è§†é¢‘
    scp -i C:\server_key "$VideoFile" "root@38.47.218.137:/www/wwwroot/video-app/backend/uploads/videos/"
    
    # ä¸Šä¼ å°é¢
    scp -i C:\server_key "$CoverFile" "root@38.47.218.137:/www/wwwroot/video-app/backend/uploads/thumbnails/"
    
    # ä¸Šä¼ é¢„è§ˆ
    scp -i C:\server_key "$PreviewFile" "root@38.47.218.137:/www/wwwroot/video-app/backend/uploads/previews/"
    
    # é€šçŸ¥ä¸»æœåŠ¡å™¨
    Invoke-RestMethod -Uri "http://38.47.218.137:8000/api/v1/admin/transcode-callback" `
        -Method POST `
        -Headers @{"X-Transcode-Key"="vYTWoms4FKOqySca1jCLtNHRVz3BAI6U"} `
        -Body (@{
            video_id = $VideoId
            status = "completed"
            video_url = "/uploads/videos/$($VideoFile | Split-Path -Leaf)"
            cover_url = "/uploads/thumbnails/$($CoverFile | Split-Path -Leaf)"
            preview_url = "/uploads/previews/$($PreviewFile | Split-Path -Leaf)"
        } | ConvertTo-Json) `
        -ContentType "application/json"
}
```

### é˜¶æ®µ2: ä¸»æœåŠ¡å™¨é€‚é… (Day 1-2)

#### ä»»åŠ¡2.1: åˆ›å»ºé¢„è§ˆç›®å½•

```bash
# åœ¨ä¸»æœåŠ¡å™¨æ‰§è¡Œ
mkdir -p /www/wwwroot/video-app/backend/uploads/previews
chmod 755 /www/wwwroot/video-app/backend/uploads/previews
```

#### ä»»åŠ¡2.2: ä¿®æ”¹å›è°ƒæ¥å£

**æ–‡ä»¶**: `backend/app/api/transcode_callback.py`

**ä¿®æ”¹å†…å®¹**: æ¥æ”¶å¹¶å¤„ç†å°é¢å’Œé¢„è§ˆURL

```python
@router.post("/transcode-callback")
async def transcode_callback(
    request: Request,
    db: AsyncSession = Depends(get_db)
):
    data = await request.json()
    
    video_id = data.get("video_id")
    status = data.get("status")
    video_url = data.get("video_url")
    cover_url = data.get("cover_url")      # æ–°å¢
    preview_url = data.get("preview_url")  # æ–°å¢
    
    # æ›´æ–°è§†é¢‘è®°å½•
    video = await db.get(Video, video_id)
    if video:
        video.hls_url = video_url
        video.cover_url = cover_url
        video.preview_url = preview_url
        video.status = VideoStatus.PUBLISHED
        await db.commit()
```

#### ä»»åŠ¡2.3: æ›´æ–°Nginxé…ç½®

```nginx
# æ·»åŠ é¢„è§ˆç›®å½•çš„é™æ€æ–‡ä»¶æœåŠ¡
location /uploads/previews {
    alias /www/wwwroot/video-app/backend/uploads/previews;
    expires 30d;
}
```

### é˜¶æ®µ3: ç›‘æ§è„šæœ¬å‡çº§ (Day 2)

#### ä»»åŠ¡3.1: ä¿®æ”¹watcherè„šæœ¬

**æ–‡ä»¶**: `scripts/watcher_with_upload.ps1`

**å®Œæ•´å¤„ç†æµç¨‹**:
```powershell
function Process-Video {
    param([string]$InputFile)
    
    $baseName = [System.IO.Path]::GetFileNameWithoutExtension($InputFile)
    $videoId = $baseName  # æˆ–ä»æ–‡ä»¶åè§£æ
    
    # 1. è½¬ç 
    $transcodedFile = "D:\VideoTranscode\completed\${baseName}_transcoded.mp4"
    Start-Transcode -Input $InputFile -Output $transcodedFile
    
    # 2. ç”Ÿæˆå°é¢
    $coverFile = "D:\VideoTranscode\completed\${baseName}_cover.webp"
    Generate-Cover -Input $transcodedFile -Output $coverFile
    
    # 3. ç”Ÿæˆé¢„è§ˆ
    $previewFile = "D:\VideoTranscode\completed\${baseName}_preview.mp4"
    Generate-Preview -Input $transcodedFile -Output $previewFile
    
    # 4. ä¸Šä¼ å…¨éƒ¨æ–‡ä»¶
    Upload-TranscodeResult `
        -VideoFile $transcodedFile `
        -CoverFile $coverFile `
        -PreviewFile $previewFile `
        -VideoId $videoId
    
    # 5. æ¸…ç†æœ¬åœ°æ–‡ä»¶
    Remove-Item $InputFile -Force
    Remove-Item $transcodedFile -Force
    Remove-Item $coverFile -Force
    Remove-Item $previewFile -Force
    
    Write-Log "Completed: $baseName"
}
```

### é˜¶æ®µ4: æµ‹è¯•éªŒè¯ (Day 3)

#### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•é¡¹ | é¢„æœŸç»“æœ | éªŒè¯æ–¹æ³• |
|--------|---------|---------|
| è½¬ç åŠŸèƒ½ | è§†é¢‘æ­£å¸¸è½¬ç  | æ£€æŸ¥è¾“å‡ºæ–‡ä»¶ |
| å°é¢ç”Ÿæˆ | ç”ŸæˆWebPå°é¢ | æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œæ ¼å¼ |
| é¢„è§ˆç”Ÿæˆ | ç”Ÿæˆ10ç§’é¢„è§ˆ | æ’­æ”¾éªŒè¯ |
| æ–‡ä»¶ä¸Šä¼  | 3ä¸ªæ–‡ä»¶å…¨éƒ¨ä¸Šä¼ æˆåŠŸ | æ£€æŸ¥ä¸»æœåŠ¡å™¨ç›®å½• |
| å›è°ƒé€šçŸ¥ | æ•°æ®åº“æ­£ç¡®æ›´æ–° | æŸ¥è¯¢è§†é¢‘è®°å½• |
| å‰ç«¯æ˜¾ç¤º | å°é¢å’Œé¢„è§ˆæ­£å¸¸æ˜¾ç¤º | æµè§ˆå™¨è®¿é—® |

#### æµ‹è¯•è„šæœ¬

```powershell
# åœ¨è½¬ç æœåŠ¡å™¨æ‰§è¡Œ
# 1. åˆ›å»ºæµ‹è¯•è§†é¢‘
ffmpeg -f lavfi -i testsrc=duration=60:size=1920x1080:rate=30 `
    -c:v h264 -pix_fmt yuv420p `
    D:\VideoTranscode\downloads\test_full_flow.mp4

# 2. è§‚å¯Ÿå¤„ç†æµç¨‹
Get-Content D:\VideoTranscode\logs\watcher.log -Tail 50 -Wait

# 3. éªŒè¯ä¸»æœåŠ¡å™¨æ–‡ä»¶
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/videos/ | tail -5"
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/thumbnails/ | tail -5"
ssh -i C:\server_key root@38.47.218.137 "ls -la /www/wwwroot/video-app/backend/uploads/previews/ | tail -5"
```

## ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### è½¬ç æœåŠ¡å™¨ (198.176.60.121)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| `D:\VideoTranscode\scripts\transcode.ps1` | æ·»åŠ å°é¢/é¢„è§ˆç”Ÿæˆ | P0 |
| `D:\VideoTranscode\scripts\upload_to_main.ps1` | æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼  | P0 |
| `D:\VideoTranscode\scripts\watcher.ps1` | å®Œæ•´å¤„ç†æµç¨‹ | P0 |

### ä¸»æœåŠ¡å™¨ (38.47.218.137)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| `backend/app/api/transcode_callback.py` | æ¥æ”¶å°é¢/é¢„è§ˆURL | P0 |
| `/etc/nginx/sites-available/default` | æ·»åŠ previewsç›®å½• | P1 |
| åˆ›å»ºç›®å½• `/uploads/previews/` | æ–°å»ºç›®å½• | P0 |

## â±ï¸ æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | æ—¶é—´ |
|------|------|------|
| é˜¶æ®µ1 | è½¬ç è„šæœ¬å‡çº§ | 2å°æ—¶ |
| é˜¶æ®µ2 | ä¸»æœåŠ¡å™¨é€‚é… | 1å°æ—¶ |
| é˜¶æ®µ3 | ç›‘æ§è„šæœ¬å‡çº§ | 1å°æ—¶ |
| é˜¶æ®µ4 | æµ‹è¯•éªŒè¯ | 1å°æ—¶ |
| **æ€»è®¡** | | **5å°æ—¶** |

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] è½¬ç æœåŠ¡å™¨èƒ½ç”Ÿæˆå°é¢å›¾ç‰‡ï¼ˆWebPæ ¼å¼ï¼Œ<200KBï¼‰
- [ ] è½¬ç æœåŠ¡å™¨èƒ½ç”Ÿæˆé¢„è§ˆè§†é¢‘ï¼ˆ10ç§’ï¼Œ<5MBï¼‰
- [ ] ä¸‰ä¸ªæ–‡ä»¶èƒ½æˆåŠŸä¸Šä¼ åˆ°ä¸»æœåŠ¡å™¨
- [ ] å›è°ƒæ¥å£æ­£ç¡®æ›´æ–°æ•°æ®åº“
- [ ] å‰ç«¯èƒ½æ­£å¸¸æ˜¾ç¤ºå°é¢å’Œé¢„è§ˆ

### æ€§èƒ½éªŒæ”¶
- [ ] å°é¢ç”Ÿæˆæ—¶é—´ < 5ç§’
- [ ] é¢„è§ˆç”Ÿæˆæ—¶é—´ < 30ç§’
- [ ] æ€»ä¸Šä¼ æ—¶é—´ < 15ç§’ï¼ˆ500MBè§†é¢‘ï¼‰
- [ ] å¤„ç†å®Œæˆåæœ¬åœ°æ–‡ä»¶å·²æ¸…ç†

### è´¨é‡éªŒæ”¶
- [ ] å°é¢æ¸…æ™°åº¦æ»¡è¶³è¦æ±‚
- [ ] é¢„è§ˆæµç•…æ— å¡é¡¿
- [ ] æ—¥å¿—è®°å½•å®Œæ•´
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

## ğŸš€ åç»­ä¼˜åŒ–

1. **æ™ºèƒ½å°é¢é€‰æ‹©**: ä½¿ç”¨AIé€‰æ‹©æœ€ä½³å°é¢å¸§
2. **å¤šåˆ†è¾¨ç‡é¢„è§ˆ**: ç”Ÿæˆä¸åŒåˆ†è¾¨ç‡çš„é¢„è§ˆ
3. **HLSåˆ‡ç‰‡**: åœ¨è½¬ç æœåŠ¡å™¨ç”ŸæˆHLSåˆ‡ç‰‡
4. **å¹¶è¡Œå¤„ç†**: åŒæ—¶ç”Ÿæˆå°é¢å’Œé¢„è§ˆ

---

**åˆ›å»ºæ—¶é—´**: 2026-01-16  
**é¢„è®¡å®Œæˆ**: 2026-01-17  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: ğŸ“‹ å¾…å®æ–½
