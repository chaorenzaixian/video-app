# 转码脚本 PowerShell 语法错误修复

## 问题描述

转码服务器上的 PowerShell 脚本出现语法错误：

```
变量引用无效。':' 后面的变量名称字符无效。请考虑使用 ${} 分隔名称。
```

**错误位置**: `transcode_full.ps1` 第 219 行及其他多处

**错误原因**: 在 PowerShell 字符串插值中使用了 `$([math]::Round(...))` 语法，其中的双冒号 `::` 被解析器误认为是驱动器路径。

## 修复方案

将所有 `$([math]::Round(...))` 表达式改为先计算再插值的方式：

**修复前**:
```powershell
Write-Log "耗时: $([math]::Round($duration, 1))秒" "Green"
```

**修复后**:
```powershell
$roundedDuration = [math]::Round($duration, 1)
Write-Log "耗时: ${roundedDuration}秒" "Green"
```

## 已修复的文件

1. **scripts/transcode_full.ps1**
   - 第 120 行：转码完成日志
   - 第 158 行：封面生成日志  
   - 第 219 行：预览片段日志
   - 第 257 行：预览完成日志

2. **scripts/upload_full.ps1**
   - 第 60 行：文件上传大小显示
   - 第 172 行：上传完成耗时显示

3. **scripts/watcher_full.ps1**
   - 第 111 行：转码完成耗时
   - 第 156 行：上传完成耗时
   - 第 179-181 行：处理完成统计
   - 第 256 行：长视频处理统计
   - 第 282 行：短视频处理统计

## 部署步骤

### 方法一：手动部署（推荐）

1. **登录转码服务器** (198.176.60.121)

2. **停止当前 watcher 服务**:
   ```powershell
   # 查看运行中的 PowerShell 进程
   Get-Process | Where-Object { $_.ProcessName -like "*powershell*" }
   
   # 停止 watcher 进程（如果在运行）
   Stop-Process -Name powershell -Force
   ```

3. **备份现有脚本**:
   ```powershell
   $backupDir = "D:\VideoTranscode\scripts\backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
   New-Item -ItemType Directory -Path $backupDir -Force
   Copy-Item "D:\VideoTranscode\scripts\*.ps1" $backupDir
   ```

4. **复制修复后的脚本文件**:
   - 将本地的 `scripts/transcode_full.ps1` 复制到 `D:\VideoTranscode\scripts\transcode_full.ps1`
   - 将本地的 `scripts/upload_full.ps1` 复制到 `D:\VideoTranscode\scripts\upload_full.ps1`  
   - 将本地的 `scripts/watcher_full.ps1` 复制到 `D:\VideoTranscode\scripts\watcher.ps1`

5. **重新启动 watcher 服务**:
   ```powershell
   powershell -ExecutionPolicy Bypass -File D:\VideoTranscode\scripts\watcher.ps1
   ```

### 方法二：使用部署脚本

1. 将以下文件复制到转码服务器：
   - `deploy_fixed_scripts.ps1`
   - `scripts/transcode_full.ps1`
   - `scripts/upload_full.ps1`
   - `scripts/watcher_full.ps1`

2. 在转码服务器上运行：
   ```powershell
   powershell -ExecutionPolicy Bypass -File deploy_fixed_scripts.ps1
   ```

## 验证修复

修复后，转码日志应该正常显示，不再出现语法错误：

```
2026-01-17 04:00:00 - [2/4] 开始转码处理...
2026-01-17 04:00:30 - [转码] 完成! 耗时: 30.2秒, 大小: 45.67MB
2026-01-17 04:00:35 - [封面] 完成! 大小: 128.5KB
2026-01-17 04:00:45 - [预览] 完成! 10 段共 10.0秒, 大小: 256.3KB
```

## 当前状态

- ✅ 已修复所有 PowerShell 语法错误
- ✅ 已创建部署脚本
- ⚠️  需要手动部署到转码服务器（SSH 密钥认证问题）
- ⚠️  需要重启 watcher 服务

## 统计信息

从错误日志可以看到：
- **失败次数**: 3562 次
- **运行时间**: 13.9 小时
- **成功次数**: 0 次

修复后应该能够正常处理视频文件。