# 长短视频分类系统详细说明

## 📖 系统概述

视频转码系统现已支持长短视频自动分类功能。系统使用 **FFprobe** 工具检测视频的实际播放时长，然后根据预设的阈值（默认60秒）自动将视频分类为短视频或长视频。

## 🎯 分类原理

### 技术实现
1. **时长检测**: 使用 `ffprobe -v quiet -show_entries format=duration -of csv=p=0 视频文件`
2. **分类逻辑**: 比较检测到的时长与配置的阈值
3. **自动处理**: Watcher 服务自动扫描、检测、分类、转码

### 分类标准
- **短视频**: 时长 ≤ 60秒
- **长视频**: 时长 > 60秒
- **可配置**: 可通过修改 `config.ini` 调整阈值

## 📁 目录结构

```
D:\VideoTranscode\
├── downloads\              # 📥 上传目录
│   ├── (根目录)            # 🔄 自动分类区域
│   ├── short\              # 📱 手动短视频区域  
│   └── long\               # 🎬 手动长视频区域
├── processing\             # ⚙️ 临时处理目录
├── completed\              # 📤 输出目录
│   ├── short\              # 📱 短视频输出
│   └── long\               # 🎬 长视频输出
├── logs\                   # 📝 日志目录
│   └── watcher.log         # Watcher 服务日志
├── scripts\                # 🔧 脚本目录
│   ├── watcher.ps1         # 监控服务脚本
│   └── transcode_full.ps1  # 转码脚本
└── config.ini              # ⚙️ 配置文件
```

## 🔄 三种使用方式

### 1. 自动分类（推荐）

**上传位置**: `D:\VideoTranscode\downloads\` (根目录)

**工作流程**:
1. 将视频文件放入 downloads 根目录
2. Watcher 每10秒扫描一次，发现新文件
3. 使用 FFprobe 检测视频实际时长
4. 根据时长与阈值比较自动分类
   - ≤ 60秒 → 标记为 'short'
   - > 60秒 → 标记为 'long'
5. 文件移动到 processing 目录
6. 调用转码脚本，传递视频类型参数
7. 转码完成后保存到对应的 `completed\short\` 或 `completed\long\`

**优点**: 
- ✅ 完全自动化
- ✅ 基于实际时长分类
- ✅ 无需人工判断

### 2. 手动短视频分类

**上传位置**: `D:\VideoTranscode\downloads\short\`

**工作流程**:
1. 将视频文件放入 downloads\short\ 目录
2. 系统跳过时长检测，直接标记为 'short'
3. 转码后输出到 `completed\short\`

**适用场景**:
- 需要强制按短视频处理
- 视频时长接近阈值但希望按短视频处理
- 批量处理已知的短视频

### 3. 手动长视频分类

**上传位置**: `D:\VideoTranscode\downloads\long\`

**工作流程**:
1. 将视频文件放入 downloads\long\ 目录
2. 系统跳过时长检测，直接标记为 'long'
3. 转码后输出到 `completed\long\`

**适用场景**:
- 需要强制按长视频处理
- 视频时长接近阈值但希望按长视频处理
- 批量处理已知的长视频

## 📊 分类示例表

| 视频时长 | 上传位置 | 分类方式 | 分类结果 | 输出位置 |
|---------|---------|---------|---------|---------|
| 30秒 | downloads\ | 自动检测 | short | completed\short\ |
| 90秒 | downloads\ | 自动检测 | long | completed\long\ |
| 55秒 | downloads\ | 自动检测 | short | completed\short\ |
| 65秒 | downloads\ | 自动检测 | long | completed\long\ |
| 任意 | downloads\short\ | 手动强制 | short | completed\short\ |
| 任意 | downloads\long\ | 手动强制 | long | completed\long\ |

## ⚙️ 配置文件详解

**文件位置**: `D:\VideoTranscode\config.ini`

**配置内容**:
```ini
# 视频分类配置
SHORT_VIDEO_THRESHOLD=60    # 短视频阈值（秒）
LONG_VIDEO_THRESHOLD=60     # 长视频阈值（秒，目前未使用）
```

**修改方法**:
1. 使用文本编辑器打开 `D:\VideoTranscode\config.ini`
2. 修改 `SHORT_VIDEO_THRESHOLD` 的值
3. 保存文件
4. 重启 Watcher 服务（新文件会使用新阈值）

**示例**:
- 设置为 30: 30秒以下为短视频
- 设置为 120: 2分钟以下为短视频
- 设置为 180: 3分钟以下为短视频

## 🔧 Watcher 服务工作机制

### 核心功能
1. **循环扫描**: 每10秒检查一次 downloads 目录
2. **文件过滤**: 只处理 .mp4 文件且大小 > 1000字节
3. **多目录支持**: 同时扫描根目录、short、long 子目录
4. **时长检测**: 对根目录的文件进行 FFprobe 检测
5. **类型传递**: 将视频类型参数传递给转码脚本
6. **日志记录**: 记录处理过程和统计信息

### 服务管理

**启动服务**:
```powershell
powershell -ExecutionPolicy Bypass -File D:\VideoTranscode\scripts\watcher.ps1
```

**停止服务**:
```powershell
Get-Process powershell | Where-Object { $_.CommandLine -like '*watcher*' } | Stop-Process -Force
```

**查看日志**:
```powershell
Get-Content D:\VideoTranscode\logs\watcher.log -Tail 20
```

## 📝 文件命名要求

### 必须满足的条件
1. **文件格式**: 必须是 `.mp4` 格式
2. **文件大小**: 必须大于 1000 字节（1KB）
3. **文件完整性**: 文件必须完整且未损坏

### 命名建议
- ✅ 使用英文字母、数字、下划线、连字符
- ✅ 避免特殊字符（如 `<>:"/\|?*`）
- ✅ 文件名不要过长（建议 < 100 字符）
- ✅ 可以使用中文，但建议使用英文

### 示例
```
✅ 好的命名:
- video_001.mp4
- short-video-2024.mp4
- 测试视频.mp4
- my_video_20240117.mp4

❌ 避免的命名:
- video?.mp4
- video*.mp4
- video<1>.mp4
- video|test.mp4
```

## 🎯 使用建议

### 推荐做法
- ✅ **优先使用自动分类**: 上传到 downloads 根目录，让系统自动检测
- ✅ **批量处理**: 可以一次性放入多个文件，系统会依次处理
- ✅ **监控日志**: 定期查看 logs\watcher.log 了解处理状态
- ✅ **合理设置阈值**: 根据实际需求调整 config.ini 中的阈值

### 注意事项
- ⚠️ **文件完整性**: FFprobe 检测需要视频文件完整且格式正确
- ⚠️ **损坏文件**: 损坏的视频文件可能导致检测失败
- ⚠️ **极短视频**: 非常短的视频（<1秒）可能检测不准确
- ⚠️ **手动分类**: 手动分类会跳过时长检测，直接按目录分类
- ⚠️ **服务状态**: 确保 Watcher 服务正在运行

## 🔍 故障排查

### 问题1: 文件没有被处理

**可能原因**:
1. Watcher 服务未运行
2. 文件格式不是 .mp4
3. 文件大小 < 1000 字节
4. 文件名包含特殊字符

**解决方法**:
```powershell
# 检查 Watcher 进程
Get-Process powershell | Where-Object { $_.CommandLine -like '*watcher*' }

# 检查文件
Get-ChildItem D:\VideoTranscode\downloads -Filter *.mp4 -File

# 查看日志
Get-Content D:\VideoTranscode\logs\watcher.log -Tail 20
```

### 问题2: 分类不正确

**可能原因**:
1. 阈值设置不合理
2. FFprobe 检测失败
3. 视频文件损坏

**解决方法**:
1. 检查 config.ini 中的阈值设置
2. 手动测试 FFprobe:
```powershell
ffprobe -v quiet -show_entries format=duration -of csv=p=0 "视频文件路径"
```
3. 使用手动分类方式

### 问题3: 转码失败

**可能原因**:
1. 转码脚本有语法错误
2. FFmpeg 不可用
3. 磁盘空间不足

**解决方法**:
1. 查看转码日志
2. 检查 FFmpeg 是否可用:
```powershell
ffmpeg -version
```
3. 检查磁盘空间

## 📊 系统状态检查

### 快速检查脚本

创建一个 PowerShell 脚本 `check_status.ps1`:

```powershell
Write-Host "=== 视频分类系统状态检查 ===" -ForegroundColor Green

# 1. 检查 Watcher 进程
Write-Host "`n1. Watcher 进程:" -ForegroundColor Yellow
$watcher = Get-Process powershell -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*watcher*' }
if ($watcher) {
    Write-Host "   ✅ 运行中 (PID: $($watcher.Id))" -ForegroundColor Green
} else {
    Write-Host "   ❌ 未运行" -ForegroundColor Red
}

# 2. 检查目录
Write-Host "`n2. 目录状态:" -ForegroundColor Yellow
$downloads = Get-ChildItem D:\VideoTranscode\downloads -Filter *.mp4 -File -ErrorAction SilentlyContinue
Write-Host "   Downloads: $($downloads.Count) 个文件"
$processing = Get-ChildItem D:\VideoTranscode\processing -Filter *.mp4 -File -ErrorAction SilentlyContinue
Write-Host "   Processing: $($processing.Count) 个文件"
$completedShort = Get-ChildItem D:\VideoTranscode\completed\short -Filter *.mp4 -File -ErrorAction SilentlyContinue
Write-Host "   Completed/Short: $($completedShort.Count) 个文件"
$completedLong = Get-ChildItem D:\VideoTranscode\completed\long -Filter *.mp4 -File -ErrorAction SilentlyContinue
Write-Host "   Completed/Long: $($completedLong.Count) 个文件"

# 3. 检查配置
Write-Host "`n3. 配置:" -ForegroundColor Yellow
if (Test-Path D:\VideoTranscode\config.ini) {
    $config = Get-Content D:\VideoTranscode\config.ini | Where-Object { $_ -match "SHORT_VIDEO_THRESHOLD=" }
    if ($config) {
        $threshold = ($config -split "=")[1]
        Write-Host "   短视频阈值: $threshold 秒" -ForegroundColor Green
    }
} else {
    Write-Host "   ❌ 配置文件不存在" -ForegroundColor Red
}

# 4. 最新日志
Write-Host "`n4. 最新日志:" -ForegroundColor Yellow
if (Test-Path D:\VideoTranscode\logs\watcher.log) {
    Get-Content D:\VideoTranscode\logs\watcher.log -Tail 3
} else {
    Write-Host "   ❌ 日志文件不存在" -ForegroundColor Red
}
```

运行检查:
```powershell
powershell -ExecutionPolicy Bypass -File check_status.ps1
```

## 🚀 快速开始

### 第一次使用

1. **确认服务运行**:
```powershell
Get-Process powershell | Where-Object { $_.CommandLine -like '*watcher*' }
```

2. **上传测试视频**:
   - 将一个短视频（<60秒）放入 `D:\VideoTranscode\downloads\`
   - 将一个长视频（>60秒）放入 `D:\VideoTranscode\downloads\`

3. **观察处理过程**:
```powershell
# 实时查看日志
Get-Content D:\VideoTranscode\logs\watcher.log -Wait -Tail 10
```

4. **检查结果**:
```powershell
# 查看短视频输出
Get-ChildItem D:\VideoTranscode\completed\short

# 查看长视频输出
Get-ChildItem D:\VideoTranscode\completed\long
```

### 日常使用

1. **上传视频**: 直接将 .mp4 文件放入 `D:\VideoTranscode\downloads\`
2. **等待处理**: 系统会自动检测、分类、转码
3. **获取结果**: 从 `completed\short\` 或 `completed\long\` 获取转码后的视频

## 📞 技术支持

如果遇到问题，请提供以下信息:
1. Watcher 日志 (`D:\VideoTranscode\logs\watcher.log`)
2. 转码日志（如果有）
3. 问题视频的文件名和大小
4. 系统状态检查结果

---

**最后更新**: 2026-01-17
**版本**: 1.0
**状态**: ✅ 已部署并运行
