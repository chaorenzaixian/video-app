# è§†é¢‘åº”ç”¨é¡¹ç›®æ·±åº¦ä¼˜åŒ–å»ºè®®æŠ¥å‘Š v2

> åˆ†ææ—¥æœŸï¼š2026å¹´1æœˆ13æ—¥
> åˆ†æèŒƒå›´ï¼šåç«¯æ¶æ„ã€å‰ç«¯æ¶æ„ã€æ•°æ®åº“ã€å®‰å…¨ã€æ€§èƒ½ã€ä»£ç è´¨é‡

---

## ğŸ“Š é¡¹ç›®ç°çŠ¶è¯„ä¼°

| ç»´åº¦ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ | âœ… å·²ä¼˜åŒ– | æ‰¹é‡æŸ¥è¯¢ | âœ… å®Œæˆ |
| æµ‹è¯•è¦†ç›–ç‡ | 0% | 80% | ğŸ”´ é«˜ |
| ç¼“å­˜åˆ©ç”¨ç‡ | 30% | 90% | ğŸŸ¡ ä¸­ |
| ä»£ç é‡å¤ç‡ | 15% | <5% | ğŸŸ¡ ä¸­ |
| å®‰å…¨é…ç½® | âœ… å·²å®Œå–„ | å®Œå–„ | âœ… å®Œæˆ |
| æ ¹ç›®å½•è„šæœ¬ | âœ… å·²æ•´ç† | å·²æ•´ç† | âœ… å®Œæˆ |
| å‰ç«¯ç»„ä»¶æ‹†åˆ† | 4388è¡Œå¤§ç»„ä»¶ | <500è¡Œ/ç»„ä»¶ | ğŸ”´ é«˜ |
| æ”¯ä»˜æœåŠ¡ | åŸºç¡€å®ç° | å®Œå–„çŠ¶æ€æœº | ğŸŸ¡ ä¸­ |

---

## âœ… ç¬¬ä¸€é˜¶æ®µå·²å®Œæˆä¼˜åŒ–

### 1. âœ… è¯„è®ºAPIçš„N+1æŸ¥è¯¢é—®é¢˜ - å·²ä¿®å¤

**æ–‡ä»¶**: `backend/app/api/comments.py`

**ä¼˜åŒ–å†…å®¹**:
- ä½¿ç”¨ `selectinload(Comment.user)` é¢„åŠ è½½ç”¨æˆ·å…³ç³»
- å®ç° `batch_get_user_vip_levels()` æ‰¹é‡æŸ¥è¯¢VIPç­‰çº§
- å®ç° `batch_get_liked_comment_ids()` æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€
- 20æ¡è¯„è®ºä»60+æ¬¡æŸ¥è¯¢ä¼˜åŒ–ä¸º3-4æ¬¡æŸ¥è¯¢

---

### 2. âœ… Commentè¡¨ç´¢å¼• - å·²æ·»åŠ 

**æ–‡ä»¶**: `backend/alembic/versions/20260113_add_comment_indexes.py`

**æ·»åŠ çš„ç´¢å¼•**:
```python
Index('idx_comment_video_created', 'video_id', 'created_at')
Index('idx_comment_user_created', 'user_id', 'created_at')
Index('idx_comment_parent_id', 'parent_id')
Index('idx_comment_video_hidden', 'video_id', 'is_hidden')
```

---

### 3. âœ… JWTä»¤ç‰Œé»‘åå• - å·²å®ç°

**æ–‡ä»¶**: `backend/app/core/token_blacklist.py`

**åŠŸèƒ½**:
- ç”¨æˆ·ç™»å‡ºæ—¶å°†ä»¤ç‰ŒåŠ å…¥Redisé»‘åå•
- éªŒè¯è¯·æ±‚æ—¶æ£€æŸ¥é»‘åå•
- è‡ªåŠ¨è¿‡æœŸï¼ˆä¸ä»¤ç‰ŒTTLä¸€è‡´ï¼‰

---

### 4. âœ… å®‰å…¨å“åº”å¤´ - å·²æ·»åŠ 

**æ–‡ä»¶**: `backend/app/main.py`

**æ·»åŠ çš„å“åº”å¤´**:
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection: 1; mode=block
- Strict-Transport-Security (ç”Ÿäº§ç¯å¢ƒ)

---

### 5. âœ… å‰ç«¯APIé…ç½®ä¼˜åŒ– - å·²å®Œæˆ

**æ–‡ä»¶**: `frontend/src/utils/api.js`

**ä¼˜åŒ–å†…å®¹**:
- ç§»é™¤ç¡¬ç¼–ç IPï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
- æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶
- æ·»åŠ 429é™æµå“åº”å¤„ç†

---

### 6. âœ… è§†é¢‘å¤„ç†å¹¶å‘æ§åˆ¶ - å·²æ·»åŠ 

**æ–‡ä»¶**: `backend/app/services/video_processor.py`

**ä¼˜åŒ–å†…å®¹**:
- ä½¿ç”¨ `asyncio.Semaphore(2)` é™åˆ¶å¹¶å‘è½¬ç æ•°é‡

---

### 7. âœ… Backendè„šæœ¬æ•´ç† - å·²å®Œæˆ

**ç›®å½•ç»“æ„**:
```
backend/scripts/
â”œâ”€â”€ migrations/     # æ•°æ®è¿ç§»è„šæœ¬
â”œâ”€â”€ maintenance/    # ç»´æŠ¤è„šæœ¬
â””â”€â”€ setup/          # åˆå§‹åŒ–è„šæœ¬
```

---

## ğŸ”´ ç¬¬äºŒé˜¶æ®µé«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆæœ¬å‘¨ä¿®å¤ï¼‰

### 1. é€šçŸ¥APIçš„N+1æŸ¥è¯¢é—®é¢˜

**é—®é¢˜ä½ç½®**: `backend/app/api/notifications.py`

**å½“å‰é—®é¢˜**:
```python
# æ¯æ¡é€šçŸ¥éƒ½å•ç‹¬æŸ¥è¯¢VIPä¿¡æ¯ï¼ˆç¬¬85-95è¡Œï¼‰
for comment, user, video in result.fetchall():
    is_vip, vip_level = await get_user_vip_info(db, user.id)  # N+1!
    items.append({...})
```

**å½±å“**: 50æ¡é€šçŸ¥ = 50+ æ¬¡VIPæŸ¥è¯¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# 1. å…ˆæ”¶é›†æ‰€æœ‰ç”¨æˆ·ID
user_ids = set()
raw_items = []
for comment, user, video in result.fetchall():
    user_ids.add(user.id)
    raw_items.append((comment, user, video))

# 2. æ‰¹é‡æŸ¥è¯¢VIPä¿¡æ¯
vip_map = await batch_get_user_vip_levels(db, list(user_ids))

# 3. æ„å»ºå“åº”
for comment, user, video in raw_items:
    is_vip = user.id in vip_map and vip_map[user.id] > 0
    vip_level = vip_map.get(user.id, 0)
    items.append({...})
```

---

### 2. VideoPlayer.vueç»„ä»¶è¿‡å¤§ï¼ˆ4388è¡Œï¼‰

**é—®é¢˜ä½ç½®**: `frontend/src/views/user/VideoPlayer.vue`

**å½“å‰é—®é¢˜**: å•æ–‡ä»¶4388è¡Œï¼ŒåŒ…å«ï¼š
- è§†é¢‘æ’­æ”¾å™¨é€»è¾‘
- å¹¿å‘Šç³»ç»Ÿ
- è¯„è®ºç³»ç»Ÿ
- æ¨èè§†é¢‘
- åˆ†äº«åŠŸèƒ½
- è´­ä¹°/VIPé€»è¾‘

**å»ºè®®æ‹†åˆ†æ–¹æ¡ˆ**:
```
frontend/src/views/user/VideoPlayer/
â”œâ”€â”€ index.vue                    # ä¸»ç»„ä»¶ï¼ˆ~300è¡Œï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ VideoPlayerCore.vue      # æ’­æ”¾å™¨æ ¸å¿ƒï¼ˆ~500è¡Œï¼‰
â”‚   â”œâ”€â”€ PreRollAd.vue            # å‰è´´å¹¿å‘Šï¼ˆ~150è¡Œï¼‰
â”‚   â”œâ”€â”€ TrialEndedOverlay.vue    # è¯•çœ‹ç»“æŸé®ç½©ï¼ˆ~100è¡Œï¼‰
â”‚   â”œâ”€â”€ ShareModal.vue           # åˆ†äº«å¼¹çª—ï¼ˆ~200è¡Œï¼‰
â”‚   â”œâ”€â”€ VideoIntro.vue           # è§†é¢‘ç®€ä»‹ï¼ˆ~300è¡Œï¼‰
â”‚   â”œâ”€â”€ CommentSection.vue       # è¯„è®ºåŒºï¼ˆ~400è¡Œï¼‰
â”‚   â”œâ”€â”€ RecommendVideos.vue      # æ¨èè§†é¢‘ï¼ˆ~200è¡Œï¼‰
â”‚   â””â”€â”€ VipPromoBar.vue          # VIPæ¨å¹¿æ¡ï¼ˆ~100è¡Œï¼‰
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useVideoPlayer.js        # æ’­æ”¾å™¨é€»è¾‘
â”‚   â”œâ”€â”€ useComments.js           # è¯„è®ºé€»è¾‘
â”‚   â”œâ”€â”€ useVideoPreview.js       # è§†é¢‘é¢„è§ˆé€»è¾‘
â”‚   â””â”€â”€ usePurchase.js           # è´­ä¹°é€»è¾‘
â””â”€â”€ constants.js                 # å¸¸é‡å®šä¹‰
```

**æ‹†åˆ†ä¼˜å…ˆçº§**:
1. å…ˆæå– `CommentSection.vue`ï¼ˆè¯„è®ºåŒºç‹¬ç«‹æ€§å¼ºï¼‰
2. å†æå– `ShareModal.vue`ï¼ˆå¯å¤ç”¨ï¼‰
3. ç„¶åæå– `composables/` é€»è¾‘å±‚
4. æœ€åæ‹†åˆ†æ’­æ”¾å™¨ç›¸å…³ç»„ä»¶

---

### 3. æ”¯ä»˜æœåŠ¡ç¼ºå°‘è®¢å•çŠ¶æ€æœº

**é—®é¢˜ä½ç½®**: `backend/app/services/payment_service.py`

**å½“å‰é—®é¢˜**:
- æ²¡æœ‰è®¢å•çŠ¶æ€ç®¡ç†
- ç¼ºå°‘å¹‚ç­‰æ€§å¤„ç†
- æ²¡æœ‰è¶…æ—¶è®¢å•å¤„ç†

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
from enum import Enum

class OrderStatus(str, Enum):
    PENDING = "pending"      # å¾…æ”¯ä»˜
    PAID = "paid"            # å·²æ”¯ä»˜
    FAILED = "failed"        # æ”¯ä»˜å¤±è´¥
    EXPIRED = "expired"      # å·²è¿‡æœŸ
    REFUNDED = "refunded"    # å·²é€€æ¬¾

class OrderStateMachine:
    """è®¢å•çŠ¶æ€æœº"""
    TRANSITIONS = {
        OrderStatus.PENDING: [OrderStatus.PAID, OrderStatus.FAILED, OrderStatus.EXPIRED],
        OrderStatus.PAID: [OrderStatus.REFUNDED],
        OrderStatus.FAILED: [OrderStatus.PENDING],  # å…è®¸é‡è¯•
        OrderStatus.EXPIRED: [],
        OrderStatus.REFUNDED: [],
    }
    
    @classmethod
    def can_transition(cls, from_status: OrderStatus, to_status: OrderStatus) -> bool:
        return to_status in cls.TRANSITIONS.get(from_status, [])
    
    @classmethod
    def transition(cls, order, to_status: OrderStatus):
        if not cls.can_transition(order.status, to_status):
            raise ValueError(f"æ— æ³•ä» {order.status} è½¬æ¢åˆ° {to_status}")
        order.status = to_status
        order.updated_at = datetime.utcnow()

# å¹‚ç­‰æ€§å¤„ç†
async def process_payment_callback(order_id: str, data: Dict):
    """å¤„ç†æ”¯ä»˜å›è°ƒï¼ˆå¹‚ç­‰ï¼‰"""
    async with db.begin():
        # ä½¿ç”¨ SELECT FOR UPDATE é”å®šè®¢å•
        order = await db.execute(
            select(Order).where(Order.id == order_id).with_for_update()
        )
        order = order.scalar_one_or_none()
        
        if not order:
            return {"error": "è®¢å•ä¸å­˜åœ¨"}
        
        # å·²å¤„ç†è¿‡çš„è®¢å•ç›´æ¥è¿”å›æˆåŠŸ
        if order.status == OrderStatus.PAID:
            return {"success": True, "message": "è®¢å•å·²å¤„ç†"}
        
        # çŠ¶æ€è½¬æ¢
        OrderStateMachine.transition(order, OrderStatus.PAID)
        await db.commit()
```

---

## ğŸŸ¡ ç¬¬äºŒé˜¶æ®µä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä¸‹å‘¨ä¿®å¤ï¼‰

### 4. ç¼ºå°‘å•å…ƒæµ‹è¯•

**å½“å‰çŠ¶æ€**: 0% æµ‹è¯•è¦†ç›–ç‡

**å»ºè®®ç»“æ„**:
```
backend/tests/
â”œâ”€â”€ conftest.py              # pytesté…ç½®å’Œfixtures
â”œâ”€â”€ test_auth.py             # è®¤è¯æµ‹è¯•
â”œâ”€â”€ test_videos.py           # è§†é¢‘APIæµ‹è¯•
â”œâ”€â”€ test_comments.py         # è¯„è®ºAPIæµ‹è¯•
â”œâ”€â”€ test_payments.py         # æ”¯ä»˜æµ‹è¯•
â””â”€â”€ test_notifications.py    # é€šçŸ¥æµ‹è¯•
```

**ç¤ºä¾‹æµ‹è¯•**:
```python
# tests/conftest.py
import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from app.main import app
from app.core.database import get_db

@pytest.fixture
async def test_db():
    """æµ‹è¯•æ•°æ®åº“"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    async with AsyncSession(engine) as session:
        yield session

@pytest.fixture
async def client(test_db):
    """æµ‹è¯•å®¢æˆ·ç«¯"""
    app.dependency_overrides[get_db] = lambda: test_db
    async with AsyncClient(app=app, base_url="http://test") as ac:
        yield ac

# tests/test_comments.py
@pytest.mark.asyncio
async def test_list_video_comments(client, test_db):
    """æµ‹è¯•è·å–è§†é¢‘è¯„è®ºåˆ—è¡¨"""
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    video = Video(title="æµ‹è¯•è§†é¢‘", ...)
    test_db.add(video)
    await test_db.commit()
    
    # å‘é€è¯·æ±‚
    response = await client.get(f"/api/v1/comments/video/{video.id}")
    
    # éªŒè¯å“åº”
    assert response.status_code == 200
    data = response.json()
    assert "items" in data
    assert "total" in data
```

---

### 5. ç¼“å­˜ç­–ç•¥ä¸å®Œæ•´

**é—®é¢˜ä½ç½®**: `backend/app/services/cache_service.py`

**å½“å‰é—®é¢˜**: å®šä¹‰äº†ç¼“å­˜é”®ä½†ä½¿ç”¨ä¸å¹¿æ³›

**å»ºè®®æ·»åŠ ç¼“å­˜çš„API**:
| API | ç¼“å­˜é”® | TTL | è¯´æ˜ |
|-----|--------|-----|------|
| è§†é¢‘åˆ—è¡¨ | `video:list:{category}:{page}` | 5åˆ†é’Ÿ | åˆ†ç±»è§†é¢‘åˆ—è¡¨ |
| è§†é¢‘è¯¦æƒ… | `video:detail:{id}` | 10åˆ†é’Ÿ | è§†é¢‘è¯¦æƒ… |
| ç”¨æˆ·VIPä¿¡æ¯ | `user:vip:{id}` | 5åˆ†é’Ÿ | VIPçŠ¶æ€ |
| çƒ­é—¨æ ‡ç­¾ | `tags:hot` | 30åˆ†é’Ÿ | çƒ­é—¨æ ‡ç­¾ |
| ç³»ç»Ÿé…ç½® | `config:{key}` | 1å°æ—¶ | ç³»ç»Ÿé…ç½® |

---

### 6. å®¡è®¡æ—¥å¿—

**å»ºè®®æ·»åŠ **:
```python
# backend/app/models/audit_log.py
class AuditLog(Base):
    __tablename__ = "audit_logs"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    action = Column(String(50))  # login, logout, purchase, upload, delete
    resource_type = Column(String(50))  # video, comment, user
    resource_id = Column(Integer)
    ip_address = Column(String(50))
    user_agent = Column(String(500))
    details = Column(JSON)
    created_at = Column(DateTime, default=datetime.utcnow)

# ä½¿ç”¨è£…é¥°å™¨è®°å½•å®¡è®¡æ—¥å¿—
def audit_log(action: str, resource_type: str):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            result = await func(*args, **kwargs)
            # è®°å½•æ—¥å¿—
            await log_action(action, resource_type, ...)
            return result
        return wrapper
    return decorator
```

---

### 7. Dockerå¥åº·æ£€æŸ¥

**æ–‡ä»¶**: `docker-compose.yml`

**ä¼˜åŒ–**:
```yaml
services:
  backend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
  redis:
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    
  postgres:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U video_app"]
      interval: 10s
      timeout: 5s
      retries: 3
```

---

## âœ… ç¬¬ä¸‰é˜¶æ®µå·²å®Œæˆä¼˜åŒ–

### 1. âœ… å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

**æ–‡ä»¶**: 
- `backend/app/models/audit_log.py` - å®¡è®¡æ—¥å¿—æ¨¡å‹
- `backend/app/services/audit_service.py` - å®¡è®¡æ—¥å¿—æœåŠ¡
- `backend/alembic/versions/20260113_add_audit_logs.py` - æ•°æ®åº“è¿ç§»

**åŠŸèƒ½**:
- è®°å½•ç”¨æˆ·ç™»å½•/ç™»å‡º
- è®°å½•æ”¯ä»˜/VIPè´­ä¹°
- è®°å½•è§†é¢‘/è¯„è®ºæ“ä½œ
- è®°å½•ç®¡ç†å‘˜æ“ä½œ
- æ”¯æŒè£…é¥°å™¨æ–¹å¼è‡ªåŠ¨è®°å½•

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.services.audit_service import AuditService, AuditAction

# è®°å½•ç™»å½•
await AuditService.log_login(db, user_id, username, ip, user_agent)

# è®°å½•æ”¯ä»˜
await AuditService.log_payment(db, user_id, order_id, amount, "alipay")

# ä½¿ç”¨è£…é¥°å™¨
@audit_log(AuditAction.VIDEO_DELETE, "video")
async def delete_video(video_id: int, db: AsyncSession, current_user: User):
    ...
```

---

### 2. âœ… ç¼“å­˜ç­–ç•¥å®Œå–„

**æ–‡ä»¶**: `backend/app/services/cache_service.py`

**æ–°å¢åŠŸèƒ½**:
- `cache_aside` è£…é¥°å™¨ - æ”¯æŒå¼ºåˆ¶åˆ·æ–°ã€è·³è¿‡None
- `CacheInvalidator` - ç¼“å­˜å¤±æ•ˆç®¡ç†å™¨
- `CacheWarmer` - ç¼“å­˜é¢„çƒ­å™¨

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.services.cache_service import cache_aside, CacheInvalidator, CacheWarmer

# ä½¿ç”¨è£…é¥°å™¨
@cache_aside("user:vip:{user_id}", ttl=300)
async def get_user_vip(user_id: int):
    ...

# å¤±æ•ˆç¼“å­˜
await CacheInvalidator.invalidate_video(video_id)
await CacheInvalidator.invalidate_user(user_id)

# é¢„çƒ­ç¼“å­˜
await CacheWarmer.warm_categories(db)
await CacheWarmer.warm_home_data(db)
```

---

### 3. âœ… Dockeré…ç½®ä¼˜åŒ–

**æ–‡ä»¶**: `docker-compose.yml`

**ä¼˜åŒ–å†…å®¹**:
- æ‰€æœ‰æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥
- æ·»åŠ èµ„æºé™åˆ¶ï¼ˆCPU/å†…å­˜ï¼‰
- é…ç½®é‡å¯ç­–ç•¥
- æœåŠ¡ä¾èµ–ä½¿ç”¨ `condition: service_healthy`

---

### 4. âœ… å…¬å…±æœåŠ¡å±‚æå–

**æ–‡ä»¶**: `backend/app/services/comment_service.py`

**æå–çš„å…¬å…±æ–¹æ³•**:
- `batch_get_user_vip_levels()` - æ‰¹é‡è·å–VIPç­‰çº§
- `batch_get_liked_comment_ids()` - æ‰¹é‡è·å–ç‚¹èµçŠ¶æ€
- `build_comment_response()` - æ„å»ºè¯„è®ºå“åº”
- `build_comment_dict()` - æ„å»ºè¯„è®ºå­—å…¸ï¼ˆç®¡ç†åå°ï¼‰
- `get_video_comments()` - è·å–è§†é¢‘è¯„è®ºï¼ˆä¼˜åŒ–ç‰ˆï¼‰
- `toggle_like()` - åˆ‡æ¢ç‚¹èµçŠ¶æ€
- `soft_delete_comment()` - è½¯åˆ é™¤è¯„è®º

---

## ğŸŸ¢ ç¬¬å››é˜¶æ®µä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä¸¤å‘¨åï¼‰

### 8. âœ… è½¯åˆ é™¤æœºåˆ¶

**æ–‡ä»¶**: 
- `backend/app/models/mixins.py` - æ··å…¥ç±»å®šä¹‰
- `backend/alembic/versions/20260113_add_soft_delete.py` - æ•°æ®åº“è¿ç§»

**åŠŸèƒ½**:
- `SoftDeleteMixin` - è½¯åˆ é™¤æ··å…¥ç±»
- `TimestampMixin` - æ—¶é—´æˆ³æ··å…¥ç±»
- `AuditMixin` - å®¡è®¡æ··å…¥ç±»ï¼ˆç»„åˆè½¯åˆ é™¤+æ—¶é—´æˆ³+åˆ›å»ºè€…è¿½è¸ªï¼‰

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from app.models.mixins import SoftDeleteMixin

class Video(Base, SoftDeleteMixin):
    __tablename__ = "videos"
    # ...

# è½¯åˆ é™¤
video.soft_delete(user_id=current_user.id)

# æ¢å¤
video.restore()

# æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤
query = select(Video).where(Video.is_deleted == False)
```

---

### 9. âœ… Celeryå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

**æ–‡ä»¶**:
- `backend/app/core/celery_app.py` - Celeryé…ç½®
- `backend/app/tasks/video_tasks.py` - è§†é¢‘å¤„ç†ä»»åŠ¡
- `backend/app/tasks/notification_tasks.py` - é€šçŸ¥ä»»åŠ¡
- `backend/app/tasks/cleanup_tasks.py` - æ¸…ç†ä»»åŠ¡

**ä»»åŠ¡åˆ—è¡¨**:
- `process_video_task` - è§†é¢‘è½¬ç 
- `generate_thumbnail_task` - ç”Ÿæˆç¼©ç•¥å›¾
- `extract_video_info_task` - æå–è§†é¢‘ä¿¡æ¯
- `send_push_notification_task` - å‘é€æ¨é€é€šçŸ¥
- `check_vip_expiry` - VIPè¿‡æœŸæ£€æŸ¥
- `cleanup_expired_orders` - æ¸…ç†è¿‡æœŸè®¢å•
- `cleanup_temp_files` - æ¸…ç†ä¸´æ—¶æ–‡ä»¶

**å¯åŠ¨å‘½ä»¤**:
```bash
# Worker
celery -A app.core.celery_app worker --loglevel=info

# Beat (å®šæ—¶ä»»åŠ¡)
celery -A app.core.celery_app beat --loglevel=info
```

---

### 10. âœ… æ€§èƒ½ç›‘æ§é›†æˆ

**æ–‡ä»¶**:
- `backend/app/services/monitoring_service.py` - ç›‘æ§æœåŠ¡
- `backend/app/api/monitoring.py` - ç›‘æ§API

**åŠŸèƒ½**:
- ç³»ç»Ÿèµ„æºç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- è¯·æ±‚æ€§èƒ½ç»Ÿè®¡
- æ…¢è¯·æ±‚è¿½è¸ª
- ç«¯ç‚¹æ€§èƒ½æ’è¡Œ
- æ•°æ®åº“ç»Ÿè®¡

**APIç«¯ç‚¹**:
- `GET /api/v1/admin/monitoring/health` - å¥åº·æ£€æŸ¥
- `GET /api/v1/admin/monitoring/metrics` - å®Œæ•´æŒ‡æ ‡
- `GET /api/v1/admin/monitoring/system` - ç³»ç»Ÿèµ„æº
- `GET /api/v1/admin/monitoring/slow-requests` - æ…¢è¯·æ±‚

---

### 11. âœ… é¡¹ç›®æ–‡æ¡£

**æ–‡ä»¶**:
- `docs/API.md` - APIæ¥å£æ–‡æ¡£
- `docs/DEPLOYMENT.md` - éƒ¨ç½²æŒ‡å—
- `docs/DEVELOPMENT.md` - å¼€å‘æŒ‡å—

---

### 12. ä»£ç é‡å¤æå–

**é—®é¢˜**: `comments.py` å’Œ `admin_unified_comments.py` æœ‰é‡å¤ä»£ç 

**å»ºè®®**: æå–å…¬å…±é€»è¾‘åˆ° `CommentService`

```python
# backend/app/services/comment_service.py
class CommentService:
    @staticmethod
    async def get_comments_with_users(
        db: AsyncSession,
        video_id: int = None,
        post_id: int = None,
        page: int = 1,
        page_size: int = 20
    ):
        """è·å–è¯„è®ºåˆ—è¡¨ï¼ˆå¸¦ç”¨æˆ·ä¿¡æ¯ï¼‰"""
        # å…¬å…±æŸ¥è¯¢é€»è¾‘
        pass
    
    @staticmethod
    async def build_comment_response(comment, user, vip_level, is_liked):
        """æ„å»ºè¯„è®ºå“åº”"""
        pass
```

---

### 9. è½¯åˆ é™¤æœºåˆ¶

**å»ºè®®**: ä¸ºå…³é”®è¡¨æ·»åŠ è½¯åˆ é™¤

```python
# backend/app/models/mixins.py
class SoftDeleteMixin:
    is_deleted = Column(Boolean, default=False, index=True)
    deleted_at = Column(DateTime, nullable=True)
    deleted_by = Column(Integer, nullable=True)
    
    def soft_delete(self, user_id: int = None):
        self.is_deleted = True
        self.deleted_at = datetime.utcnow()
        self.deleted_by = user_id

# ä½¿ç”¨
class Video(Base, SoftDeleteMixin):
    __tablename__ = "videos"
    # ...
```

---

### 10. Celeryå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—

**å»ºè®®**: å°†è§†é¢‘å¤„ç†æ”¹ä¸ºCeleryä»»åŠ¡

```python
# backend/app/tasks/video_tasks.py
from celery import Celery

celery_app = Celery('video_app')

@celery_app.task(bind=True, max_retries=3)
def process_video_task(self, video_id: int, file_path: str):
    """å¼‚æ­¥å¤„ç†è§†é¢‘"""
    try:
        # è½¬ç é€»è¾‘
        pass
    except Exception as e:
        self.retry(exc=e, countdown=60)
```

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰

1. âœ… main.py å¯åŠ¨ä¼˜åŒ– - ç§»é™¤å¯åŠ¨æ—¶æ•°æ®åˆå§‹åŒ–
2. âœ… CORS é…ç½® - ä» `*` æ”¹ä¸ºå…·ä½“åŸŸå
3. âœ… é™æµä¸­é—´ä»¶ - æ·»åŠ å…¨å±€APIé™æµ
4. âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç† - åˆ›å»º exceptions.py
5. âœ… å‰ç«¯å›¾ç‰‡æ‡’åŠ è½½ - æ·»åŠ  lazyLoad æŒ‡ä»¤
6. âœ… è·¯ç”±å¸¸é‡æå– - åˆ›å»º routes.js
7. âœ… ç¼“å­˜ delete_pattern - å®ç° SCAN + DEL
8. âœ… æ ¹ç›®å½•è„šæœ¬æ•´ç† - ç§»åŠ¨åˆ° scripts/ ç›®å½•
9. âœ… æ—§æœåŠ¡å™¨ä¿¡æ¯æ¸…ç† - åˆ é™¤æ—§IPå’ŒåŸŸåå¼•ç”¨
10. âœ… è¯„è®ºAPI N+1æŸ¥è¯¢ä¿®å¤ - ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
11. âœ… Commentè¡¨ç´¢å¼• - æ·»åŠ å¤åˆç´¢å¼•
12. âœ… JWTä»¤ç‰Œé»‘åå• - Rediså®ç°
13. âœ… å®‰å…¨å“åº”å¤´ - æ·»åŠ XSS/CSRFé˜²æŠ¤
14. âœ… å‰ç«¯APIé…ç½®ä¼˜åŒ– - ç§»é™¤ç¡¬ç¼–ç IP
15. âœ… è¯·æ±‚å»é‡æœºåˆ¶ - AbortControllerå®ç°
16. âœ… è§†é¢‘å¤„ç†å¹¶å‘æ§åˆ¶ - Semaphoreé™åˆ¶
17. âœ… Backendè„šæœ¬æ•´ç† - åˆ†ç±»åˆ°å­ç›®å½•

---

## ğŸ“‹ ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆå·²å®Œæˆ âœ…ï¼‰
- [x] ä¿®å¤è¯„è®ºAPIçš„N+1æŸ¥è¯¢
- [x] æ·»åŠ Commentè¡¨ç´¢å¼•
- [x] å®ç°JWTä»¤ç‰Œé»‘åå•
- [x] æ•´ç†backendç›®å½•è„šæœ¬
- [x] æ·»åŠ å®‰å…¨å“åº”å¤´
- [x] ä¼˜åŒ–å‰ç«¯APIé…ç½®
- [x] æ·»åŠ è§†é¢‘å¤„ç†å¹¶å‘æ§åˆ¶

### ç¬¬äºŒé˜¶æ®µï¼ˆæœ¬å‘¨ï¼‰âœ…
- [x] ä¿®å¤é€šçŸ¥APIçš„N+1æŸ¥è¯¢
- [x] æ‹†åˆ†VideoPlayer.vueç»„ä»¶
- [x] å®Œå–„æ”¯ä»˜æœåŠ¡çŠ¶æ€æœº
- [x] æ·»åŠ åŸºç¡€å•å…ƒæµ‹è¯•

### ç¬¬ä¸‰é˜¶æ®µï¼ˆä¸‹å‘¨ï¼‰âœ…
- [x] å®Œå–„ç¼“å­˜ç­–ç•¥ - æ·»åŠ  cache_aside è£…é¥°å™¨ã€CacheInvalidatorã€CacheWarmer
- [x] æ·»åŠ å®¡è®¡æ—¥å¿— - AuditLog æ¨¡å‹ + AuditService + è¿ç§»æ–‡ä»¶
- [x] Dockeré…ç½®ä¼˜åŒ– - å¥åº·æ£€æŸ¥ã€èµ„æºé™åˆ¶ã€é‡å¯ç­–ç•¥
- [x] æå–å…¬å…±æœåŠ¡å±‚ - CommentService å…¬å…±è¯„è®ºæœåŠ¡

### ç¬¬å››é˜¶æ®µï¼ˆä¸¤å‘¨åï¼‰âœ…
- [x] å®ç°è½¯åˆ é™¤æœºåˆ¶ - SoftDeleteMixin + æ•°æ®åº“è¿ç§»
- [x] Celeryå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— - è§†é¢‘å¤„ç†ã€é€šçŸ¥ã€æ¸…ç†ä»»åŠ¡
- [x] æ€§èƒ½ç›‘æ§é›†æˆ - PerformanceMonitor + ç›‘æ§API
- [x] æ–‡æ¡£å®Œå–„ - API.mdã€DEPLOYMENT.mdã€DEVELOPMENT.md

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ | é¢„æœŸæ•ˆæœ | çŠ¶æ€ |
|--------|---------|------|
| N+1æŸ¥è¯¢ä¿®å¤ | è¯„è®ºåˆ—è¡¨å“åº”æ—¶é—´ -80% | âœ… å®Œæˆ |
| æ•°æ®åº“ç´¢å¼• | æŸ¥è¯¢æ€§èƒ½ +50% | âœ… å®Œæˆ |
| ä»¤ç‰Œé»‘åå• | å®‰å…¨æ€§æå‡ | âœ… å®Œæˆ |
| å®‰å…¨å“åº”å¤´ | é˜²XSS/CSRFæ”»å‡» | âœ… å®Œæˆ |
| é€šçŸ¥APIä¼˜åŒ– | é€šçŸ¥åˆ—è¡¨å“åº”æ—¶é—´ -70% | âœ… å®Œæˆ |
| ç»„ä»¶æ‹†åˆ† | å‰ç«¯å¯ç»´æŠ¤æ€§æå‡ | âœ… å®Œæˆ |
| æ”¯ä»˜çŠ¶æ€æœº | è®¢å•ç®¡ç†è§„èŒƒåŒ– | âœ… å®Œæˆ |
| å•å…ƒæµ‹è¯• | ä»£ç è´¨é‡ä¿éšœ | âœ… åŸºç¡€æ¡†æ¶ |
| å®¡è®¡æ—¥å¿— | æ“ä½œå¯è¿½æº¯ | âœ… å®Œæˆ |
| ç¼“å­˜å®Œå–„ | æ•°æ®åº“è´Ÿè½½ -60% | âœ… å®Œæˆ |
| Dockerä¼˜åŒ– | æœåŠ¡ç¨³å®šæ€§æå‡ | âœ… å®Œæˆ |
| å…¬å…±æœåŠ¡å±‚ | ä»£ç å¤ç”¨ç‡æå‡ | âœ… å®Œæˆ |
| è½¯åˆ é™¤æœºåˆ¶ | æ•°æ®å®‰å…¨æ€§æå‡ | âœ… å®Œæˆ |
| Celeryä»»åŠ¡ | å¼‚æ­¥å¤„ç†èƒ½åŠ› | âœ… å®Œæˆ |
| æ€§èƒ½ç›‘æ§ | é—®é¢˜å¿«é€Ÿå®šä½ | âœ… å®Œæˆ |
| é¡¹ç›®æ–‡æ¡£ | å¼€å‘æ•ˆç‡æå‡ | âœ… å®Œæˆ |

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# æœåŠ¡å™¨SSH
ssh -i server_key_new root@38.47.218.137

# æ›´æ–°ä»£ç å¹¶é‡å¯
cd /www/wwwroot/video-app && git pull origin main
systemctl restart video-app-backend

# è¿è¡Œè¿ç§»
cd /www/wwwroot/video-app/backend && source venv/bin/activate && alembic upgrade head

# æŸ¥çœ‹æ—¥å¿—
journalctl -u video-app-backend -f
```
