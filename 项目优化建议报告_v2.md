# è§†é¢‘åº”ç”¨é¡¹ç›®æ·±åº¦ä¼˜åŒ–å»ºè®®æŠ¥å‘Š v2

> åˆ†ææ—¥æœŸï¼š2026å¹´1æœˆ13æ—¥
> åˆ†æèŒƒå›´ï¼šåç«¯æ¶æ„ã€å‰ç«¯æ¶æ„ã€æ•°æ®åº“ã€å®‰å…¨ã€æ€§èƒ½ã€ä»£ç è´¨é‡

---

## ğŸ“Š é¡¹ç›®ç°çŠ¶è¯„ä¼°

| ç»´åº¦ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ | N+1é—®é¢˜ä¸¥é‡ | æ‰¹é‡æŸ¥è¯¢ | ğŸ”´ é«˜ |
| æµ‹è¯•è¦†ç›–ç‡ | 0% | 80% | ğŸ”´ é«˜ |
| ç¼“å­˜åˆ©ç”¨ç‡ | 30% | 90% | ğŸŸ¡ ä¸­ |
| ä»£ç é‡å¤ç‡ | 15% | <5% | ğŸŸ¡ ä¸­ |
| å®‰å…¨é…ç½® | åŸºç¡€ | å®Œå–„ | ğŸ”´ é«˜ |
| æ ¹ç›®å½•è„šæœ¬ | 60+æ–‡ä»¶ | å·²æ•´ç† | âœ… å®Œæˆ |

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆç«‹å³ä¿®å¤ï¼‰

### 1. è¯„è®ºAPIçš„N+1æŸ¥è¯¢é—®é¢˜

**é—®é¢˜ä½ç½®**: `backend/app/api/comments.py` - `list_video_comments()`

**å½“å‰é—®é¢˜**:
```python
# æ¯æ¡è¯„è®ºéƒ½å•ç‹¬æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆç¬¬200-210è¡Œï¼‰
for comment in comments:
    user_result = await db.execute(select(User).where(User.id == comment.user_id))
    user = user_result.scalar_one()
    
    # æ¯æ¡è¯„è®ºéƒ½å•ç‹¬æŸ¥è¯¢VIPç­‰çº§
    user_vip_level = await get_user_vip_level(db, comment.user_id)
    
    # æ¯æ¡è¯„è®ºéƒ½å•ç‹¬æŸ¥è¯¢ç‚¹èµçŠ¶æ€
    like_result = await db.execute(...)
```

**å½±å“**: 20æ¡è¯„è®º = 60+ æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸¥é‡å½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
from sqlalchemy.orm import selectinload

# 1. ä½¿ç”¨ selectinload é¢„åŠ è½½ç”¨æˆ·å…³ç³»
query = select(Comment).where(...).options(
    selectinload(Comment.user)
)

# 2. æ‰¹é‡æŸ¥è¯¢VIPä¿¡æ¯
user_ids = [c.user_id for c in comments]
vip_result = await db.execute(
    select(UserVIP).where(UserVIP.user_id.in_(user_ids))
)
vip_map = {v.user_id: v for v in vip_result.scalars().all()}

# 3. æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€
if current_user:
    comment_ids = [c.id for c in comments]
    likes_result = await db.execute(
        select(CommentLike.comment_id).where(
            CommentLike.comment_id.in_(comment_ids),
            CommentLike.user_id == current_user.id
        )
    )
    liked_ids = set(r[0] for r in likes_result.all())
```

---

### 2. ç¼ºå°‘æ•°æ®åº“ç´¢å¼•

**é—®é¢˜ä½ç½®**: `backend/app/models/comment.py`

**å½“å‰é—®é¢˜**: Commentè¡¨ç¼ºå°‘å…³é”®ç´¢å¼•

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
class Comment(Base):
    __tablename__ = "comments"
    __table_args__ = (
        Index('idx_comment_video_created', 'video_id', 'created_at'),
        Index('idx_comment_user_created', 'user_id', 'created_at'),
        Index('idx_comment_parent_id', 'parent_id'),
        Index('idx_comment_video_hidden', 'video_id', 'is_hidden'),
    )
```

**åˆ›å»ºè¿ç§»**:
```bash
alembic revision -m "add_comment_indexes"
```

---

### 3. JWTä»¤ç‰Œç¼ºå°‘é»‘åå•æœºåˆ¶

**é—®é¢˜ä½ç½®**: `backend/app/core/security.py`

**å½“å‰é—®é¢˜**: ç”¨æˆ·ç™»å‡ºåï¼Œæ—§ä»¤ç‰Œä»ç„¶æœ‰æ•ˆ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# backend/app/core/token_blacklist.py
from app.core.redis import RedisCache

class TokenBlacklist:
    PREFIX = "token_blacklist:"
    
    @staticmethod
    async def add(token: str, ttl: int):
        """å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•"""
        await RedisCache.set(f"{TokenBlacklist.PREFIX}{token}", "1", ttl)
    
    @staticmethod
    async def is_blacklisted(token: str) -> bool:
        """æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­"""
        result = await RedisCache.get(f"{TokenBlacklist.PREFIX}{token}")
        return result is not None

# åœ¨ deps.py ä¸­ä½¿ç”¨
async def get_current_user(credentials, db):
    token = credentials.credentials
    
    # æ£€æŸ¥é»‘åå•
    if await TokenBlacklist.is_blacklisted(token):
        raise HTTPException(status_code=401, detail="ä»¤ç‰Œå·²å¤±æ•ˆ")
    
    # ç»§ç»­éªŒè¯...
```

---

### 4. æ ¹ç›®å½•è„šæœ¬æ–‡ä»¶è¿‡å¤šï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

**å½“å‰çŠ¶æ€**: backendç›®å½•ä»æœ‰60+ä¸ªè„šæœ¬æ–‡ä»¶

**å·²å®Œæˆ**: æ ¹ç›®å½•è„šæœ¬å·²ç§»åŠ¨åˆ° `scripts/` ç›®å½•

**å¾…å®Œæˆ**: backendç›®å½•ä¸‹çš„è„šæœ¬éœ€è¦æ•´ç†

**å»ºè®®ç»“æ„**:
```
backend/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ migrations/     # æ•°æ®è¿ç§»è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ migrate_to_postgres.py
â”‚   â”‚   â”œâ”€â”€ migrate_to_mysql.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ maintenance/    # ç»´æŠ¤è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ check_tables.py
â”‚   â”‚   â”œâ”€â”€ fix_admin_role.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ setup/          # åˆå§‹åŒ–è„šæœ¬
â”‚       â”œâ”€â”€ create_admin.py
â”‚       â”œâ”€â”€ create_categories.py
â”‚       â””â”€â”€ ...
```

---

### 5. ç¼ºå°‘å•å…ƒæµ‹è¯•

**å½“å‰çŠ¶æ€**: å®Œå…¨æ²¡æœ‰æµ‹è¯•

**å»ºè®®ç»“æ„**:
```
backend/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py          # pytesté…ç½®
â”‚   â”œâ”€â”€ test_auth.py         # è®¤è¯æµ‹è¯•
â”‚   â”œâ”€â”€ test_videos.py       # è§†é¢‘APIæµ‹è¯•
â”‚   â”œâ”€â”€ test_comments.py     # è¯„è®ºAPIæµ‹è¯•
â”‚   â””â”€â”€ test_payments.py     # æ”¯ä»˜æµ‹è¯•
```

**ç¤ºä¾‹æµ‹è¯•**:
```python
# tests/conftest.py
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.fixture
async def client():
    async with AsyncClient(app=app, base_url="http://test") as ac:
        yield ac

# tests/test_auth.py
@pytest.mark.asyncio
async def test_guest_register(client):
    response = await client.post("/api/v1/auth/guest/register", json={
        "device_id": "test-device-123"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()
```

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆæœ¬å‘¨ä¿®å¤ï¼‰

### 6. ç¼“å­˜ç­–ç•¥ä¸å®Œæ•´

**é—®é¢˜ä½ç½®**: `backend/app/services/cache_service.py`

**å½“å‰é—®é¢˜**: å®šä¹‰äº†ç¼“å­˜é”®ä½†ä½¿ç”¨ä¸å¹¿æ³›

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# åœ¨è§†é¢‘åˆ—è¡¨APIä¸­ä½¿ç”¨ç¼“å­˜
@router.get("")
async def list_videos(...):
    cache_key = CacheKeys.VIDEO_LIST.format(
        category=category_id or "all",
        page=page,
        size=page_size,
        sort=sort_by or "created_at"
    )
    
    # å°è¯•ä»ç¼“å­˜è·å–
    cached = await CacheService.get(cache_key)
    if cached:
        return cached
    
    # æŸ¥è¯¢æ•°æ®åº“
    result = await query_videos(...)
    
    # å†™å…¥ç¼“å­˜
    await CacheService.set(cache_key, result, CacheTTL.MEDIUM)
    return result
```

---

### 7. è§†é¢‘å¤„ç†ç¼ºå°‘å¹¶å‘æ§åˆ¶

**é—®é¢˜ä½ç½®**: `backend/app/services/video_processor.py`

**å½“å‰é—®é¢˜**: æ²¡æœ‰é™åˆ¶å¹¶å‘è½¬ç æ•°é‡

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
import asyncio

class VideoProcessor:
    _semaphore = asyncio.Semaphore(2)  # æœ€å¤š2ä¸ªå¹¶å‘è½¬ç 
    
    @classmethod
    async def process_video(cls, video_id: int, file_path: str):
        async with cls._semaphore:
            # æ‰§è¡Œè½¬ç 
            await cls._do_process(video_id, file_path)
```

---

### 8. å‰ç«¯APIåŸºç¡€URLé…ç½®å¤æ‚

**é—®é¢˜ä½ç½®**: `frontend/src/utils/api.js`

**å½“å‰é—®é¢˜**: ç¡¬ç¼–ç æœåŠ¡å™¨IP

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```javascript
// ä½¿ç”¨ç¯å¢ƒå˜é‡
const getBaseURL = () => {
  // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡
  if (import.meta.env.VITE_API_URL) {
    return import.meta.env.VITE_API_URL
  }
  // é»˜è®¤ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆä¾èµ–Nginxåå‘ä»£ç†ï¼‰
  return '/api/v1'
}

// .env.production
VITE_API_URL=/api/v1

// .env.development
VITE_API_URL=http://localhost:8001/api/v1
```

---

### 9. ç¼ºå°‘è¯·æ±‚å»é‡

**é—®é¢˜ä½ç½®**: `frontend/src/utils/api.js`

**å½“å‰é—®é¢˜**: å¿«é€Ÿç‚¹å‡»ä¼šå‘é€é‡å¤è¯·æ±‚

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```javascript
const pendingRequests = new Map()

api.interceptors.request.use(config => {
  // ç”Ÿæˆè¯·æ±‚å”¯ä¸€é”®
  const key = `${config.method}:${config.url}:${JSON.stringify(config.data || {})}`
  
  // å¦‚æœæœ‰ç›¸åŒè¯·æ±‚æ­£åœ¨è¿›è¡Œï¼Œå–æ¶ˆå½“å‰è¯·æ±‚
  if (pendingRequests.has(key)) {
    const controller = pendingRequests.get(key)
    controller.abort()
  }
  
  // åˆ›å»ºæ–°çš„AbortController
  const controller = new AbortController()
  pendingRequests.set(key, controller)
  config.signal = controller.signal
  
  return config
})

api.interceptors.response.use(
  response => {
    // è¯·æ±‚å®Œæˆï¼Œç§»é™¤pending
    const key = `${response.config.method}:${response.config.url}:${JSON.stringify(response.config.data || {})}`
    pendingRequests.delete(key)
    return response
  },
  error => {
    // é”™è¯¯æ—¶ä¹Ÿç§»é™¤
    if (error.config) {
      const key = `${error.config.method}:${error.config.url}:${JSON.stringify(error.config.data || {})}`
      pendingRequests.delete(key)
    }
    return Promise.reject(error)
  }
)
```

---

### 10. ç¼ºå°‘å®‰å…¨å“åº”å¤´

**é—®é¢˜ä½ç½®**: `backend/app/main.py`

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    
    # å®‰å…¨å“åº”å¤´
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
    # ç”Ÿäº§ç¯å¢ƒå¯ç”¨HSTS
    if settings.ENVIRONMENT == "production":
        response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"
    
    return response
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä¸‹å‘¨ä¿®å¤ï¼‰

### 11. ä»£ç é‡å¤

**é—®é¢˜**: `comments.py` å’Œ `admin_unified_comments.py` æœ‰é‡å¤ä»£ç 

**å»ºè®®**: æå–å…¬å…±é€»è¾‘åˆ° `CommentService`

---

### 12. ç¼ºå°‘å®¡è®¡æ—¥å¿—

**å»ºè®®**: æ·»åŠ  `AuditLog` è¡¨è®°å½•å…³é”®æ“ä½œ

---

### 13. Dockeré…ç½®ç¼ºå°‘å¥åº·æ£€æŸ¥

**ä¼˜åŒ–**:
```yaml
backend:
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
    interval: 30s
    timeout: 10s
    retries: 3
```

---

### 14. ç¼ºå°‘è½¯åˆ é™¤æœºåˆ¶

**å»ºè®®**: ä¸ºå…³é”®è¡¨æ·»åŠ  `is_deleted` å’Œ `deleted_at` å­—æ®µ

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

1. âœ… main.py å¯åŠ¨ä¼˜åŒ– - ç§»é™¤å¯åŠ¨æ—¶æ•°æ®åˆå§‹åŒ–
2. âœ… CORS é…ç½® - ä» `*` æ”¹ä¸ºå…·ä½“åŸŸå
3. âœ… é™æµä¸­é—´ä»¶ - æ·»åŠ å…¨å±€APIé™æµ
4. âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç† - åˆ›å»º exceptions.py
5. âœ… å‰ç«¯å›¾ç‰‡æ‡’åŠ è½½ - æ·»åŠ  lazyLoad æŒ‡ä»¤
6. âœ… è·¯ç”±å¸¸é‡æå– - åˆ›å»º routes.js
7. âœ… ç¼“å­˜ delete_pattern - å®ç° SCAN + DEL
8. âœ… æ ¹ç›®å½•è„šæœ¬æ•´ç† - ç§»åŠ¨åˆ° scripts/ ç›®å½•
9. âœ… æ—§æœåŠ¡å™¨ä¿¡æ¯æ¸…ç† - åˆ é™¤æ—§IPå’ŒåŸŸåå¼•ç”¨

---

## ğŸ“‹ ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆæœ¬å‘¨ï¼‰
- [ ] ä¿®å¤è¯„è®ºAPIçš„N+1æŸ¥è¯¢
- [ ] æ·»åŠ Commentè¡¨ç´¢å¼•
- [ ] å®ç°JWTä»¤ç‰Œé»‘åå•
- [ ] æ•´ç†backendç›®å½•è„šæœ¬

### ç¬¬äºŒé˜¶æ®µï¼ˆä¸‹å‘¨ï¼‰
- [ ] å®Œå–„ç¼“å­˜ç­–ç•¥
- [ ] æ·»åŠ è§†é¢‘å¤„ç†å¹¶å‘æ§åˆ¶
- [ ] ä¼˜åŒ–å‰ç«¯APIé…ç½®
- [ ] æ·»åŠ å®‰å…¨å“åº”å¤´

### ç¬¬ä¸‰é˜¶æ®µï¼ˆä¸¤å‘¨åï¼‰
- [ ] æ·»åŠ åŸºç¡€å•å…ƒæµ‹è¯•
- [ ] æå–å…¬å…±æœåŠ¡å±‚
- [ ] æ·»åŠ å®¡è®¡æ—¥å¿—
- [ ] Dockeré…ç½®ä¼˜åŒ–

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ | é¢„æœŸæ•ˆæœ |
|--------|---------|
| N+1æŸ¥è¯¢ä¿®å¤ | è¯„è®ºåˆ—è¡¨å“åº”æ—¶é—´ -80% |
| æ•°æ®åº“ç´¢å¼• | æŸ¥è¯¢æ€§èƒ½ +50% |
| ç¼“å­˜å®Œå–„ | æ•°æ®åº“è´Ÿè½½ -60% |
| ä»¤ç‰Œé»‘åå• | å®‰å…¨æ€§æå‡ |
| å•å…ƒæµ‹è¯• | ä»£ç è´¨é‡ä¿éšœ |
