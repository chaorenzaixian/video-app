/* empty css             *//* empty css                   *//* empty css                  *//* empty css                    *//* empty css               *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                  *//* empty css                 *//* empty css                        *//* empty css                *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  */import{_ as e,a as l}from"./index-C3P4JTuA.js";import{E as a,be as t,bk as o,bh as i,bi as r,bj as s,aM as u,aQ as d,bn as n,bo as c,bs as p,bt as m,bl as g,bm as f,aT as v,aR as _,aS as y,bv as h,bc as b,bd as w,bw as V,a as j}from"./element-plus-DlIn_qXi.js";import{r as k,l as U,c as C,j as z,y as x,O as $,F as O,ai as R,z as S,K as L,L as M,C as q,G as E,E as G,M as P,aa as W}from"./vue-vendor-Ba_vealp.js";import"./utils-DflAyOWx.js";const A={class:"gallery-manage"},B={class:"card-header"},F={class:"card-header"},I={class:"filters"},K={class:"cover-upload"},Q={key:1,class:"cover-placeholder"},H={class:"cover-url-input"},J={class:"images-upload-area"},N={class:"images-url-input"},T={class:"images-count"},D=e({__name:"GalleryManage",setup(e){const D=k(!1),X=k(!1),Y=k([]),Z=k([]),ee=U({page:1,pageSize:20,total:0}),le=U({category_id:null,keyword:""}),ae=k(!1),te=U({id:null,name:"",sort_order:0}),oe=k(!1),ie=U({id:null,category_id:null,title:"",cover:"",images:[],description:"",chapter_count:1,status:"ongoing",is_hot:!1}),re=k(null),se=k([]),ue=k(""),de=C(()=>`${l.defaults.baseURL}/admin/gallery-novel/upload/image`),ne=C(()=>`${l.defaults.baseURL}/admin/gallery-novel/upload/image`),ce=C(()=>({Authorization:`Bearer ${localStorage.getItem("token")}`}));async function pe(){try{const{data:e}=await l.get("/admin/gallery-novel/gallery/categories");Y.value=e}catch(e){a.error("加载分类失败")}}async function me(){D.value=!0;try{const e={page:ee.page,page_size:ee.pageSize,...le},{data:a}=await l.get("/admin/gallery-novel/galleries",{params:e});Z.value=a.items,ee.total=a.total}catch(e){a.error("加载图集失败")}finally{D.value=!1}}function ge(e=null){e?Object.assign(te,e):Object.assign(te,{id:null,name:"",sort_order:0}),ae.value=!0}async function fe(){if(!te.name)return a.warning("请输入分类名称");try{te.id?await l.put(`/admin/gallery-novel/gallery/categories/${te.id}`,te):await l.post("/admin/gallery-novel/gallery/categories",te),a.success("保存成功"),ae.value=!1,pe()}catch(e){a.error("保存失败")}}function ve(e=null){e?(Object.assign(ie,e),se.value=(e.images||[]).map((e,l)=>({name:`image_${l}`,url:e}))):(Object.assign(ie,{id:null,category_id:null,title:"",cover:"",images:[],description:"",chapter_count:1,status:"ongoing",is_hot:!1}),se.value=[]),ue.value="",oe.value=!0}function _e(e){const l=e.type.startsWith("image/"),t=e.size/1024/1024<10;return l?!!t||(a.error("图片大小不能超过 10MB"),!1):(a.error("只能上传图片文件"),!1)}function ye(e){e.url?(ie.cover=e.url,a.success("封面上传成功")):a.error("上传失败")}function he(e,l,a){e.url&&(ie.images.includes(e.url)||ie.images.push(e.url),l.url=e.url)}function be(e){var l;const a=e.url||(null==(l=e.response)?void 0:l.url);if(a){const e=ie.images.indexOf(a);e>-1&&ie.images.splice(e,1)}}function we(e){a.error("上传失败，请重试")}function Ve(){if(!ue.value.trim())return;const e=ue.value.split("\n").map(e=>e.trim()).filter(e=>e&&(e.startsWith("http")||e.startsWith("/")));e.forEach(e=>{ie.images.includes(e)||(ie.images.push(e),se.value.push({name:e.split("/").pop(),url:e}))}),ue.value="",a.success(`已添加 ${e.length} 张图片`)}async function je(){if(!ie.title||!ie.cover)return a.warning("请填写标题和封面");X.value=!0;try{ie.id?await l.put(`/admin/gallery-novel/galleries/${ie.id}`,ie):await l.post("/admin/gallery-novel/galleries",ie),a.success("保存成功"),oe.value=!1,me()}catch(e){a.error("保存失败")}finally{X.value=!1}}return z(()=>{pe(),me()}),(e,k)=>{const U=R("Plus"),C=d,z=u,ke=r,Ue=s,Ce=i,ze=t,xe=f,$e=g,Oe=v,Re=n,Se=c,Le=m,Me=y,qe=h,Ee=_,Ge=o,Pe=w,We=b,Ae=V,Be=p;return S(),x("div",A,[$(ze,{class:"category-card",shadow:"never"},{header:O(()=>[q("div",B,[k[21]||(k[21]=q("span",null,"图集分类",-1)),$(z,{type:"primary",size:"small",onClick:k[0]||(k[0]=e=>ge())},{default:O(()=>[$(C,null,{default:O(()=>[$(U)]),_:1}),k[20]||(k[20]=L("添加分类 ",-1))]),_:1})])]),default:O(()=>[$(Ce,{data:Y.value,size:"small"},{default:O(()=>[$(ke,{prop:"name",label:"分类名称"}),$(ke,{prop:"gallery_count",label:"图集数",width:"80"}),$(ke,{prop:"sort_order",label:"排序",width:"80"}),$(ke,{label:"状态",width:"80"},{default:O(({row:e})=>[$(Ue,{type:e.is_active?"success":"info",size:"small"},{default:O(()=>[L(M(e.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),$(ke,{label:"操作",width:"120"},{default:O(({row:e})=>[$(z,{type:"primary",link:"",size:"small",onClick:l=>ge(e)},{default:O(()=>[...k[22]||(k[22]=[L("编辑",-1)])]),_:1},8,["onClick"]),$(z,{type:"danger",link:"",size:"small",onClick:t=>async function(e){await j.confirm("确定删除该分类？","提示");try{await l.delete(`/admin/gallery-novel/gallery/categories/${e.id}`),a.success("删除成功"),pe()}catch(t){a.error("删除失败")}}(e)},{default:O(()=>[...k[23]||(k[23]=[L("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),$(ze,{shadow:"never"},{header:O(()=>[q("div",F,[q("div",I,[$($e,{modelValue:le.category_id,"onUpdate:modelValue":k[1]||(k[1]=e=>le.category_id=e),placeholder:"选择分类",clearable:"",style:{width:"150px"}},{default:O(()=>[(S(!0),x(P,null,W(Y.value,e=>(S(),G(xe,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),$(Oe,{modelValue:le.keyword,"onUpdate:modelValue":k[2]||(k[2]=e=>le.keyword=e),placeholder:"搜索标题",clearable:"",style:{width:"200px"}},null,8,["modelValue"]),$(z,{type:"primary",onClick:me},{default:O(()=>[...k[24]||(k[24]=[L("搜索",-1)])]),_:1})]),$(z,{type:"primary",onClick:k[3]||(k[3]=e=>ve())},{default:O(()=>[$(C,null,{default:O(()=>[$(U)]),_:1}),k[25]||(k[25]=L("添加图集 ",-1))]),_:1})])]),default:O(()=>[E((S(),G(Ce,{data:Z.value},{default:O(()=>[$(ke,{label:"封面",width:"100"},{default:O(({row:e})=>[$(Re,{src:e.cover,style:{width:"60px",height:"80px"},fit:"cover"},null,8,["src"])]),_:1}),$(ke,{prop:"title",label:"标题","min-width":"150"}),$(ke,{prop:"category_name",label:"分类",width:"100"}),$(ke,{prop:"image_count",label:"图片数",width:"80"}),$(ke,{prop:"view_count",label:"浏览",width:"80"}),$(ke,{label:"热门",width:"80"},{default:O(({row:e})=>[$(Se,{modelValue:e.is_hot,"onUpdate:modelValue":l=>e.is_hot=l,onChange:t=>async function(e){try{await l.put(`/admin/gallery-novel/galleries/${e.id}`,{is_hot:e.is_hot})}catch(t){a.error("更新失败")}}(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),$(ke,{label:"操作",width:"150"},{default:O(({row:e})=>[$(z,{type:"primary",link:"",size:"small",onClick:l=>ve(e)},{default:O(()=>[...k[26]||(k[26]=[L("编辑",-1)])]),_:1},8,["onClick"]),$(z,{type:"danger",link:"",size:"small",onClick:t=>async function(e){await j.confirm("确定删除该图集？","提示");try{await l.delete(`/admin/gallery-novel/galleries/${e.id}`),a.success("删除成功"),me()}catch(t){a.error("删除失败")}}(e)},{default:O(()=>[...k[27]||(k[27]=[L("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Be,D.value]]),$(Le,{"current-page":ee.page,"onUpdate:currentPage":k[4]||(k[4]=e=>ee.page=e),"page-size":ee.pageSize,"onUpdate:pageSize":k[5]||(k[5]=e=>ee.pageSize=e),total:ee.total,layout:"total, prev, pager, next",onCurrentChange:me,style:{"margin-top":"16px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),$(Ge,{modelValue:ae.value,"onUpdate:modelValue":k[9]||(k[9]=e=>ae.value=e),title:te.id?"编辑分类":"添加分类",width:"400px"},{footer:O(()=>[$(z,{onClick:k[8]||(k[8]=e=>ae.value=!1)},{default:O(()=>[...k[28]||(k[28]=[L("取消",-1)])]),_:1}),$(z,{type:"primary",onClick:fe},{default:O(()=>[...k[29]||(k[29]=[L("保存",-1)])]),_:1})]),default:O(()=>[$(Ee,{model:te,"label-width":"80px"},{default:O(()=>[$(Me,{label:"分类名称",required:""},{default:O(()=>[$(Oe,{modelValue:te.name,"onUpdate:modelValue":k[6]||(k[6]=e=>te.name=e)},null,8,["modelValue"])]),_:1}),$(Me,{label:"排序"},{default:O(()=>[$(qe,{modelValue:te.sort_order,"onUpdate:modelValue":k[7]||(k[7]=e=>te.sort_order=e),min:0},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),$(Ge,{modelValue:oe.value,"onUpdate:modelValue":k[19]||(k[19]=e=>oe.value=e),title:ie.id?"编辑图集":"添加图集",width:"800px"},{footer:O(()=>[$(z,{onClick:k[18]||(k[18]=e=>oe.value=!1)},{default:O(()=>[...k[32]||(k[32]=[L("取消",-1)])]),_:1}),$(z,{type:"primary",onClick:je,loading:X.value},{default:O(()=>[...k[33]||(k[33]=[L("保存",-1)])]),_:1},8,["loading"])]),default:O(()=>[$(Ee,{model:ie,"label-width":"80px"},{default:O(()=>[$(We,{gutter:20},{default:O(()=>[$(Pe,{span:12},{default:O(()=>[$(Me,{label:"标题",required:""},{default:O(()=>[$(Oe,{modelValue:ie.title,"onUpdate:modelValue":k[10]||(k[10]=e=>ie.title=e)},null,8,["modelValue"])]),_:1})]),_:1}),$(Pe,{span:12},{default:O(()=>[$(Me,{label:"分类"},{default:O(()=>[$($e,{modelValue:ie.category_id,"onUpdate:modelValue":k[11]||(k[11]=e=>ie.category_id=e),placeholder:"选择分类",clearable:"",style:{width:"100%"}},{default:O(()=>[(S(!0),x(P,null,W(Y.value,e=>(S(),G(xe,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),$(Me,{label:"封面",required:""},{default:O(()=>[q("div",K,[$(Ae,{class:"cover-uploader",action:de.value,headers:ce.value,data:{subdir:"gallery"},"show-file-list":!1,"on-success":ye,"before-upload":_e,accept:"image/*"},{default:O(()=>[ie.cover?(S(),G(Re,{key:0,src:ie.cover,class:"cover-preview",fit:"cover"},null,8,["src"])):(S(),x("div",Q,[$(C,null,{default:O(()=>[$(U)]),_:1}),k[30]||(k[30]=q("span",null,"上传封面",-1))]))]),_:1},8,["action","headers"]),q("div",H,[$(Oe,{modelValue:ie.cover,"onUpdate:modelValue":k[12]||(k[12]=e=>ie.cover=e),placeholder:"或输入封面URL",clearable:""},null,8,["modelValue"])])])]),_:1}),$(Me,{label:"图片列表"},{default:O(()=>[q("div",J,[$(Ae,{ref_key:"imagesUploadRef",ref:re,class:"images-uploader",action:ne.value,headers:ce.value,data:{subdir:"gallery"},"file-list":se.value,"on-success":he,"on-remove":be,"before-upload":_e,"on-error":we,multiple:"",accept:"image/*","list-type":"picture-card"},{default:O(()=>[$(C,null,{default:O(()=>[$(U)]),_:1})]),_:1},8,["action","headers","file-list"]),q("div",N,[$(Oe,{modelValue:ue.value,"onUpdate:modelValue":k[13]||(k[13]=e=>ue.value=e),type:"textarea",rows:3,placeholder:"或手动输入图片URL，每行一个"},null,8,["modelValue"]),$(z,{size:"small",onClick:Ve,style:{"margin-top":"8px"}},{default:O(()=>[...k[31]||(k[31]=[L("解析URL",-1)])]),_:1})])]),q("div",T,"已添加 "+M(ie.images.length)+" 张图片",1)]),_:1}),$(We,{gutter:20},{default:O(()=>[$(Pe,{span:8},{default:O(()=>[$(Me,{label:"话数"},{default:O(()=>[$(qe,{modelValue:ie.chapter_count,"onUpdate:modelValue":k[14]||(k[14]=e=>ie.chapter_count=e),min:1},null,8,["modelValue"])]),_:1})]),_:1}),$(Pe,{span:8},{default:O(()=>[$(Me,{label:"状态"},{default:O(()=>[$($e,{modelValue:ie.status,"onUpdate:modelValue":k[15]||(k[15]=e=>ie.status=e),style:{width:"100%"}},{default:O(()=>[$(xe,{label:"连载中",value:"ongoing"}),$(xe,{label:"已完结",value:"completed"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),$(Pe,{span:8},{default:O(()=>[$(Me,{label:"热门"},{default:O(()=>[$(Se,{modelValue:ie.is_hot,"onUpdate:modelValue":k[16]||(k[16]=e=>ie.is_hot=e)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),$(Me,{label:"简介"},{default:O(()=>[$(Oe,{modelValue:ie.description,"onUpdate:modelValue":k[17]||(k[17]=e=>ie.description=e),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-e8d9be4c"]]);export{D as default};
