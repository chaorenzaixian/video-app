/* empty css             *//* empty css                   *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                 *//* empty css                       *//* empty css                  *//* empty css                    *//* empty css                *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                   *//* empty css                  *//* empty css                 *//* empty css                        */import{r as e,l,c as a,j as t,y as o,O as i,F as r,z as d,C as s,G as u,ae as n,u as c,M as p,aa as v,E as _,K as m,L as y,I as f,H as h}from"./vue-vendor-Ba_vealp.js";import{_ as g,a as b}from"./index-C3P4JTuA.js";import{be as V,bk as w,aT as k,aQ as x,aJ as j,bl as C,bm as U,aM as I,bh as S,bi as z,bn as E,bj as P,br as L,bs as M,bt as R,aF as D,aR as $,aS as H,bw as N,bf as B,by as G,bv as W,bo as F,E as O,aL as A}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const T={class:"short-video-manage"},q={class:"card-header"},K={class:"header-actions"},J={class:"filter-bar"},Q=["onClick"],X={key:2},Y={key:0,style:{"margin-top":"2px"}},Z={class:"pagination"},ee={key:0,class:"upload-hint"},le={class:"cover-selector"},ae={class:"cover-frames"},te=["onClick"],oe=["src"],ie={class:"video-preview"},re=["src"],de=g({__name:"ShortVideoManage",setup(g){const de=e(!1),se=e(!1),ue=e(!1),ne=e(!1),ce=e(0),pe=e([]),ve=e([]),_e=l({search:"",status:"",category:""}),me=l({page:1,pageSize:20,total:0}),ye=e(!1),fe=e(null),he=e("");e(null);const ge=l({title:"",description:"",short_category_id:null,cover_url:"",pay_type:"free",coin_price:10,duration:0}),be=e(null),Ve=e([]),we=e(0),ke=e(""),xe=e(null),je=a(()=>{const e=localStorage.getItem("token");return e?{Authorization:`Bearer ${e}`}:{}}),Ce=a(()=>he.value&&ge.title.trim()&&(Ve.value.length>0||ge.cover_url)),Ue=e(!1);e(null);const Ie=l({id:0,title:"",description:"",short_category_id:null,coin_price:0,is_vip_only:!1,is_featured:!1}),Se=e(!1),ze=e(""),Ee=async()=>{var e,l;de.value=!0;try{const a=await b.get("/admin/videos",{params:{page:me.page,page_size:me.pageSize,search:_e.search||void 0,status:_e.status||void 0,short_category_id:_e.category||void 0,is_short:!0}});pe.value=(null==(e=a.data)?void 0:e.items)||[],me.total=(null==(l=a.data)?void 0:l.total)||0}catch(a){}finally{de.value=!1}},Pe=()=>{_e.search="",_e.status="",_e.category="",me.page=1,Ee()},Le=()=>{ge.title="",ge.description="",ge.short_category_id=null,ge.cover_url="",ge.pay_type="free",ge.coin_price=10,ge.duration=0,he.value="",ce.value=0,Ve.value=[],we.value=0,ke.value="",xe.value=null,ye.value=!0},Me=e=>{if(!e.type.startsWith("video/"))return O.error("请选择视频文件"),!1;if(e.size>838860800)return O.error("视频文件不能超过800MB"),!1;if(!ge.title){const l=e.name.replace(/\.[^/.]+$/,"");ge.title=l}xe.value=e;const l=URL.createObjectURL(e);return be.value&&(be.value.src=l),ue.value=!0,!0},Re=()=>{be.value&&(ge.duration=be.value.duration||0),De()},De=async()=>{const e=be.value;if(!e||!e.duration)return;const l=document.createElement("canvas"),a=l.getContext("2d"),t=[],o=e.duration/7,i=o=>new Promise(i=>{e.currentTime=o,e.onseeked=()=>{l.width=e.videoWidth,l.height=e.videoHeight,a.drawImage(e,0,0),t.push(l.toDataURL("image/jpeg",.8)),i()}});try{for(let e=0;e<6;e++)await i((e+1)*o);Ve.value=t,we.value=0,ge.cover_url=t[0],e.currentTime=0}catch(r){}},$e=e=>{ce.value=Math.round(e.percent||0)},He=e=>{var l;ue.value=!1,ce.value=100,he.value=e.url||(null==(l=e.data)?void 0:l.url),O.success("视频上传成功")},Ne=(e,l,a)=>{var t,o;ue.value=!1;const i=(null==e?void 0:e.message)||(null==(o=null==(t=null==e?void 0:e.response)?void 0:t.data)?void 0:o.detail)||"视频上传失败";O.error(i)},Be=async()=>{var e,l,a;if(Ce.value){ne.value=!0;try{let l=ge.cover_url;if(l&&l.startsWith("data:")){const a=await fetch(l).then(e=>e.blob()),t=new FormData;t.append("file",a,"cover.webp");const o=await b.post("/ads/upload/image",t,{headers:{"Content-Type":"multipart/form-data"}});l=(null==(e=o.data)?void 0:e.url)||o.url}await b.post("/admin/shorts",{title:ge.title,description:ge.description,short_category_id:ge.short_category_id||null,original_url:he.value,cover_url:l,duration:ge.duration||0,pay_type:"vip_free"===ge.pay_type?"coins":"free",coin_price:"vip_free"===ge.pay_type?ge.coin_price:0,is_vip_only:"vip_free"===ge.pay_type}),O.success("发布成功！"),ye.value=!1,Ee()}catch(t){O.error((null==(a=null==(l=t.response)?void 0:l.data)?void 0:a.detail)||"发布失败")}finally{ne.value=!1}}},Ge=async()=>{se.value=!0;try{await b.put(`/admin/videos/${Ie.id}`,{title:Ie.title,description:Ie.description,short_category_id:Ie.short_category_id,coin_price:Ie.coin_price,is_vip_only:Ie.is_vip_only,is_featured:Ie.is_featured}),O.success("保存成功"),Ue.value=!1,Ee()}catch(e){O.error("保存失败")}finally{se.value=!1}},We=e=>{ze.value=e.hls_url||e.original_url||"",ze.value?Se.value=!0:O.warning("视频地址不可用")},Fe=e=>{if(!e||isNaN(e))return"0:00";e=Math.floor(e);return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`},Oe=e=>({PUBLISHED:"已发布",PROCESSING:"处理中",REVIEWING:"审核中",FAILED:"失败"}[e]||e);return t(()=>{Ee(),(async()=>{try{const e=await b.get("/shorts/categories");ve.value=e.data||[]}catch(e){try{const e=await b.get("/videos/categories/by-type",{params:{category_type:"short"}});ve.value=e.data||[]}catch(l){ve.value=[]}}})()}),(e,l)=>{const a=x,t=I,g=k,xe=U,De=C,Ae=E,Te=z,qe=P,Ke=L,Je=S,Qe=R,Xe=V,Ye=N,Ze=H,el=G,ll=B,al=W,tl=$,ol=w,il=F,rl=M;return d(),o("div",T,[i(Xe,null,{header:r(()=>[s("div",q,[l[23]||(l[23]=s("span",null,"短视频管理",-1)),s("div",K,[i(t,{type:"primary",onClick:Le},{default:r(()=>[i(a,null,{default:r(()=>[i(c(D))]),_:1}),l[22]||(l[22]=m("上传短视频 ",-1))]),_:1})])])]),default:r(()=>[s("div",J,[i(g,{modelValue:_e.search,"onUpdate:modelValue":l[0]||(l[0]=e=>_e.search=e),placeholder:"搜索标题...",clearable:"",style:{width:"200px"},onKeyup:n(Ee,["enter"])},{prefix:r(()=>[i(a,null,{default:r(()=>[i(c(j))]),_:1})]),_:1},8,["modelValue"]),i(De,{modelValue:_e.status,"onUpdate:modelValue":l[1]||(l[1]=e=>_e.status=e),placeholder:"状态",clearable:"",style:{width:"120px"}},{default:r(()=>[i(xe,{label:"已发布",value:"PUBLISHED"}),i(xe,{label:"处理中",value:"PROCESSING"}),i(xe,{label:"审核中",value:"REVIEWING"}),i(xe,{label:"失败",value:"FAILED"})]),_:1},8,["modelValue"]),i(De,{modelValue:_e.category,"onUpdate:modelValue":l[2]||(l[2]=e=>_e.category=e),placeholder:"分类",clearable:"",style:{width:"120px"}},{default:r(()=>[(d(!0),o(p,null,v(ve.value,e=>(d(),_(xe,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(t,{onClick:Ee},{default:r(()=>[i(a,null,{default:r(()=>[i(c(j))]),_:1}),l[24]||(l[24]=m("搜索 ",-1))]),_:1}),i(t,{onClick:Pe},{default:r(()=>[...l[25]||(l[25]=[m("重置",-1)])]),_:1})]),u((d(),_(Je,{data:pe.value,stripe:""},{default:r(()=>[i(Te,{label:"封面",width:"100"},{default:r(({row:e})=>{return[s("div",{class:"video-cover",onClick:l=>We(e)},[i(Ae,{src:(a=e.cover_url,a?a.startsWith("http")||a.startsWith("/")?a:"/"+a:""),fit:"cover",style:{width:"80px",height:"100px","border-radius":"6px"}},{error:r(()=>[...l[26]||(l[26]=[s("div",{class:"image-error"},"无封面",-1)])]),_:1},8,["src"]),l[27]||(l[27]=s("div",{class:"play-icon"},"▶",-1))],8,Q)];var a}),_:1}),i(Te,{prop:"title",label:"标题","min-width":"180","show-overflow-tooltip":""}),i(Te,{label:"时长",width:"70"},{default:r(({row:e})=>[m(y(Fe(e.duration)),1)]),_:1}),i(Te,{prop:"view_count",label:"播放",width:"70"}),i(Te,{prop:"like_count",label:"点赞",width:"70"}),i(Te,{label:"付费",width:"100"},{default:r(({row:e})=>[s("div",null,[e.is_vip_only?(d(),_(qe,{key:0,type:"success",size:"small"},{default:r(()=>[...l[28]||(l[28]=[m("VIP专属",-1)])]),_:1})):e.coin_price>0?(d(),_(qe,{key:1,type:"warning",size:"small"},{default:r(()=>[m(y(e.coin_price)+"金币 ",1)]),_:2},1024)):(d(),o("span",X,"免费"))]),e.is_vip_only&&e.coin_price>0?(d(),o("div",Y,[i(qe,{type:"info",size:"small"},{default:r(()=>[m("非VIP "+y(e.coin_price)+"币",1)]),_:2},1024)])):f("",!0)]),_:1}),i(Te,{label:"状态",width:"100"},{default:r(({row:e})=>{return[i(qe,{type:(l=e.status,{PUBLISHED:"success",PROCESSING:"warning",REVIEWING:"info",FAILED:"danger"}[l]||""),size:"small"},{default:r(()=>[m(y(Oe(e.status)),1)]),_:2},1032,["type"])];var l}),_:1}),i(Te,{label:"上传时间",width:"150"},{default:r(({row:e})=>{return[m(y((l=e.created_at,A(l).format("MM-DD HH:mm"))),1)];var l}),_:1}),i(Te,{label:"操作",width:"180",fixed:"right"},{default:r(({row:e})=>[i(t,{link:"",type:"primary",onClick:l=>(e=>{Ie.id=e.id,Ie.title=e.title||"",Ie.description=e.description||"",Ie.short_category_id=e.short_category_id||e.category_id||null,Ie.coin_price=e.coin_price||0,Ie.is_vip_only=e.is_vip_only||!1,Ie.is_featured=e.is_featured||!1,Ue.value=!0})(e)},{default:r(()=>[...l[29]||(l[29]=[m("编辑",-1)])]),_:1},8,["onClick"]),"PUBLISHED"===e.status?(d(),_(t,{key:0,link:"",type:"primary",onClick:l=>We(e)},{default:r(()=>[...l[30]||(l[30]=[m(" 预览 ",-1)])]),_:1},8,["onClick"])):f("",!0),i(Ke,{title:"确定删除这个短视频吗？",onConfirm:l=>(async e=>{try{await b.delete(`/admin/videos/${e.id}`),O.success("删除成功"),Ee()}catch(l){O.error("删除失败")}})(e)},{reference:r(()=>[i(t,{link:"",type:"danger"},{default:r(()=>[...l[31]||(l[31]=[m("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[rl,de.value]]),s("div",Z,[i(Qe,{"current-page":me.page,"onUpdate:currentPage":l[3]||(l[3]=e=>me.page=e),"page-size":me.pageSize,"onUpdate:pageSize":l[4]||(l[4]=e=>me.pageSize=e),total:me.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:Ee,onCurrentChange:Ee},null,8,["current-page","page-size","total"])])]),_:1}),i(ol,{modelValue:ye.value,"onUpdate:modelValue":l[11]||(l[11]=e=>ye.value=e),title:"上传短视频",width:"600px","close-on-click-modal":!1},{footer:r(()=>[i(t,{onClick:l[10]||(l[10]=e=>ye.value=!1)},{default:r(()=>[...l[38]||(l[38]=[m("取消",-1)])]),_:1}),i(t,{type:"primary",onClick:Be,loading:ne.value,disabled:!Ce.value},{default:r(()=>[...l[39]||(l[39]=[m(" 发布 ",-1)])]),_:1},8,["loading","disabled"])]),default:r(()=>[i(tl,{model:ge,"label-width":"80px"},{default:r(()=>[i(Ze,{label:"视频文件",required:""},{default:r(()=>[i(Ye,{ref_key:"uploadRef",ref:fe,action:"/api/v1/videos/upload-file",headers:je.value,"with-credentials":!0,"before-upload":Me,"on-success":He,"on-error":Ne,"on-progress":$e,"show-file-list":!1,disabled:ue.value,accept:"video/*"},{default:r(()=>[i(t,{loading:ue.value},{default:r(()=>[m(y(ue.value?`上传中 ${ce.value}%`:"选择视频文件"),1)]),_:1},8,["loading"])]),_:1},8,["headers","disabled"]),he.value?(d(),o("div",ee,[i(qe,{type:"success"},{default:r(()=>[...l[32]||(l[32]=[m("已上传",-1)])]),_:1})])):f("",!0),l[33]||(l[33]=s("div",{class:"upload-tip"},"支持 MP4、MOV 格式，最大800MB",-1))]),_:1}),Ve.value.length>0||ge.cover_url?(d(),_(Ze,{key:0,label:"封面"},{default:r(()=>[s("div",le,[s("div",ae,[(d(!0),o(p,null,v(Ve.value,(e,l)=>(d(),o("div",{key:l,class:h(["frame-item",{active:we.value===l}]),onClick:e=>(e=>{we.value=e,ke.value="",ge.cover_url=Ve.value[e]})(l)},[s("img",{src:e,alt:""},null,8,oe)],10,te))),128))]),l[34]||(l[34]=s("div",{class:"cover-tip"},"从视频中截取6帧供选择",-1))])]),_:1})):f("",!0),s("video",{ref_key:"hiddenVideoRef",ref:be,style:{display:"none"},crossorigin:"anonymous",onLoadedmetadata:Re},null,544),i(Ze,{label:"标题",required:""},{default:r(()=>[i(g,{modelValue:ge.title,"onUpdate:modelValue":l[5]||(l[5]=e=>ge.title=e),placeholder:"输入短视频标题",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(Ze,{label:"描述"},{default:r(()=>[i(g,{modelValue:ge.description,"onUpdate:modelValue":l[6]||(l[6]=e=>ge.description=e),type:"textarea",rows:3,placeholder:"描述（选填）",maxlength:"500"},null,8,["modelValue"])]),_:1}),i(Ze,{label:"分类"},{default:r(()=>[i(De,{modelValue:ge.short_category_id,"onUpdate:modelValue":l[7]||(l[7]=e=>ge.short_category_id=e),placeholder:"选择分类",clearable:"",style:{width:"100%"}},{default:r(()=>[(d(!0),o(p,null,v(ve.value,e=>(d(),_(xe,{key:e.id,label:`${e.icon||""} ${e.name}`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(Ze,{label:"付费设置"},{default:r(()=>[i(ll,{modelValue:ge.pay_type,"onUpdate:modelValue":l[8]||(l[8]=e=>ge.pay_type=e)},{default:r(()=>[i(el,{value:"free"},{default:r(()=>[...l[35]||(l[35]=[m("免费",-1)])]),_:1}),i(el,{value:"vip_free"},{default:r(()=>[...l[36]||(l[36]=[m("会员免费，非会员付费",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"vip_free"===ge.pay_type?(d(),_(Ze,{key:1,label:"非会员价格"},{default:r(()=>[i(al,{modelValue:ge.coin_price,"onUpdate:modelValue":l[9]||(l[9]=e=>ge.coin_price=e),min:1,max:9999},null,8,["modelValue"]),l[37]||(l[37]=s("span",{style:{"margin-left":"8px",color:"#909399"}},"金币",-1))]),_:1})):f("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),i(ol,{modelValue:Ue.value,"onUpdate:modelValue":l[20]||(l[20]=e=>Ue.value=e),title:"编辑短视频",width:"500px"},{footer:r(()=>[i(t,{onClick:l[19]||(l[19]=e=>Ue.value=!1)},{default:r(()=>[...l[43]||(l[43]=[m("取消",-1)])]),_:1}),i(t,{type:"primary",onClick:Ge,loading:se.value},{default:r(()=>[...l[44]||(l[44]=[m("保存",-1)])]),_:1},8,["loading"])]),default:r(()=>[i(tl,{model:Ie,"label-width":"80px"},{default:r(()=>[i(Ze,{label:"标题"},{default:r(()=>[i(g,{modelValue:Ie.title,"onUpdate:modelValue":l[12]||(l[12]=e=>Ie.title=e)},null,8,["modelValue"])]),_:1}),i(Ze,{label:"描述"},{default:r(()=>[i(g,{modelValue:Ie.description,"onUpdate:modelValue":l[13]||(l[13]=e=>Ie.description=e),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),i(Ze,{label:"分类"},{default:r(()=>[i(De,{modelValue:Ie.short_category_id,"onUpdate:modelValue":l[14]||(l[14]=e=>Ie.short_category_id=e),placeholder:"选择分类",clearable:"",style:{width:"100%"}},{default:r(()=>[(d(!0),o(p,null,v(ve.value,e=>(d(),_(xe,{key:e.id,label:`${e.icon||""} ${e.name}`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),i(Ze,{label:"VIP专属"},{default:r(()=>[i(il,{modelValue:Ie.is_vip_only,"onUpdate:modelValue":l[15]||(l[15]=e=>Ie.is_vip_only=e)},null,8,["modelValue"]),l[40]||(l[40]=s("span",{style:{"margin-left":"8px",color:"#909399"}},"开启后VIP用户免费观看",-1))]),_:1}),Ie.is_vip_only?f("",!0):(d(),_(Ze,{key:0,label:"付费"},{default:r(()=>[i(al,{modelValue:Ie.coin_price,"onUpdate:modelValue":l[16]||(l[16]=e=>Ie.coin_price=e),min:0,max:9999},null,8,["modelValue"]),l[41]||(l[41]=s("span",{style:{"margin-left":"8px",color:"#909399"}},"0 表示免费",-1))]),_:1})),Ie.is_vip_only?(d(),_(Ze,{key:1,label:"非会员价格"},{default:r(()=>[i(al,{modelValue:Ie.coin_price,"onUpdate:modelValue":l[17]||(l[17]=e=>Ie.coin_price=e),min:0,max:9999},null,8,["modelValue"]),l[42]||(l[42]=s("span",{style:{"margin-left":"8px",color:"#909399"}},"非VIP用户需支付的金币",-1))]),_:1})):f("",!0),i(Ze,{label:"推荐"},{default:r(()=>[i(il,{modelValue:Ie.is_featured,"onUpdate:modelValue":l[18]||(l[18]=e=>Ie.is_featured=e)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),i(ol,{modelValue:Se.value,"onUpdate:modelValue":l[21]||(l[21]=e=>Se.value=e),title:"预览",width:"400px","destroy-on-close":""},{default:r(()=>[s("div",ie,[s("video",{src:ze.value,controls:"",autoplay:"",style:{width:"100%","max-height":"70vh","border-radius":"8px"}},null,8,re)])]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-95e8a47b"]]);export{de as default};
