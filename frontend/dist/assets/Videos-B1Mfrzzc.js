/* empty css             *//* empty css                   *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                          *//* empty css                     *//* empty css               *//* empty css                    *//* empty css                 *//* empty css                *//* empty css                      *//* empty css                  *//* empty css                        */import"./el-tooltip-l0sNRNKZ.js";/* empty css                   *//* empty css                  *//* empty css                    *//* empty css                  *//* empty css                 *//* empty css                        */import{r as e,l as a,j as l,R as t,y as s,O as o,F as i,z as r,C as d,G as n,ae as u,u as p,M as c,aa as _,E as m,K as v,L as y,I as g}from"./vue-vendor-Ba_vealp.js";import{_ as f,a as h}from"./index-C3P4JTuA.js";import{be as b,bk as V,aT as w,aQ as k,aJ as I,bl as C,bm as S,aM as j,bh as x,bi as U,bn as z,a1 as E,bj as P,bo as $,$ as N,bp as G,O as L,b4 as R,_ as D,bq as O,br as M,bs as H,bt as F,ad as A,aF as B,aR as W,aS as Y,bu as K,bv as q,E as J,aL as Q}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const T={class:"videos-page"},X={class:"card-header"},Z={class:"header-actions"},ee={class:"filter-bar"},ae={class:"image-error"},le={key:1},te={key:2},se={key:0,style:{"margin-top":"2px"}},oe={class:"status-cell"},ie={key:0,class:"published-status"},re={key:1,class:"progress-wrapper"},de={class:"progress-header"},ne={class:"progress-percent"},ue={class:"progress-stage"},pe={class:"pagination"},ce=f({__name:"Videos",setup(f){const ce=e(!1),_e=e(!1),me=e([]),ve=e([]),ye=e([]);let ge=null,fe=null;const he=a({search:"",status:"",category:"",video_type:"normal"}),be=a({page:1,pageSize:20,total:0}),Ve=async()=>{var e,a;ce.value=!0;try{const l=await h.get("/admin/videos",{params:{page:be.page,page_size:be.pageSize,search:he.search||void 0,status:he.status||void 0,category_id:he.category||void 0,is_short:"short"===he.video_type||"normal"!==he.video_type&&void 0}});me.value=((null==(e=l.data)?void 0:e.items)||[]).map(e=>({...e,status:(e.status||"").toUpperCase(),_retrying:!1,_progress:0})),be.total=(null==(a=l.data)?void 0:a.total)||0;const t=me.value.filter(e=>"PROCESSING"===e.status).map(e=>e.id);t.length>0&&(await we(t),fe||(fe=setInterval(()=>we(t),2e3)));const s=t.length>0;s&&!ge?ge=setInterval(Ve,1e4):s||(ge&&(clearInterval(ge),ge=null),fe&&(clearInterval(fe),fe=null))}catch(l){}finally{ce.value=!1}},we=async e=>{var a;try{const l=await h.post("/admin/videos/progress/batch",e),t=(null==(a=l.data)?void 0:a.progress)||l.progress||{};me.value.forEach(e=>{void 0!==t[e.id]&&(e._progress=t[e.id])})}catch(l){}},ke=e=>!e||e<10?"准备中...":e<20?"获取信息...":e<30?"生成封面...":e<40?"生成预览...":e<80?"视频转码...":e<100?"AI分析...":"即将完成",Ie=()=>{he.search="",he.status="",he.category="",he.video_type="normal",be.page=1,Ve()},Ce=e(!1),Se=e(null),je=a({id:0,title:"",description:"",category_id:null,tags:[],coin_price:0,is_vip_only:!1,is_featured:!1}),xe=e=>{je.category_id=e},Ue=async()=>{_e.value=!0;try{await h.put(`/admin/videos/${je.id}`,{title:je.title,description:je.description,category_id:je.category_id,tags:je.tags,coin_price:je.coin_price,is_vip_only:je.is_vip_only,is_featured:je.is_featured}),J.success("保存成功"),Ce.value=!1,Ve()}catch(e){}finally{_e.value=!1}},ze=e=>{if(!e||isNaN(e))return"0:00";e=Math.floor(e);const a=Math.floor(e/3600),l=Math.floor(e%3600/60),t=e%60;return a>0?`${a}:${l.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`:`${l}:${t.toString().padStart(2,"0")}`};return l(()=>{Ve(),(async()=>{try{const e=await h.get("/videos/categories");ve.value=(e.data||[]).filter(e=>!e.category_type||"video"===e.category_type||"both"===e.category_type)}catch(e){ve.value=[]}})(),(async()=>{try{const e=await h.get("/admin/tags");ye.value=(e.data||[]).map(e=>e.name)}catch(e){ye.value=[]}})()}),t(()=>{ge&&(clearInterval(ge),ge=null),fe&&(clearInterval(fe),fe=null)}),(e,a)=>{const l=k,t=j,f=w,fe=S,we=C,Ee=z,Pe=U,$e=P,Ne=$,Ge=G,Le=R,Re=M,De=x,Oe=F,Me=b,He=Y,Fe=K,Ae=q,Be=W,We=V,Ye=H;return r(),s("div",T,[o(Me,null,{header:i(()=>[d("div",X,[a[20]||(a[20]=d("span",null,"视频列表",-1)),d("div",Z,[o(t,{onClick:a[0]||(a[0]=a=>e.$router.push("/videos/batch-upload"))},{default:i(()=>[o(l,null,{default:i(()=>[o(p(A))]),_:1}),a[18]||(a[18]=v("批量上传 ",-1))]),_:1}),o(t,{type:"primary",onClick:a[1]||(a[1]=a=>e.$router.push("/videos/upload"))},{default:i(()=>[o(l,null,{default:i(()=>[o(p(B))]),_:1}),a[19]||(a[19]=v("上传视频 ",-1))]),_:1})])])]),default:i(()=>[d("div",ee,[o(f,{modelValue:he.search,"onUpdate:modelValue":a[2]||(a[2]=e=>he.search=e),placeholder:"搜索视频标题...",clearable:"",style:{width:"250px"},onKeyup:u(Ve,["enter"])},{prefix:i(()=>[o(l,null,{default:i(()=>[o(p(I))]),_:1})]),_:1},8,["modelValue"]),o(we,{modelValue:he.status,"onUpdate:modelValue":a[3]||(a[3]=e=>he.status=e),placeholder:"状态",clearable:"",style:{width:"120px"}},{default:i(()=>[o(fe,{label:"已发布",value:"PUBLISHED"}),o(fe,{label:"处理中",value:"PROCESSING"}),o(fe,{label:"审核中",value:"REVIEWING"}),o(fe,{label:"失败",value:"FAILED"})]),_:1},8,["modelValue"]),o(we,{modelValue:he.category,"onUpdate:modelValue":a[4]||(a[4]=e=>he.category=e),placeholder:"分类",clearable:"",style:{width:"120px"}},{default:i(()=>[(r(!0),s(c,null,_(ve.value,e=>(r(),m(fe,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(we,{modelValue:he.video_type,"onUpdate:modelValue":a[5]||(a[5]=e=>he.video_type=e),placeholder:"视频类型",clearable:"",style:{width:"120px"}},{default:i(()=>[o(fe,{label:"全部",value:""}),o(fe,{label:"长视频",value:"normal"}),o(fe,{label:"短视频",value:"short"})]),_:1},8,["modelValue"]),o(t,{onClick:Ve},{default:i(()=>[o(l,null,{default:i(()=>[o(p(I))]),_:1}),a[21]||(a[21]=v("搜索 ",-1))]),_:1}),o(t,{onClick:Ie},{default:i(()=>[...a[22]||(a[22]=[v("重置",-1)])]),_:1})]),n((r(),m(De,{data:me.value,stripe:""},{default:i(()=>[o(Pe,{label:"封面",width:"120"},{default:i(({row:e})=>{return[o(Ee,{src:(a=e.cover_url,a?a.startsWith("http")||a.startsWith("/")?a:"/"+a:"/placeholder.webp"),fit:"cover",style:{width:"100px",height:"56px","border-radius":"4px"}},{error:i(()=>[d("div",ae,["PROCESSING"===e.status?(r(),m(l,{key:0},{default:i(()=>[o(p(E))]),_:1})):(r(),s("span",le,"无封面"))])]),_:2},1032,["src"])];var a}),_:1}),o(Pe,{prop:"title",label:"标题","min-width":"200","show-overflow-tooltip":""}),o(Pe,{prop:"uploader_name",label:"上传者",width:"100"}),o(Pe,{label:"时长",width:"80"},{default:i(({row:e})=>[v(y(ze(e.duration)),1)]),_:1}),o(Pe,{prop:"view_count",label:"播放",width:"80"}),o(Pe,{label:"付费",width:"100"},{default:i(({row:e})=>[d("div",null,[e.is_vip_only?(r(),m($e,{key:0,type:"success",size:"small"},{default:i(()=>[...a[23]||(a[23]=[v("VIP专属",-1)])]),_:1})):e.coin_price>0?(r(),m($e,{key:1,type:"warning",size:"small"},{default:i(()=>[v(y(e.coin_price)+"金币 ",1)]),_:2},1024)):(r(),s("span",te,"免费"))]),e.is_vip_only&&e.coin_price>0?(r(),s("div",se,[o($e,{type:"info",size:"small"},{default:i(()=>[v("非VIP "+y(e.coin_price)+"币",1)]),_:2},1024)])):g("",!0)]),_:1}),o(Pe,{label:"短视频",width:"70"},{default:i(({row:e})=>[o(Ne,{modelValue:e.is_short,"onUpdate:modelValue":a=>e.is_short=a,onChange:a=>(async e=>{try{await h.put(`/admin/videos/${e.id}`,{is_short:e.is_short}),J.success(e.is_short?"已设为短视频":"已设为长视频")}catch(a){e.is_short=!e.is_short,J.error("操作失败")}})(e),size:"small"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),o(Pe,{label:"推荐",width:"60"},{default:i(({row:e})=>[o(Ne,{modelValue:e.is_featured,"onUpdate:modelValue":a=>e.is_featured=a,onChange:a=>(async e=>{try{await h.put(`/admin/videos/${e.id}/featured`),J.success(e.is_featured?"已设为推荐":"已取消推荐")}catch(a){e.is_featured=!e.is_featured}})(e),size:"small",disabled:"PUBLISHED"!==e.status},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])]),_:1}),o(Pe,{label:"状态",width:"180"},{default:i(({row:e})=>{return[d("div",oe,["PUBLISHED"===e.status?(r(),s("div",ie,[o(l,{class:"check-icon"},{default:i(()=>[o(p(N))]),_:1}),a[24]||(a[24]=d("span",null,"已发布",-1))])):"PROCESSING"===e.status?(r(),s("div",re,[d("div",de,[o(l,{class:"status-icon is-loading"},{default:i(()=>[o(p(E))]),_:1}),a[25]||(a[25]=d("span",null,"转码中",-1)),d("span",ne,y(e._progress||0)+"%",1)]),o(Ge,{percentage:e._progress||0,"stroke-width":6,"show-text":!1,color:(t=e._progress,t<30?"#e6a23c":t<70?"#409eff":"#67c23a")},null,8,["percentage","color"]),d("div",ue,y(ke(e._progress)),1)])):"REVIEWING"===e.status?(r(),m($e,{key:2,type:"info",size:"small"},{default:i(()=>[o(l,{class:"status-icon"},{default:i(()=>[o(p(L))]),_:1}),a[26]||(a[26]=v(" 审核中 ",-1))]),_:1})):"FAILED"===e.status?(r(),m(Le,{key:3,content:e.error_message||"转码失败",placement:"top"},{default:i(()=>[o($e,{type:"danger",size:"small"},{default:i(()=>[o(l,{class:"status-icon"},{default:i(()=>[o(p(D))]),_:1}),a[27]||(a[27]=v(" 失败 ",-1))]),_:1})]),_:1},8,["content"])):(r(),m($e,{key:4,size:"small"},{default:i(()=>[v(y(e.status),1)]),_:2},1024))])];var t}),_:1}),o(Pe,{label:"上传时间",width:"160"},{default:i(({row:e})=>{return[v(y((a=e.created_at,Q(a).format("YYYY-MM-DD HH:mm"))),1)];var a}),_:1}),o(Pe,{label:"操作",width:"200",fixed:"right"},{default:i(({row:e})=>["PUBLISHED"===e.status?(r(),m(t,{key:0,link:"",type:"primary",onClick:a=>(e=>{window.open(`/user/video/${e.id}`,"_blank")})(e)},{default:i(()=>[...a[28]||(a[28]=[v(" 查看 ",-1)])]),_:1},8,["onClick"])):g("",!0),o(t,{link:"",type:"primary",onClick:a=>(async e=>{je.id=e.id,je.title=e.title||"",je.description=e.description||"",je.category_id=e.category_id||null,Se.value=e.category_id||null,je.tags=e.tags||[],je.coin_price=e.coin_price||0,je.is_vip_only=e.is_vip_only||!1,je.is_featured=e.is_featured||!1,Ce.value=!0})(e)},{default:i(()=>[...a[29]||(a[29]=[v("编辑",-1)])]),_:1},8,["onClick"]),"FAILED"===e.status||"PROCESSING"===e.status?(r(),m(t,{key:1,link:"",type:"warning",onClick:a=>(async e=>{var a,l;e._retrying=!0;try{await h.post(`/admin/videos/${e.id}/retry-transcode`),J.success("已开始重新转码"),e.status="PROCESSING",ge||(ge=setInterval(Ve,5e3))}catch(t){J.error("重新转码失败: "+((null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.detail)||t.message))}finally{e._retrying=!1}})(e),loading:e._retrying},{default:i(()=>[o(l,null,{default:i(()=>[o(p(O))]),_:1}),a[30]||(a[30]=v(" 重新转码 ",-1))]),_:1},8,["onClick","loading"])):g("",!0),o(Re,{title:"确定删除这个视频吗？",onConfirm:a=>(async e=>{try{await h.delete(`/admin/videos/${e.id}`),J.success("删除成功"),Ve()}catch(a){}})(e)},{reference:i(()=>[o(t,{link:"",type:"danger"},{default:i(()=>[...a[31]||(a[31]=[v("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[Ye,ce.value]]),d("div",pe,[o(Oe,{"current-page":be.page,"onUpdate:currentPage":a[6]||(a[6]=e=>be.page=e),"page-size":be.pageSize,"onUpdate:pageSize":a[7]||(a[7]=e=>be.pageSize=e),total:be.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Ve,onCurrentChange:Ve},null,8,["current-page","page-size","total"])])]),_:1}),o(We,{modelValue:Ce.value,"onUpdate:modelValue":a[17]||(a[17]=e=>Ce.value=e),title:"编辑视频",width:"550px"},{footer:i(()=>[o(t,{onClick:a[16]||(a[16]=e=>Ce.value=!1)},{default:i(()=>[...a[35]||(a[35]=[v("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:Ue,loading:_e.value},{default:i(()=>[...a[36]||(a[36]=[v("保存",-1)])]),_:1},8,["loading"])]),default:i(()=>[o(Be,{model:je,"label-width":"80px"},{default:i(()=>[o(He,{label:"标题"},{default:i(()=>[o(f,{modelValue:je.title,"onUpdate:modelValue":a[8]||(a[8]=e=>je.title=e)},null,8,["modelValue"])]),_:1}),o(He,{label:"描述"},{default:i(()=>[o(f,{modelValue:je.description,"onUpdate:modelValue":a[9]||(a[9]=e=>je.description=e),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),o(He,{label:"分类"},{default:i(()=>[o(Fe,{modelValue:Se.value,"onUpdate:modelValue":a[10]||(a[10]=e=>Se.value=e),options:ve.value,props:{value:"id",label:"name",children:"children",emitPath:!1,checkStrictly:!0},placeholder:"请选择分类",style:{width:"100%"},clearable:"",onChange:xe},null,8,["modelValue","options"])]),_:1}),o(He,{label:"标签"},{default:i(()=>[o(we,{modelValue:je.tags,"onUpdate:modelValue":a[11]||(a[11]=e=>je.tags=e),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"输入或选择标签",style:{width:"100%"}},{default:i(()=>[(r(!0),s(c,null,_(ye.value,e=>(r(),m(fe,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(He,{label:"VIP专属"},{default:i(()=>[o(Ne,{modelValue:je.is_vip_only,"onUpdate:modelValue":a[12]||(a[12]=e=>je.is_vip_only=e)},null,8,["modelValue"]),a[32]||(a[32]=d("span",{style:{"margin-left":"8px",color:"#909399"}},"开启后VIP用户免费观看",-1))]),_:1}),je.is_vip_only?g("",!0):(r(),m(He,{key:0,label:"付费"},{default:i(()=>[o(Ae,{modelValue:je.coin_price,"onUpdate:modelValue":a[13]||(a[13]=e=>je.coin_price=e),min:0,max:9999},null,8,["modelValue"]),a[33]||(a[33]=d("span",{style:{"margin-left":"8px",color:"#909399"}},"0 表示免费",-1))]),_:1})),je.is_vip_only?(r(),m(He,{key:1,label:"非会员价格"},{default:i(()=>[o(Ae,{modelValue:je.coin_price,"onUpdate:modelValue":a[14]||(a[14]=e=>je.coin_price=e),min:0,max:9999},null,8,["modelValue"]),a[34]||(a[34]=d("span",{style:{"margin-left":"8px",color:"#909399"}},"非VIP用户需支付的金币",-1))]),_:1})):g("",!0),o(He,{label:"推荐"},{default:i(()=>[o(Ne,{modelValue:je.is_featured,"onUpdate:modelValue":a[15]||(a[15]=e=>je.is_featured=e)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-f17b044f"]]);export{ce as default};
