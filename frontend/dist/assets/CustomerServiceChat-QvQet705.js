/* empty css             *//* empty css                 *//* empty css                 *//* empty css                  */import{r as e,c as s,j as a,R as t,n as i,w as l,y as n,C as r,H as u,K as c,I as o,L as v,M as d,aa as m,E as p,F as _,O as g,ae as y,z as k,u as f}from"./vue-vendor-Ba_vealp.js";import{_ as w,u as h,a as b}from"./index-C3P4JTuA.js";import{E as $,aM as C,aT as S,bI as j,a as x}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const D={class:"chat-manage"},I={class:"chat-container"},M={class:"session-list"},O={class:"list-header"},E={class:"status-tabs"},N={key:0},T={class:"session-items"},z=["onClick"],q=["src"],H={key:1},J=["src"],V={class:"session-info"},W={class:"session-top"},B={class:"username"},K=["src"],L={class:"time"},P={class:"session-bottom"},R={class:"title"},F={key:0,class:"unread"},U={class:"session-status"},Y={key:0,class:"empty-list"},A={class:"chat-area"},G={class:"chat-header"},Q={class:"user-info"},X=["src"],Z={key:1},ee={class:"user-details"},se={class:"name-row"},ae={class:"name"},te=["src"],ie={class:"status"},le={class:"header-actions"},ne={key:0,class:"system-msg"},re=["src"],ue=["src"],ce={key:2},oe={class:"message-content"},ve={key:0,class:"message-bubble image-bubble"},de=["src","onClick"],me={key:1,class:"message-bubble"},pe={class:"message-meta"},_e={class:"message-time"},ge=["src"],ye={key:1,class:"input-area"},ke={key:0,class:"quick-replies"},fe=["onClick"],we={class:"input-box"},he={key:1,class:"no-session"},be=w({__name:"CustomerServiceChat",setup(w){const be=h(),$e=e(null),Ce={1:"/images/backgrounds/vip_gold.webp",2:"/images/backgrounds/vip_1.webp",3:"/images/backgrounds/vip_2.webp",4:"/images/backgrounds/vip_3.webp",5:"/images/backgrounds/super_vip_red.webp",6:"/images/backgrounds/super_vip_blue.webp"},Se=e=>Ce[e]||"",je=e([]),xe=e(null),De=e([]),Ie=e(""),Me=e(""),Oe=e(!1),Ee=e([]),Ne=e(null);let Te=null,ze=null;const qe={waiting:"等待接入",active:"进行中",closed:"已结束"},He=s(()=>je.value.filter(e=>"waiting"===e.status).length),Je=s(()=>Me.value?je.value.filter(e=>e.status===Me.value):je.value);a(async()=>{await Ve(),await We(),Fe()}),t(()=>{Ue()});const Ve=async()=>{try{const e=await b.get("/chat/admin/sessions");je.value=e.data||e||[]}catch(e){}},We=async()=>{try{const e=await b.get("/chat/quick-replies");Ee.value=e.data||e||[]}catch(e){}},Be=async e=>{try{const s=await b.get(`/chat/sessions/${e}/messages`);De.value=s.data||s||[],await i(),Qe(),Ke(e)}catch(s){}},Ke=async e=>{if(e)try{await b.post(`/chat/sessions/${e}/read`);const s=je.value.find(s=>s.id===e);s&&(s.unread_count=0)}catch(s){}},Le=async()=>{var e;try{await b.post(`/chat/admin/sessions/${xe.value.id}/claim`),xe.value.status="active",xe.value.agent_id=null==(e=be.user)?void 0:e.id,$.success("已接入会话"),await Be(xe.value.id)}catch(s){$.error("接入失败")}},Pe=async()=>{try{await x.confirm("确定要结束此会话吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await b.post(`/chat/admin/sessions/${xe.value.id}/close`),xe.value.status="closed",$.success("会话已结束"),await Be(xe.value.id)}catch(e){"cancel"!==e&&$.error("操作失败")}},Re=async()=>{var e;const s=Ie.value.trim();if(s&&xe.value)try{if(Te&&Te.readyState===WebSocket.OPEN)Te.send(JSON.stringify({type:"message",session_id:xe.value.id,content:s})),De.value.push({id:`temp-${Date.now()}`,session_id:xe.value.id,sender_id:null==(e=be.user)?void 0:e.id,is_from_user:!1,message_type:"text",content:s,created_at:(new Date).toISOString()});else{const e=await b.post("/chat/admin/messages",{session_id:xe.value.id,content:s});De.value.push(e.data||e)}Ie.value="",await i(),Qe()}catch(a){$.error("发送失败")}},Fe=()=>{var e;if(!(null==(e=be.user)?void 0:e.id))return;const s=be.token||localStorage.getItem("token")||"",a=`ws://${window.location.hostname}:8000/api/v1/chat/ws/agent/${be.user.id}?token=${s}`;try{Te=new WebSocket(a),Te.onopen=()=>{Ye()},Te.onmessage=e=>{try{const s=JSON.parse(e.data);Ge(s)}catch(s){}},Te.onclose=()=>{Ae(),setTimeout(Fe,3e3)},Te.onerror=e=>{}}catch(t){}},Ue=()=>{Te&&(Te.close(),Te=null),Ae()},Ye=()=>{ze=setInterval(()=>{Te&&Te.readyState===WebSocket.OPEN&&Te.send(JSON.stringify({type:"ping"}))},3e4)},Ae=()=>{ze&&(clearInterval(ze),ze=null)},Ge=e=>{var s,a;switch(e.type){case"pong":break;case"new_session":Ve(),$.info(`新用户 ${e.nickname||e.username||"用户"} 发起咨询`);break;case"new_message":(null==(s=xe.value)?void 0:s.id)===e.session_id&&(De.value.push({id:e.message.id,session_id:e.session_id,sender_id:e.message.sender_id,is_from_user:e.message.is_from_user,message_type:e.message.message_type||"text",content:e.message.content,is_read:!1,created_at:e.message.created_at}),Qe(),e.message.is_from_user&&Ke(e.session_id));const t=je.value.find(s=>s.id===e.session_id);t?(t.updated_at=e.message.created_at,t.unread_count=(t.unread_count||0)+1,e.message.is_from_user&&!t.title&&(t.title=e.message.content.substring(0,50))):Ve();break;case"messages_read":"user"===e.reader&&(null==(a=xe.value)?void 0:a.id)===e.session_id&&De.value.forEach(e=>{e.is_from_user||(e.is_read=!0)})}},Qe=()=>{i(()=>{$e.value&&($e.value.scrollTop=$e.value.scrollHeight)})},Xe=e=>{if(!e)return"";const s=new Date(e),a=new Date-s;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)}分钟前`:a<864e5?`${Math.floor(a/36e5)}小时前`:`${s.getMonth()+1}/${s.getDate()}`},Ze=e=>{if(!e)return"";const s=new Date(e);return`${s.getMonth()+1}-${s.getDate()} ${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`};return l(De,()=>{Qe()},{deep:!0}),(e,s)=>{const a=C,t=S,i=j;return k(),n("div",D,[r("div",I,[r("div",M,[r("div",O,[s[7]||(s[7]=r("h3",null,"客服会话",-1)),r("div",E,[r("span",{class:u({active:""===Me.value}),onClick:s[0]||(s[0]=e=>Me.value="")},"全部",2),r("span",{class:u({active:"waiting"===Me.value}),onClick:s[1]||(s[1]=e=>Me.value="waiting")},[s[6]||(s[6]=c(" 等待中 ",-1)),He.value>0?(k(),n("em",N,v(He.value),1)):o("",!0)],2),r("span",{class:u({active:"active"===Me.value}),onClick:s[2]||(s[2]=e=>Me.value="active")},"进行中",2)])]),r("div",T,[(k(!0),n(d,null,m(Je.value,e=>{var s;return k(),n("div",{key:e.id,class:u(["session-item",{active:(null==(s=xe.value)?void 0:s.id)===e.id}]),onClick:s=>(async e=>{xe.value=e,await Be(e.id)})(e)},[r("div",{class:u(["user-avatar",{"is-vip":e.is_vip}])},[e.avatar?(k(),n("img",{key:0,src:e.avatar},null,8,q)):(k(),n("span",H,v((e.nickname||e.username||"用户")[0]),1)),e.is_vip&&e.vip_level?(k(),n("img",{key:2,class:"vip-badge",src:Se(e.vip_level)},null,8,J)):o("",!0)],2),r("div",V,[r("div",W,[r("span",B,v(e.nickname||e.username||`用户${e.user_id}`),1),e.is_vip&&e.vip_level?(k(),n("img",{key:0,class:"vip-icon",src:Se(e.vip_level)},null,8,K)):o("",!0),r("span",L,v(Xe(e.updated_at)),1)]),r("div",P,[r("span",R,v(e.title||"新会话"),1),e.unread_count>0?(k(),n("span",F,v(e.unread_count),1)):o("",!0)])]),r("div",U,[r("span",{class:u(["status-tag",e.status])},v(qe[e.status]||e.status),3)])],10,z)}),128)),0===Je.value.length?(k(),n("div",Y," 暂无会话 ")):o("",!0)])]),r("div",A,[xe.value?(k(),n(d,{key:0},[r("div",G,[r("div",Q,[r("div",{class:u(["user-avatar-header",{"is-vip":xe.value.is_vip}])},[xe.value.avatar?(k(),n("img",{key:0,src:xe.value.avatar},null,8,X)):(k(),n("span",Z,v((xe.value.nickname||xe.value.username||"用户")[0]),1))],2),r("div",ee,[r("div",se,[r("span",ae,v(xe.value.nickname||xe.value.username||`用户${xe.value.user_id}`),1),xe.value.is_vip&&xe.value.vip_level?(k(),n("img",{key:0,class:"vip-icon-header",src:Se(xe.value.vip_level)},null,8,te)):o("",!0)]),r("span",ie,v(qe[xe.value.status]),1)])]),r("div",le,["waiting"===xe.value.status?(k(),p(a,{key:0,type:"primary",size:"small",onClick:Le},{default:_(()=>[...s[8]||(s[8]=[c(" 接入会话 ",-1)])]),_:1})):o("",!0),"active"===xe.value.status?(k(),p(a,{key:1,type:"danger",size:"small",onClick:Pe},{default:_(()=>[...s[9]||(s[9]=[c(" 结束会话 ",-1)])]),_:1})):o("",!0)])]),r("div",{class:"message-list",ref_key:"messageListRef",ref:$e},[(k(!0),n(d,null,m(De.value,e=>{var s,a;return k(),n("div",{key:e.id,class:u(["message-item",{"from-user":e.is_from_user,"from-agent":!e.is_from_user}])},["system"===e.message_type?(k(),n("div",ne,v(e.content),1)):(k(),n(d,{key:1},[r("div",{class:u(["message-avatar",{"user-avatar":e.is_from_user}])},[e.is_from_user&&(null==(s=xe.value)?void 0:s.user_avatar)?(k(),n("img",{key:0,src:xe.value.user_avatar},null,8,re)):!e.is_from_user&&(null==(a=f(be).user)?void 0:a.avatar)?(k(),n("img",{key:1,src:f(be).user.avatar},null,8,ue)):(k(),n("span",ce,v(e.is_from_user?"用":"客"),1))],2),r("div",oe,["image"===e.message_type?(k(),n("div",ve,[r("img",{src:e.content,class:"msg-image",onClick:s=>{return a=e.content,void(Ne.value=a);var a}},null,8,de)])):(k(),n("div",me,v(e.content),1)),r("div",pe,[r("span",_e,v(Ze(e.created_at)),1),e.is_from_user?o("",!0):(k(),n("span",{key:0,class:u(["read-status",{read:e.is_read}])},v(e.is_read?"已读":"未读"),3))])])],64))],2)}),128))],512),Ne.value?(k(),n("div",{key:0,class:"image-preview",onClick:s[3]||(s[3]=e=>Ne.value=null)},[r("img",{src:Ne.value},null,8,ge)])):o("",!0),"active"===xe.value.status?(k(),n("div",ye,[Oe.value?(k(),n("div",ke,[(k(!0),n(d,null,m(Ee.value,e=>(k(),n("div",{key:e.id,class:"quick-reply-item",onClick:s=>(e=>{Ie.value=e.content,Oe.value=!1})(e)},v(e.title),9,fe))),128))])):o("",!0),r("div",we,[g(a,{size:"small",onClick:s[4]||(s[4]=e=>Oe.value=!Oe.value)},{default:_(()=>[...s[10]||(s[10]=[c(" 快捷回复 ",-1)])]),_:1}),g(t,{modelValue:Ie.value,"onUpdate:modelValue":s[5]||(s[5]=e=>Ie.value=e),placeholder:"输入消息...",onKeyup:y(Re,["enter"])},null,8,["modelValue"]),g(a,{type:"primary",onClick:Re,disabled:!Ie.value.trim()},{default:_(()=>[...s[11]||(s[11]=[c(" 发送 ",-1)])]),_:1},8,["disabled"])])])):o("",!0)],64)):(k(),n("div",he,[g(i,{description:"请选择一个会话"})]))])])])}}},[["__scopeId","data-v-350189bb"]]);export{be as default};
