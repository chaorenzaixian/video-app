import{r as s,j as t,az as a,y as e,C as l,I as n,L as i,aC as o,z as u}from"./vue-vendor-Ba_vealp.js";import{_ as r,u as c,a as d}from"./index-C3P4JTuA.js";import"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const v={class:"qr-login-page"},p={class:"page-header"},g={class:"login-content"},h={key:0,class:"status-card"},k={key:1,class:"status-card success"},m={class:"status-text"},b={key:2,class:"status-card error"},f={class:"status-text"},y={key:3,class:"status-card warning"},w={key:4,class:"status-card confirm"},x={key:0,class:"device-info"},C={class:"action-buttons"},$=["disabled"],_=r({__name:"QRLogin",setup(r){const _=a(),A=o(),j=c(),I=s("loading"),L=s(""),P=s(""),q=s(!1),D=s(""),M=async()=>{var s,t,a,e,l,n,i,o,u;const r=_.query.token;if(r){q.value=!0;try{const s=(()=>{const s=document.createElement("canvas"),t=s.getContext("2d");t.textBaseline="top",t.font="14px Arial",t.fillText("device-fingerprint",2,2);const a=s.toDataURL(),e=`${navigator.userAgent}-${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}-${Intl.DateTimeFormat().resolvedOptions().timeZone}-${navigator.language}-${a.slice(-50)}`;let l=0;for(let n=0;n<e.length;n++)l=(l<<5)-l+e.charCodeAt(n),l&=l;return Math.abs(l).toString(16).padStart(16,"0")})(),t=await d.post("/auth/qr-login",null,{params:{token:r,device_id:s,device_info:D.value}});localStorage.setItem("token",t.data.access_token),localStorage.setItem("refresh_token",t.data.refresh_token),await j.fetchUser(),P.value=t.data.username||"用户",I.value="success"}catch(c){400===(null==(s=c.response)?void 0:s.status)?(I.value="invalid",L.value=(null==(a=null==(t=c.response)?void 0:t.data)?void 0:a.detail)||"该二维码已被使用"):404===(null==(e=c.response)?void 0:e.status)?(I.value="invalid",L.value="无效的登录二维码"):429===(null==(l=c.response)?void 0:l.status)?(I.value="error",L.value=(null==(i=null==(n=c.response)?void 0:n.data)?void 0:i.detail)||"设备切换过于频繁，请稍后再试"):(I.value="error",L.value=(null==(u=null==(o=c.response)?void 0:o.data)?void 0:u.detail)||"登录失败，请重试")}finally{q.value=!1}}else I.value="invalid"},S=()=>{A.push("/user")};return t(()=>{_.query.token?(D.value=(()=>{const s=navigator.userAgent;return/iPhone/i.test(s)?"iPhone":/iPad/i.test(s)?"iPad":/Android/i.test(s)?"Android":/Windows/i.test(s)?"Windows PC":/Mac/i.test(s)?"Mac":"Unknown Device"})(),I.value="confirm"):I.value="invalid"}),(s,t)=>(u(),e("div",v,[l("div",p,[l("button",{class:"back-btn",onClick:t[0]||(t[0]=t=>s.$router.push("/user"))},[...t[4]||(t[4]=[l("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[l("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1)])]),t[5]||(t[5]=l("h1",{class:"page-title"},"扫码登录",-1)),t[6]||(t[6]=l("div",{class:"header-right"},null,-1))]),l("div",g,["loading"===I.value?(u(),e("div",h,[...t[7]||(t[7]=[l("div",{class:"loading-spinner"},null,-1),l("p",{class:"status-text"},"正在验证登录信息...",-1)])])):"success"===I.value?(u(),e("div",k,[t[8]||(t[8]=l("div",{class:"status-icon"},"✓",-1)),t[9]||(t[9]=l("h2",{class:"status-title"},"登录成功",-1)),l("p",m,"欢迎回来，"+i(P.value),1),t[10]||(t[10]=l("p",{class:"status-sub"},"其他设备已自动登出",-1)),l("button",{class:"action-btn",onClick:S},"进入首页")])):"error"===I.value?(u(),e("div",b,[t[11]||(t[11]=l("div",{class:"status-icon"},"✕",-1)),t[12]||(t[12]=l("h2",{class:"status-title"},"登录失败",-1)),l("p",f,i(L.value),1),l("button",{class:"action-btn secondary",onClick:t[1]||(t[1]=t=>s.$router.push("/user/settings/recovery"))}," 账号找回 ")])):"invalid"===I.value?(u(),e("div",y,[t[13]||(t[13]=l("div",{class:"status-icon"},"!",-1)),t[14]||(t[14]=l("h2",{class:"status-title"},"二维码无效",-1)),t[15]||(t[15]=l("p",{class:"status-text"},"该二维码已过期或已被使用",-1)),l("button",{class:"action-btn secondary",onClick:t[2]||(t[2]=t=>s.$router.push("/user/settings/recovery"))}," 账号找回 ")])):"confirm"===I.value?(u(),e("div",w,[t[16]||(t[16]=l("div",{class:"status-icon"},"?",-1)),t[17]||(t[17]=l("h2",{class:"status-title"},"确认登录",-1)),t[18]||(t[18]=l("p",{class:"status-text"},"您正在使用二维码登录",-1)),t[19]||(t[19]=l("p",{class:"status-sub"},"登录后，原设备将自动登出",-1)),D.value?(u(),e("div",x,[l("span",null,"当前设备："+i(D.value),1)])):n("",!0),l("div",C,[l("button",{class:"action-btn",onClick:M,disabled:q.value},i(q.value?"登录中...":"确认登录"),9,$),l("button",{class:"action-btn secondary",onClick:t[3]||(t[3]=t=>s.$router.push("/user"))}," 取消 ")])])):n("",!0)])]))}},[["__scopeId","data-v-006e5812"]]);export{_ as default};
