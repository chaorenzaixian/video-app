import{r as a,c as l,j as e,y as s,C as t,I as i,L as n,G as u,af as o,H as c,M as r,U as v,aa as p,aC as d,z as m}from"./vue-vendor-Ba_vealp.js";import{_ as f,a as k}from"./index-C3P4JTuA.js";import{E as y}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const g={class:"publish-page"},h={class:"top-bar"},C={class:"form-content"},w={class:"placeholder"},b={class:"form-item"},_={class:"form-item content-item"},L={class:"char-count"},M={class:"upload-section"},U={class:"upload-grid"},x=["src"],R=["src"],j={class:"upload-section"},z={class:"upload-grid"},D=["src"],F=["onClick"],I={class:"bottom-bar"},$=["disabled"],A={class:"picker-content"},H={class:"picker-header"},T={class:"topic-list"},V=["onClick"],E={class:"rules-content"},O=f({__name:"PublishVideo",setup(f){const O=d(),B=a(""),G=a(""),N=a(null),P=a(""),S=a(null),q=a(""),J=a([]),K=a(null),Q=a([]),W=a(!1),X=a(!1),Y=a(!1),Z=a(null),aa=a(null),la=a(null),ea=l(()=>B.value.trim()&&S.value),sa=()=>{var a;return null==(a=Z.value)?void 0:a.click()},ta=()=>{var a;return null==(a=aa.value)?void 0:a.click()},ia=()=>{var a;return null==(a=la.value)?void 0:a.click()},na=a=>{const l=a.target.files[0];if(!l)return;if(l.size>1048576)return void y.warning("封面图片不能超过1M");N.value=l;const e=new FileReader;e.onload=a=>{P.value=a.target.result},e.readAsDataURL(l),a.target.value=""},ua=a=>{const l=a.target.files[0];l&&(l.size>314572800?y.warning("视频不能超过300M"):(S.value=l,q.value=URL.createObjectURL(l),a.target.value=""))},oa=a=>{const l=Array.from(a.target.files),e=9-J.value.length;l.slice(0,e).forEach(a=>{if(a.size>1048576)return void y.warning(`${a.name} 超过1M限制`);const l=new FileReader;l.onload=l=>{J.value.push({file:a,preview:l.target.result})},l.readAsDataURL(a)}),a.target.value=""},ca=()=>{N.value=null,P.value=""},ra=()=>{q.value&&URL.revokeObjectURL(q.value),S.value=null,q.value=""},va=async()=>{var a,l,e,s,t;if(ea.value&&!Y.value){Y.value=!0;try{const s=new FormData;s.append("file",S.value);const t=await k.post("/community/upload/video",s,{headers:{"Content-Type":"multipart/form-data"}}),i=(null==(a=t.data)?void 0:a.url)||t.url;let n="";if(N.value){const a=new FormData;a.append("file",N.value);const e=await k.post("/community/upload/image",a,{headers:{"Content-Type":"multipart/form-data"}});n=(null==(l=e.data)?void 0:l.url)||e.url}const u=[];for(const a of J.value){const l=new FormData;l.append("file",a.file);const s=await k.post("/community/upload/image",l,{headers:{"Content-Type":"multipart/form-data"}});u.push((null==(e=s.data)?void 0:e.url)||s.url)}await k.post("/community/posts",{content:`${B.value}\n\n${G.value}`,images:n?[n,...u]:u,video_url:i,topic_ids:K.value?[K.value.id]:[]}),y.success("发布成功"),O.back()}catch(i){y.error((null==(t=null==(s=i.response)?void 0:s.data)?void 0:t.detail)||"发布失败")}finally{Y.value=!1}}};return e(()=>{(async()=>{try{const a=await k.get("/community/topics",{params:{level:2,page_size:50}});Q.value=a.data||a||[]}catch(a){}})()}),(a,l)=>(m(),s("div",g,[t("div",h,[t("span",{class:"back",onClick:l[0]||(l[0]=l=>a.$router.back())},[...l[9]||(l[9]=[t("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},[t("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1)])]),l[10]||(l[10]=t("span",{class:"title"},"发布视频",-1)),t("span",{class:"rules",onClick:l[1]||(l[1]=a=>X.value=!0)},"规则")]),t("div",C,[t("div",{class:"form-item select-item",onClick:l[2]||(l[2]=a=>W.value=!0)},[l[11]||(l[11]=t("span",{class:"hash"},"#",-1)),t("span",w,n(K.value?K.value.name:"选择标签"),1),l[12]||(l[12]=t("span",{class:"arrow"},"›",-1))]),t("div",b,[u(t("input",{type:"text","onUpdate:modelValue":l[3]||(l[3]=a=>B.value=a),placeholder:"请填写标题",class:"title-input"},null,512),[[o,B.value]])]),t("div",_,[u(t("textarea",{"onUpdate:modelValue":l[4]||(l[4]=a=>G.value=a),placeholder:"有趣的介绍能让你的逼格提高N个档次！...",rows:"5"},null,512),[[o,G.value]]),t("span",L,n(G.value.length)+"/300",1)]),t("div",M,[l[17]||(l[17]=t("div",{class:"section-header"},[t("span",{class:"section-title"},"添加视频"),t("span",{class:"section-tip"},"最大300M以内 请选择30S以上视频")],-1)),t("div",U,[t("div",{class:c(["upload-item",{"has-image":P.value}]),onClick:sa},[P.value?(m(),s("img",{key:0,src:P.value,class:"preview-img"},null,8,x)):(m(),s(r,{key:1},[l[13]||(l[13]=t("span",{class:"plus"},"+",-1)),l[14]||(l[14]=t("span",{class:"text"},"上传封面",-1))],64)),P.value?(m(),s("span",{key:2,class:"remove-btn",onClick:v(ca,["stop"])},"×")):i("",!0)],2),t("div",{class:c(["upload-item",{"has-video":S.value}]),onClick:ta},[q.value?(m(),s("video",{key:0,src:q.value,class:"preview-video"},null,8,R)):(m(),s(r,{key:1},[l[15]||(l[15]=t("span",{class:"plus"},"+",-1)),l[16]||(l[16]=t("span",{class:"text"},"上传视频",-1))],64)),S.value?(m(),s("span",{key:2,class:"remove-btn",onClick:v(ra,["stop"])},"×")):i("",!0)],2)]),t("input",{type:"file",ref_key:"coverInput",ref:Z,accept:"image/*",onChange:na,style:{display:"none"}},null,544),t("input",{type:"file",ref_key:"videoInput",ref:aa,accept:"video/*",onChange:ua,style:{display:"none"}},null,544)]),t("div",j,[l[19]||(l[19]=t("div",{class:"section-header"},[t("span",{class:"section-title"},"添加图集"),t("span",{class:"section-tip"},"最大每张1M以内 第一张默认为封面")],-1)),t("div",z,[(m(!0),s(r,null,p(J.value,(a,l)=>(m(),s("div",{key:l,class:"upload-item has-image"},[t("img",{src:a.preview,class:"preview-img"},null,8,D),t("span",{class:"remove-btn",onClick:a=>(a=>{J.value.splice(a,1)})(l)},"×",8,F)]))),128)),J.value.length<9?(m(),s("div",{key:0,class:"upload-item add-btn",onClick:ia},[...l[18]||(l[18]=[t("span",{class:"plus"},"+",-1),t("span",{class:"text"},"上传图片",-1)])])):i("",!0)]),t("input",{type:"file",ref_key:"imageInput",ref:la,accept:"image/*",multiple:"",onChange:oa,style:{display:"none"}},null,544)])]),t("div",I,[t("button",{class:"submit-btn",disabled:!ea.value||Y.value,onClick:va},n(Y.value?"发布中...":"确定发布"),9,$)]),W.value?(m(),s("div",{key:0,class:"topic-picker",onClick:l[6]||(l[6]=v(a=>W.value=!1,["self"]))},[t("div",A,[t("div",H,[l[20]||(l[20]=t("span",null,"选择话题",-1)),t("span",{class:"close",onClick:l[5]||(l[5]=a=>W.value=!1)},"×")]),t("div",T,[(m(!0),s(r,null,p(Q.value,a=>{var l;return m(),s("div",{key:a.id,class:c(["topic-item",{active:(null==(l=K.value)?void 0:l.id)===a.id}]),onClick:l=>(a=>{K.value=a,W.value=!1})(a)}," #"+n(a.name),11,V)}),128))])])])):i("",!0),X.value?(m(),s("div",{key:1,class:"rules-modal",onClick:l[8]||(l[8]=v(a=>X.value=!1,["self"]))},[t("div",E,[l[21]||(l[21]=t("h3",null,"发布规则",-1)),l[22]||(l[22]=t("ul",null,[t("li",null,"视频大小不超过300M"),t("li",null,"视频时长需30秒以上"),t("li",null,"图片大小不超过1M"),t("li",null,"禁止发布违规内容")],-1)),t("button",{onClick:l[7]||(l[7]=a=>X.value=!1)},"我知道了")])])):i("",!0)]))}},[["__scopeId","data-v-c91119e4"]]);export{O as default};
