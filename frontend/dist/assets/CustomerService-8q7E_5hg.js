import{r as e,c as a,j as s,R as t,n as l,w as n,y as i,C as r,I as c,M as o,aa as u,H as v,L as d,G as m,af as g,ae as p,z as y}from"./vue-vendor-Ba_vealp.js";import{_}from"./ic_back-BPdSG6fy.js";import{_ as w,u as f,a as k}from"./index-C3P4JTuA.js";import{E as h}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const S={class:"service-page"},b={class:"page-header"},C={class:"header-right"},$={key:0,class:"status-dot online"},D={key:1,class:"status-dot offline"},I={key:0,class:"loading-state"},x={key:0,class:"system-message"},M={key:1,class:"message-bubble service-message"},O={class:"avatar-wrapper"},T=["src"],z={key:1,class:"agent-avatar default"},H={class:"message-body"},j={key:0,class:"sender-name"},L={class:"message-content"},B=["src","onClick"],N=["innerHTML"],q={class:"message-meta"},E={class:"message-time"},W={key:2,class:"message-bubble user-message"},J={class:"message-body"},P={class:"message-content"},R=["src","onClick"],V={key:1},A={class:"message-meta"},F={class:"message-time"},G={key:1,class:"quick-panel"},K={class:"category-tabs"},U=["onClick"],Z={class:"quick-questions"},Q=["onClick"],X={key:2,class:"typing-indicator"},Y=["src"],ee={class:"input-area"},ae={key:0,class:"cooldown-tip"},se=w({__name:"CustomerService",setup(w){const se=f(),te=e(null),le=e(null),ne=e(!0),ie=e(null),re=e([]),ce=e(""),oe=e("disconnected"),ue=e(!1),ve=e(!0),de=e(null),me=e(null),ge=e(0),pe=e(0),ye=e(!1),_e=e(0);let we=null,fe=null,ke=null,he=null;const Se=e([{name:"账号与权益问题"},{name:"播放问题"},{name:"支付与订单相关"}]),be=e(0),Ce=e(!1),$e=e([[{title:"账号找回",answer:"如需找回账号，请提供您的注册手机号或邮箱，我们会尽快为您处理。"},{title:"充值了会员还是无法观看",answer:"请先尝试退出登录后重新登录，如仍无法观看，请提供您的订单号，我们会为您核实。"},{title:"绑定不了手机号",answer:"请确保手机号未被其他账号绑定，如已绑定其他账号，需先解绑后才能绑定新账号。"},{title:"如何修改密码",answer:"进入个人中心 -> 安全设置 -> 修改密码，按提示操作即可。"},{title:"账号被封禁怎么办",answer:"请联系客服说明情况，我们会根据具体违规行为进行处理。"}],[{title:"视频加载缓慢",answer:"建议检查网络连接，或尝试切换清晰度，降低画质可提升加载速度。"},{title:"视频无法播放",answer:"请尝试刷新页面或更换浏览器，如仍有问题请联系客服。"},{title:"画面卡顿/黑屏",answer:"建议清除浏览器缓存，或尝试使用其他浏览器观看。"},{title:"声音画面不同步",answer:"请尝试刷新页面，如问题持续存在，可能是视频源问题，请反馈给客服。"}],[{title:"支付成功但未到账",answer:"支付成功后一般即时到账，如未到账请提供订单号，我们会为您核实。"},{title:"如何申请退款",answer:"请联系客服说明退款原因，提供订单号，我们会在24小时内处理。"},{title:"支付方式有哪些",answer:"目前支持支付宝、微信支付等主流支付方式。推荐使用支付宝，成功率更高。"},{title:"会员套餐介绍",answer:"我们提供月卡、季卡、年卡和永久卡，不同套餐享受不同优惠，详情请查看VIP中心。"}]]),De=a(()=>{const e=$e.value[be.value]||[];return Ce.value?e:e.slice(0,3)}),Ie=a(()=>($e.value[be.value]||[]).length>3);s(async()=>{await xe(),He()}),t(()=>{je()});const xe=async()=>{var e;ne.value=!0;try{const a=await k.post("/chat/sessions");ie.value=(null==(e=a.data)?void 0:e.id)||a.id,await Me(),await Oe()}catch(a){re.value=[{id:"welcome",is_from_user:!1,message_type:"system",content:"亲亲，请问您需要什么协助呢？\n❣️ 客服小妹推荐您985.fun里面都是精选过的app，新人注册还有优惠，相当划算！❣️\n❣️ 提醒您：由于近期微信支付通道不稳定，推荐使用支付宝支付，成功率高且快速哟 ❣️",created_at:(new Date).toISOString()}]}finally{ne.value=!1}},Me=async()=>{if(ie.value)try{const e=await k.get(`/chat/sessions/${ie.value}/info`),a=e.data||e;a.agent&&(me.value=a.agent)}catch(e){}},Oe=async()=>{if(ie.value)try{const e=await k.get(`/chat/sessions/${ie.value}/messages`);let a=e.data||e||[];if(!a.some(e=>!e.is_from_user)){a=[{id:"welcome-auto",is_from_user:!1,message_type:"text",content:"人工客服已上线，您遇到什么问题请详细、清楚描述给客服喔\n请说明问题勿重复发话刷频，避免系统自动关闭，\n并且耐心等候客服给您回覆\n谢谢您。",created_at:(new Date).toISOString()},...a]}re.value=a,re.value.length>1&&(ve.value=!1),await l(),Ae(),Te()}catch(e){}},Te=async()=>{if(ie.value)try{await k.post(`/chat/sessions/${ie.value}/read`)}catch(e){}},ze=()=>{Te()},He=()=>{var e;if(!(null==(e=se.user)?void 0:e.id))return;const a=se.token||localStorage.getItem("token")||"",s=`ws://${window.location.hostname}:8000/api/v1/chat/ws/user/${se.user.id}?token=${a}`;try{fe=new WebSocket(s),fe.onopen=()=>{oe.value="connected",Be()},fe.onmessage=e=>{try{const a=JSON.parse(e.data);qe(a)}catch(a){}},fe.onclose=()=>{oe.value="disconnected",Ne(),Le()},fe.onerror=e=>{oe.value="error"}}catch(t){}},je=()=>{fe&&(fe.close(),fe=null),Ne(),ke&&(clearTimeout(ke),ke=null)},Le=()=>{ke||(ke=setTimeout(()=>{ke=null,He()},3e3))},Be=()=>{he=setInterval(()=>{fe&&fe.readyState===WebSocket.OPEN&&fe.send(JSON.stringify({type:"ping"}))},3e4)},Ne=()=>{he&&(clearInterval(he),he=null)},qe=e=>{switch(e.type){case"pong":break;case"new_message":re.value.push({id:e.message.id,session_id:e.session_id,sender_id:e.message.sender_id,is_from_user:e.message.is_from_user,message_type:e.message.message_type||"text",content:e.message.content,is_read:!1,created_at:e.message.created_at}),Ae(),ve.value=!1,e.message.is_from_user||Te();break;case"agent_joined":re.value.push({id:`system-${Date.now()}`,message_type:"system",content:`客服 ${e.agent_name} 已接入会话`,created_at:(new Date).toISOString()}),me.value={name:e.agent_name,avatar:e.agent_avatar},Ae();break;case"session_closed":re.value.push({id:`system-${Date.now()}`,message_type:"system",content:"会话已结束，感谢您的咨询！",created_at:(new Date).toISOString()}),Ae();break;case"messages_read":"agent"===e.reader&&re.value.forEach(e=>{e.is_from_user&&(e.is_read=!0)});break;case"typing":ue.value=!0,setTimeout(()=>{ue.value=!1},3e3)}},Ee=async()=>{const e=ce.value.trim();if(!e)return;const a=Date.now();if(a-ge.value<3e3){const e=Math.ceil((3e3-(a-ge.value))/1e3);return void h.warning(`发送太快了，请${e}秒后再试`)}if(pe.value>=10)return h.warning("发送消息过于频繁，请稍后再试"),void We(30);ge.value=a,pe.value++,setTimeout(()=>{pe.value>0&&pe.value--},6e4);const s={id:`temp-${Date.now()}`,is_from_user:!0,message_type:"text",content:e,is_read:!1,created_at:(new Date).toISOString()};if(re.value.push(s),ce.value="",ve.value=!1,await l(),Ae(),fe&&fe.readyState===WebSocket.OPEN)fe.send(JSON.stringify({type:"message",session_id:ie.value,content:e}));else try{await k.post("/chat/messages",{session_id:ie.value,content:e})}catch(t){}},We=e=>{ye.value=!0,_e.value=e,we&&clearInterval(we),we=setInterval(()=>{_e.value--,_e.value<=0&&(ye.value=!1,pe.value=0,clearInterval(we))},1e3)},Je=()=>{var e;null==(e=le.value)||e.click()},Pe=async e=>{var a,s;const t=null==(a=e.target.files)?void 0:a[0];if(t)if(t.type.startsWith("image/"))if(t.size>5242880)alert("图片大小不能超过5MB");else{try{const e=new FormData;e.append("file",t);const a=await k.post("/chat/upload-image",e,{headers:{"Content-Type":"multipart/form-data"}}),n=(null==(s=a.data)?void 0:s.url)||a.url,i={id:`temp-${Date.now()}`,is_from_user:!0,message_type:"image",content:n,is_read:!1,created_at:(new Date).toISOString()};re.value.push(i),ve.value=!1,await l(),Ae(),await k.post("/chat/messages",{session_id:ie.value,content:n,message_type:"image"})}catch(n){alert("上传图片失败")}e.target.value=""}else alert("请选择图片文件")},Re=e=>{de.value=e},Ve=()=>{setTimeout(()=>Ae(),300)},Ae=()=>{l(()=>{te.value&&(te.value.scrollTop=te.value.scrollHeight)})},Fe=e=>{if(!e)return"";const a=new Date(e);return`${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")} ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`};return n(re,()=>{Ae()},{deep:!0}),(e,a)=>(y(),i("div",S,[r("header",b,[r("div",{class:"back-btn",onClick:a[0]||(a[0]=a=>e.$router.back())},[...a[4]||(a[4]=[r("img",{src:_,alt:"返回",class:"back-icon"},null,-1)])]),a[5]||(a[5]=r("h1",{class:"page-title"},"在线客服",-1)),r("div",C,["connected"===oe.value?(y(),i("span",$)):(y(),i("span",D))])]),r("div",{class:"chat-area",ref_key:"chatAreaRef",ref:te,onScroll:ze},[ne.value?(y(),i("div",I,[...a[6]||(a[6]=[r("div",{class:"loading-spinner"},null,-1),r("span",null,"加载中...",-1)])])):c("",!0),(y(!0),i(o,null,u(re.value,(e,s)=>{var t,l,n;return y(),i(o,{key:e.id||s},["system"===e.message_type?(y(),i("div",x,[r("span",null,d(e.content),1)])):e.is_from_user?(y(),i("div",W,[r("div",J,[r("div",P,["image"===e.message_type?(y(),i("img",{key:0,src:e.content,class:"message-image",onClick:a=>Re(e.content)},null,8,R)):(y(),i("span",V,d(e.content),1))]),r("div",A,[r("span",F,d(Fe(e.created_at)),1),r("span",{class:v(["read-status",{read:e.is_read}])},d(e.is_read?"已读":"未读"),3)])])])):(y(),i("div",M,[r("div",O,[(null==(t=me.value)?void 0:t.avatar)?(y(),i("img",{key:0,src:me.value.avatar,class:"agent-avatar"},null,8,T)):(y(),i("div",z,[...a[7]||(a[7]=[r("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[r("path",{d:"M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"})],-1)])]))]),r("div",H,[(null==(l=me.value)?void 0:l.name)?(y(),i("div",j,d(me.value.name),1)):c("",!0),r("div",L,["image"===e.message_type?(y(),i("img",{key:0,src:e.content,class:"message-image",onClick:a=>Re(e.content)},null,8,B)):(y(),i("p",{key:1,innerHTML:(n=e.content,n?n.replace(/\n/g,"<br>").replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="link">$1</a>').replace(/([a-zA-Z0-9]+\.fun)/g,'<span class="highlight">$1</span>'):"")},null,8,N))]),r("div",q,[r("span",E,d(Fe(e.created_at)),1)])])]))],64)}),128)),ve.value?(y(),i("div",G,[r("div",K,[(y(!0),i(o,null,u(Se.value,(e,a)=>(y(),i("div",{key:a,class:v(["category-tab",{active:be.value===a}]),onClick:e=>be.value=a},d(e.name),11,U))),128))]),r("div",Z,[(y(!0),i(o,null,u(De.value,(e,a)=>(y(),i("div",{key:a,class:"question-item",onClick:a=>(async e=>{ce.value=e.title,await Ee(),setTimeout(()=>{re.value.some(e=>!e.is_from_user&&"system"!==e.message_type&&new Date(e.created_at)>new Date(Date.now()-5e3))||(re.value.push({id:`auto-${Date.now()}`,is_from_user:!1,message_type:"text",content:e.answer,is_read:!0,created_at:(new Date).toISOString()}),Ae())},1e3)})(e)},d(a+1)+"."+d(e.title),9,Q))),128)),Ie.value?(y(),i("div",{key:0,class:"expand-more",onClick:a[1]||(a[1]=e=>Ce.value=!Ce.value)},[(y(),i("svg",{viewBox:"0 0 24 24",fill:"currentColor",class:v({rotated:Ce.value})},[...a[8]||(a[8]=[r("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"},null,-1)])],2)),r("span",null,d(Ce.value?"收起问题":"展开更多问题"),1)])):c("",!0)])])):c("",!0),ue.value?(y(),i("div",X,[...a[9]||(a[9]=[r("span",null,"客服正在输入",-1),r("div",{class:"typing-dots"},[r("span"),r("span"),r("span")],-1)])])):c("",!0)],544),de.value?(y(),i("div",{key:0,class:"image-preview-modal",onClick:a[2]||(a[2]=e=>de.value=null)},[r("img",{src:de.value},null,8,Y)])):c("",!0),r("div",ee,[ye.value?(y(),i("div",ae," 发送太频繁，请等待 "+d(_e.value)+" 秒 ",1)):(y(),i(o,{key:1},[r("div",{class:"input-icon",onClick:Je},[a[10]||(a[10]=r("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[r("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"})],-1)),r("input",{type:"file",ref_key:"imageInputRef",ref:le,accept:"image/*",onChange:Pe,style:{display:"none"}},null,544)]),m(r("input",{type:"text","onUpdate:modelValue":a[3]||(a[3]=e=>ce.value=e),placeholder:"请在此输入留言",onKeyup:p(Ee,["enter"]),onFocus:Ve},null,544),[[g,ce.value]]),r("div",{class:v(["send-btn",{disabled:!ce.value.trim()}]),onClick:Ee},[...a[11]||(a[11]=[r("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[r("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})],-1)])],2)],64))])]))}},[["__scopeId","data-v-fe286133"]]);export{se as default};
