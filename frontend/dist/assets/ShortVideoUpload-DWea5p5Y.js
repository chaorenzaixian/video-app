import{r as e,c as a,j as l,y as t,C as s,I as o,L as i,M as n,aa as r,G as u,af as c,aF as p,ab as v,V as d,aC as y,z as m,H as h}from"./vue-vendor-Ba_vealp.js";import{_ as f}from"./ic_back-BPdSG6fy.js";import{_,a as g}from"./index-C3P4JTuA.js";import{a as b,E as k}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const w={class:"short-upload-page"},x={class:"page-header"},U=["disabled"],C={class:"upload-content"},V={class:"video-upload-section"},j={key:1,class:"video-preview"},M=["src"],T={class:"video-info"},B={class:"duration"},L={class:"size"},F={class:"cover-section"},R={class:"cover-options"},z=["onClick"],I=["src"],D={class:"info-section"},O={class:"form-group"},P={class:"char-count"},S={class:"form-group"},E={class:"char-count"},H={class:"form-group"},W=["value"],$={class:"pay-section"},G={class:"pay-options"},K={class:"pay-option"},q={class:"pay-option"},A={key:0,class:"price-input"},J={key:0,class:"upload-progress"},N={class:"progress-bar"},Q={class:"progress-text"},X=_({__name:"ShortVideoUpload",setup(_){const X=y(),Y=e(null),Z=e(null),ee=e(null),ae=e(""),le=e(0),te=e([]),se=e(0),oe=e({title:"",description:"",short_category_id:null,pay_type:"free",coin_price:10}),ie=e([]),ne=e(!1),re=e(0),ue=a(()=>ee.value&&oe.value.title.trim()),ce=()=>{var e;null==(e=Y.value)||e.click()},pe=async e=>{const a=e.target.files[0];a&&(a.type.startsWith("video/")?a.size>838860800?k.error("è§†é¢‘æ–‡ä»¶ä¸èƒ½è¶…è¿‡800MB"):(ee.value=a,ae.value=URL.createObjectURL(a),setTimeout(()=>{Z.value&&(Z.value.onloadedmetadata=()=>{le.value=Z.value.duration,ve()})},100)):k.error("è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶"))},ve=()=>{const e=Z.value;if(!e)return;const a=document.createElement("canvas"),l=a.getContext("2d"),t=[],s=e.duration/7,o=(s,o)=>new Promise(i=>{e.currentTime=s,e.onseeked=()=>{a.width=e.videoWidth,a.height=e.videoHeight,l.drawImage(e,0,0),t[o]=a.toDataURL("image/jpeg",.8),i()}});(async()=>{for(let e=0;e<6;e++)await o((e+1)*s,e);te.value=t,e.currentTime=0})()},de=()=>{ae.value&&URL.revokeObjectURL(ae.value),ee.value=null,ae.value="",le.value=0,te.value=[],se.value=0,Y.value.value=""},ye=async()=>{var e,a,l,t;if(ue.value&&!ne.value){ne.value=!0,re.value=0;try{const l=new FormData;l.append("file",ee.value);const t=await g.post("/videos/upload-file",l,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{re.value=Math.round(e.loaded/e.total*80)}}),s=(null==(e=t.data)?void 0:e.url)||t.url;let o="";const i=te.value[se.value];if(i){const e=await fetch(i).then(e=>e.blob()),l=new FormData;l.append("file",e,"cover.webp");const t=await g.post("/ads/upload/image",l,{headers:{"Content-Type":"multipart/form-data"}});o=(null==(a=t.data)?void 0:a.url)||t.url}re.value=90;const n={title:oe.value.title,description:oe.value.description,short_category_id:oe.value.short_category_id,original_url:s,cover_url:o,duration:le.value,is_short:!0,pay_type:"vip_free"===oe.value.pay_type?"coins":"free",coin_price:"vip_free"===oe.value.pay_type?oe.value.coin_price:0,is_vip_only:"vip_free"===oe.value.pay_type};await g.post("/creator/videos",n),re.value=100,k.success("å‘å¸ƒæˆåŠŸï¼"),setTimeout(()=>{X.push("/shorts")},500)}catch(s){k.error((null==(t=null==(l=s.response)?void 0:l.data)?void 0:t.detail)||"å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•")}finally{ne.value=!1}}},me=async()=>{if(ee.value||oe.value.title)try{await b.confirm("ç¡®å®šè¦æ”¾å¼ƒç¼–è¾‘å—ï¼Ÿ","æç¤º",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"}),X.back()}catch{}else X.back()};return l(()=>{(async()=>{try{const e=await g.get("/shorts/categories");ie.value=e.data||[]}catch(e){try{const e=await g.get("/videos/categories/by-type",{params:{category_type:"short"}});ie.value=e.data||[]}catch(a){}}})()}),(e,a)=>{return m(),t("div",w,[s("header",x,[s("div",{class:"back-btn",onClick:me},[...a[6]||(a[6]=[s("img",{src:f,alt:"è¿”å›",class:"back-icon"},null,-1)])]),a[7]||(a[7]=s("h1",{class:"page-title"},"å‘å¸ƒçŸ­è§†é¢‘",-1)),s("button",{class:"publish-btn",disabled:!ue.value||ne.value,onClick:ye},i(ne.value?"å‘å¸ƒä¸­...":"å‘å¸ƒ"),9,U)]),s("div",C,[s("div",V,[ee.value?(m(),t("div",j,[s("video",{ref_key:"previewVideo",ref:Z,src:ae.value,controls:"",playsinline:""},null,8,M),s("div",T,[s("span",B,i((y=le.value,`${Math.floor(y/60)}:${Math.floor(y%60).toString().padStart(2,"0")}`)),1),s("span",L,i((l=ee.value.size,l<1048576?(l/1024).toFixed(1)+" KB":(l/1048576).toFixed(1)+" MB")),1)]),s("button",{class:"remove-btn",onClick:de},"Ã—")])):(m(),t("div",{key:0,class:"upload-area",onClick:ce},[s("input",{type:"file",ref_key:"fileInput",ref:Y,accept:"video/*",onChange:pe,hidden:""},null,544),a[8]||(a[8]=s("div",{class:"upload-icon"},"ğŸ“¹",-1)),a[9]||(a[9]=s("p",{class:"upload-text"},"ç‚¹å‡»ä¸Šä¼ çŸ­è§†é¢‘",-1)),a[10]||(a[10]=s("p",{class:"upload-hint"},"æ”¯æŒ MP4ã€MOV æ ¼å¼ï¼Œæœ€å¤§800MB",-1))]))]),s("div",F,[a[11]||(a[11]=s("div",{class:"section-header"},[s("span",{class:"label"},"é€‰æ‹©å°é¢"),s("span",{class:"hint"},"ä»è§†é¢‘ä¸­æˆªå–6å¸§ä¾›é€‰æ‹©")],-1)),s("div",R,[(m(!0),t(n,null,r(te.value,(e,a)=>(m(),t("div",{key:a,class:h(["cover-item",{active:se.value===a}]),onClick:e=>(e=>{se.value=e})(a)},[s("img",{src:e,alt:""},null,8,I)],10,z))),128))])]),s("div",D,[s("div",O,[a[12]||(a[12]=s("label",null,"æ ‡é¢˜",-1)),u(s("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>oe.value.title=e),placeholder:"æ·»åŠ æ ‡é¢˜ï¼Œè®©æ›´å¤šäººçœ‹åˆ°ä½ çš„ä½œå“",maxlength:"100"},null,512),[[c,oe.value.title]]),s("span",P,i(oe.value.title.length)+"/100",1)]),s("div",S,[a[13]||(a[13]=s("label",null,"æè¿°",-1)),u(s("textarea",{"onUpdate:modelValue":a[1]||(a[1]=e=>oe.value.description=e),placeholder:"æ·»åŠ æè¿°ï¼ˆé€‰å¡«ï¼‰",maxlength:"500",rows:"3"},null,512),[[c,oe.value.description]]),s("span",E,i(oe.value.description.length)+"/500",1)]),s("div",H,[a[15]||(a[15]=s("label",null,"åˆ†ç±»",-1)),u(s("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>oe.value.short_category_id=e)},[a[14]||(a[14]=s("option",{value:null},"é€‰æ‹©åˆ†ç±»",-1)),(m(!0),t(n,null,r(ie.value,e=>(m(),t("option",{key:e.id,value:e.id},i(e.icon)+" "+i(e.name),9,W))),128))],512),[[p,oe.value.short_category_id]])])]),s("div",$,[a[20]||(a[20]=s("div",{class:"section-header"},[s("span",{class:"label"},"ä»˜è´¹è®¾ç½®")],-1)),s("div",G,[s("label",K,[u(s("input",{type:"radio","onUpdate:modelValue":a[3]||(a[3]=e=>oe.value.pay_type=e),value:"free"},null,512),[[v,oe.value.pay_type]]),a[16]||(a[16]=s("span",{class:"option-text"},"å…è´¹",-1))]),s("label",q,[u(s("input",{type:"radio","onUpdate:modelValue":a[4]||(a[4]=e=>oe.value.pay_type=e),value:"vip_free"},null,512),[[v,oe.value.pay_type]]),a[17]||(a[17]=s("span",{class:"option-text"},"ä¼šå‘˜å…è´¹ï¼Œéä¼šå‘˜ä»˜è´¹",-1))])]),"vip_free"===oe.value.pay_type?(m(),t("div",A,[a[18]||(a[18]=s("label",null,"éä¼šå‘˜ä»·æ ¼",-1)),u(s("input",{type:"number","onUpdate:modelValue":a[5]||(a[5]=e=>oe.value.coin_price=e),placeholder:"è¾“å…¥é‡‘å¸æ•°é‡",min:"1",max:"9999"},null,512),[[c,oe.value.coin_price,void 0,{number:!0}]]),a[19]||(a[19]=s("span",{class:"unit"},"é‡‘å¸",-1))])):o("",!0)])]),ne.value?(m(),t("div",J,[s("div",N,[s("div",{class:"progress",style:d({width:re.value+"%"})},null,4)]),s("span",Q,"ä¸Šä¼ ä¸­ "+i(re.value)+"%",1)])):o("",!0)]);var l,y}}},[["__scopeId","data-v-9d1dfff2"]]);export{X as default};
