import{r as a,c as l,j as e,y as s,C as i,I as t,L as n,G as c,af as u,M as o,aa as r,U as v,aC as p,z as d,H as m}from"./vue-vendor-Ba_vealp.js";import{_ as f,a as k}from"./index-C3P4JTuA.js";import{E as h}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const g={class:"publish-page"},y={class:"top-bar"},C={class:"form-content"},b={class:"placeholder"},w={class:"form-item"},_={class:"upload-section"},j={class:"upload-grid"},x=["src"],M=["onClick"],z={class:"bottom-bar"},I=["disabled"],L={class:"picker-content"},H={class:"picker-header"},U={class:"topic-list"},A=["onClick"],D={class:"rules-content"},E=f({__name:"PublishImage",setup(f){const E=p(),F=a(""),R=a([]),$=a(null),B=a([]),G=a(!1),P=a(!1),T=a(!1),V=a(null),q=l(()=>F.value.trim()&&R.value.length>0),J=()=>{var a;null==(a=V.value)||a.click()},K=a=>{const l=Array.from(a.target.files),e=9-R.value.length;l.slice(0,e).forEach(a=>{if(a.size>1048576)return void h.warning(`${a.name} 超过1M限制`);const l=new FileReader;l.onload=l=>{R.value.push({file:a,preview:l.target.result})},l.readAsDataURL(a)}),a.target.value=""},N=async()=>{var a,l,e;if(q.value&&!T.value){T.value=!0;try{const l=[];for(const e of R.value){const s=new FormData;s.append("file",e.file);const i=await k.post("/community/upload/image",s,{headers:{"Content-Type":"multipart/form-data"}});l.push((null==(a=i.data)?void 0:a.url)||i.url)}await k.post("/community/posts",{content:F.value,images:l,topic_ids:$.value?[$.value.id]:[]}),h.success("发布成功"),E.back()}catch(s){h.error((null==(e=null==(l=s.response)?void 0:l.data)?void 0:e.detail)||"发布失败")}finally{T.value=!1}}};return e(()=>{(async()=>{try{const a=await k.get("/community/topics",{params:{level:2,page_size:50}});B.value=a.data||a||[]}catch(a){}})()}),(a,l)=>(d(),s("div",g,[i("div",y,[i("span",{class:"back",onClick:l[0]||(l[0]=l=>a.$router.back())},[...l[8]||(l[8]=[i("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},[i("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1)])]),l[9]||(l[9]=i("span",{class:"title"},"发布图片",-1)),i("span",{class:"rules",onClick:l[1]||(l[1]=a=>P.value=!0)},"规则")]),i("div",C,[i("div",{class:"form-item select-item",onClick:l[2]||(l[2]=a=>G.value=!0)},[l[10]||(l[10]=i("span",{class:"hash"},"#",-1)),i("span",b,n($.value?$.value.name:"选择标签"),1),l[11]||(l[11]=i("span",{class:"arrow"},"›",-1))]),i("div",w,[c(i("input",{type:"text","onUpdate:modelValue":l[3]||(l[3]=a=>F.value=a),placeholder:"请填写标题",class:"title-input"},null,512),[[u,F.value]])]),i("div",_,[l[13]||(l[13]=i("div",{class:"section-header"},[i("span",{class:"section-title"},"添加图集"),i("span",{class:"section-tip"},"最大每张1M以内 第一张默认为封面")],-1)),i("div",j,[(d(!0),s(o,null,r(R.value,(a,l)=>(d(),s("div",{key:l,class:"upload-item has-image"},[i("img",{src:a.preview,class:"preview-img"},null,8,x),i("span",{class:"remove-btn",onClick:a=>(a=>{R.value.splice(a,1)})(l)},"×",8,M)]))),128)),R.value.length<9?(d(),s("div",{key:0,class:"upload-item add-btn",onClick:J},[...l[12]||(l[12]=[i("span",{class:"plus"},"+",-1),i("span",{class:"text"},"上传图片",-1)])])):t("",!0)]),i("input",{type:"file",ref_key:"fileInput",ref:V,accept:"image/*",multiple:"",onChange:K,style:{display:"none"}},null,544)])]),i("div",z,[i("button",{class:"submit-btn",disabled:!q.value||T.value,onClick:N},n(T.value?"发布中...":"确定发布"),9,I)]),G.value?(d(),s("div",{key:0,class:"topic-picker",onClick:l[5]||(l[5]=v(a=>G.value=!1,["self"]))},[i("div",L,[i("div",H,[l[14]||(l[14]=i("span",null,"选择话题",-1)),i("span",{class:"close",onClick:l[4]||(l[4]=a=>G.value=!1)},"×")]),i("div",U,[(d(!0),s(o,null,r(B.value,a=>{var l;return d(),s("div",{key:a.id,class:m(["topic-item",{active:(null==(l=$.value)?void 0:l.id)===a.id}]),onClick:l=>(a=>{$.value=a,G.value=!1})(a)}," #"+n(a.name),11,A)}),128))])])])):t("",!0),P.value?(d(),s("div",{key:1,class:"rules-modal",onClick:l[7]||(l[7]=v(a=>P.value=!1,["self"]))},[i("div",D,[l[15]||(l[15]=i("h3",null,"发布规则",-1)),l[16]||(l[16]=i("ul",null,[i("li",null,"图片大小不超过1M"),i("li",null,"最多上传9张图片"),i("li",null,"禁止发布违规内容"),i("li",null,"第一张图片将作为封面")],-1)),i("button",{onClick:l[6]||(l[6]=a=>P.value=!1)},"我知道了")])])):t("",!0)]))}},[["__scopeId","data-v-06127e56"]]);export{E as default};
