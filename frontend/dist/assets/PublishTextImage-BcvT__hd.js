import{r as a,c as l,j as e,y as s,C as t,I as i,L as n,G as c,af as u,M as o,aa as r,U as v,aC as p,z as d,H as m}from"./vue-vendor-Ba_vealp.js";import{_ as f,a as h}from"./index-C3P4JTuA.js";import{E as k}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const g={class:"publish-page"},y={class:"top-bar"},C={class:"form-content"},b={class:"placeholder"},w={class:"form-item"},_={class:"form-item content-item"},x={class:"char-count"},j={class:"upload-section"},M={class:"upload-grid"},z=["src"],I=["onClick"],L={class:"bottom-bar"},U=["disabled"],$={class:"picker-content"},H={class:"picker-header"},A={class:"topic-list"},D=["onClick"],E={class:"rules-content"},F=f({__name:"PublishTextImage",setup(f){const F=p(),R=a(""),T=a(""),V=a([]),B=a(null),G=a([]),N=a(!1),P=a(!1),q=a(!1),J=a(null),K=l(()=>R.value.trim()&&T.value.trim()),O=()=>{var a;null==(a=J.value)||a.click()},Q=a=>{const l=Array.from(a.target.files),e=9-V.value.length;l.slice(0,e).forEach(a=>{if(a.size>1048576)return void k.warning(`${a.name} 超过1M限制`);const l=new FileReader;l.onload=l=>{V.value.push({file:a,preview:l.target.result})},l.readAsDataURL(a)}),a.target.value=""},S=async()=>{var a,l,e;if(K.value&&!q.value)if(T.value.length>300)k.warning("内容不能超过300字");else{q.value=!0;try{const l=[];for(const e of V.value){const s=new FormData;s.append("file",e.file);const t=await h.post("/community/upload/image",s,{headers:{"Content-Type":"multipart/form-data"}});l.push((null==(a=t.data)?void 0:a.url)||t.url)}await h.post("/community/posts",{content:`${R.value}\n\n${T.value}`,images:l,topic_ids:B.value?[B.value.id]:[]}),k.success("发布成功"),F.back()}catch(s){k.error((null==(e=null==(l=s.response)?void 0:l.data)?void 0:e.detail)||"发布失败")}finally{q.value=!1}}};return e(()=>{(async()=>{try{const a=await h.get("/community/topics",{params:{level:2,page_size:50}});G.value=a.data||a||[]}catch(a){}})()}),(a,l)=>(d(),s("div",g,[t("div",y,[t("span",{class:"back",onClick:l[0]||(l[0]=l=>a.$router.back())},[...l[9]||(l[9]=[t("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},[t("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"})],-1)])]),l[10]||(l[10]=t("span",{class:"title"},"发布图文",-1)),t("span",{class:"rules",onClick:l[1]||(l[1]=a=>P.value=!0)},"规则")]),t("div",C,[t("div",{class:"form-item select-item",onClick:l[2]||(l[2]=a=>N.value=!0)},[l[11]||(l[11]=t("span",{class:"hash"},"#",-1)),t("span",b,n(B.value?B.value.name:"选择标签"),1),l[12]||(l[12]=t("span",{class:"arrow"},"›",-1))]),t("div",w,[c(t("input",{type:"text","onUpdate:modelValue":l[3]||(l[3]=a=>R.value=a),placeholder:"请填写标题",class:"title-input"},null,512),[[u,R.value]])]),t("div",_,[c(t("textarea",{"onUpdate:modelValue":l[4]||(l[4]=a=>T.value=a),placeholder:"有趣的介绍能让你的逼格提高N个档次！...",rows:"5"},null,512),[[u,T.value]]),t("span",x,n(T.value.length)+"/300",1)]),t("div",j,[l[14]||(l[14]=t("div",{class:"section-header"},[t("span",{class:"section-title"},"添加图集"),t("span",{class:"section-tip"},"最大每张1M以内 第一张默认为封面")],-1)),t("div",M,[(d(!0),s(o,null,r(V.value,(a,l)=>(d(),s("div",{key:l,class:"upload-item has-image"},[t("img",{src:a.preview,class:"preview-img"},null,8,z),t("span",{class:"remove-btn",onClick:a=>(a=>{V.value.splice(a,1)})(l)},"×",8,I)]))),128)),V.value.length<9?(d(),s("div",{key:0,class:"upload-item add-btn",onClick:O},[...l[13]||(l[13]=[t("span",{class:"plus"},"+",-1),t("span",{class:"text"},"上传图片",-1)])])):i("",!0)]),t("input",{type:"file",ref_key:"fileInput",ref:J,accept:"image/*",multiple:"",onChange:Q,style:{display:"none"}},null,544)])]),t("div",L,[t("button",{class:"submit-btn",disabled:!K.value||q.value,onClick:S},n(q.value?"发布中...":"确定发布"),9,U)]),N.value?(d(),s("div",{key:0,class:"topic-picker",onClick:l[6]||(l[6]=v(a=>N.value=!1,["self"]))},[t("div",$,[t("div",H,[l[15]||(l[15]=t("span",null,"选择话题",-1)),t("span",{class:"close",onClick:l[5]||(l[5]=a=>N.value=!1)},"×")]),t("div",A,[(d(!0),s(o,null,r(G.value,a=>{var l;return d(),s("div",{key:a.id,class:m(["topic-item",{active:(null==(l=B.value)?void 0:l.id)===a.id}]),onClick:l=>(a=>{B.value=a,N.value=!1})(a)}," #"+n(a.name),11,D)}),128))])])])):i("",!0),P.value?(d(),s("div",{key:1,class:"rules-modal",onClick:l[8]||(l[8]=v(a=>P.value=!1,["self"]))},[t("div",E,[l[16]||(l[16]=t("h3",null,"发布规则",-1)),l[17]||(l[17]=t("ul",null,[t("li",null,"图片大小不超过1M"),t("li",null,"最多上传9张图片"),t("li",null,"内容不超过300字"),t("li",null,"禁止发布违规内容")],-1)),t("button",{onClick:l[7]||(l[7]=a=>P.value=!1)},"我知道了")])])):i("",!0)]))}},[["__scopeId","data-v-a1f8eaad"]]);export{F as default};
