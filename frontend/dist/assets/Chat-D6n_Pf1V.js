import{c as a,az as e,r as t,j as s,aC as l,w as i,y as n,C as r,I as c,L as u,M as o,aa as v,G as d,af as m,ae as p,H as g,U as k,n as y,z as h}from"./vue-vendor-Ba_vealp.js";import{_}from"./ic_back-BPdSG6fy.js";import{_ as w,u as f,a as b}from"./index-C3P4JTuA.js";import{E as C,a as D}from"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const x={class:"chat-page"},B={class:"chat-header"},S={class:"user-name"},$=["src"],I=["src"],j={key:0,class:"messages-loading"},E={key:1,class:"empty-messages"},T={key:0,class:"message-avatar"},z=["src"],M={class:"message-content"},L={key:0,class:"message-nickname"},P={class:"nickname-text"},V=["src"],q={key:1,class:"message-nickname is-mine"},G={class:"nickname-text"},H=["src"],W={key:2,class:"message-bubble"},A={key:3,class:"message-image"},J=["src","onClick"],N={class:"message-time"},O={key:1,class:"message-avatar"},U=["src"],F={class:"chat-input-area"},K={class:"input-wrapper"},Q=["placeholder","disabled"],R={class:"picker-content"},X=["src"],Y=w({__name:"Chat",setup(w){const Y=e(),Z=l(),aa=f(),ea=a(()=>parseInt(Y.params.id)),ta=t({nickname:"",avatar:null}),sa=a(()=>aa.user),la=(a,e=1)=>{if(a)return a.startsWith("/")||a.startsWith("http")?a:"/"+a;return(a=>{const e=a%52;if(e<17)return`/images/avatars/icon_avatar_${e+1}.webp`;if(e<32)return`/images/avatars/DM_20251217202131_${String(e-17+1).padStart(3,"0")}.JPEG`;return`/images/avatars/DM_20251217202341_${String(e-32+1).padStart(3,"0")}.JPEG`})(parseInt(e)||1)},ia={1:"/images/backgrounds/vip_gold.webp",2:"/images/backgrounds/vip_1.webp",3:"/images/backgrounds/vip_2.webp",4:"/images/backgrounds/vip_3.webp",5:"/images/backgrounds/super_vip_red.webp"},na=a=>ia[a]||ia[1],ra=t([]),ca=t(""),ua=t(!0),oa=t(!1),va=t(100),da=t(null),ma=t(null),pa=t(!1),ga=t(null),ka=a(()=>ca.value.trim().length>0&&!oa.value),ya=async()=>{try{const a=await b.get(`/users/${ea.value}/profile`);a.data&&(ta.value=a.data)}catch(a){Y.query.nickname&&(ta.value.nickname=Y.query.nickname),Y.query.avatar&&(ta.value.avatar=Y.query.avatar)}},ha=async()=>{ua.value=!0;try{const a=await b.get(`/social/messages/${ea.value}`);ra.value=a.data||a||[],await y(),Da()}catch(a){ra.value=[]}finally{ua.value=!1}},_a=async()=>{var a,e,t,s;if(!ka.value)return;const l=ca.value.trim();if(l){oa.value=!0;try{const t=await b.post("/social/messages",{receiver_id:ea.value,content:l,message_type:"text"});ra.value.push({id:(null==(a=t.data)?void 0:a.message_id)||Date.now(),sender_id:null==(e=sa.value)?void 0:e.id,content:l,message_type:"text",is_mine:!0,created_at:(new Date).toISOString()}),ca.value="",await y(),Da(),C.success(`发送成功，消费${va.value}金币`)}catch(i){const a=(null==(s=null==(t=i.response)?void 0:t.data)?void 0:s.detail)||"发送失败，请重试";a.includes("金币余额不足")?D.confirm(`发送私信需要${va.value}金币，您的余额不足，是否前往充值？`,"金币不足",{confirmButtonText:"去充值",cancelButtonText:"取消",type:"warning"}).then(()=>{Z.push("/user/coins")}).catch(()=>{}):C.error(a)}finally{oa.value=!1}}},wa=()=>{pa.value=!0},fa=()=>{pa.value=!1,ma.value&&(ma.value.removeAttribute("capture"),ma.value.click())},ba=()=>{pa.value=!1,ma.value&&(ma.value.setAttribute("capture","environment"),ma.value.click())},Ca=async a=>{var e,t,s,l,i;const n=a.target.files[0];if(n)if(n.type.startsWith("image/"))if(n.size>10485760)C.error("图片大小不能超过10MB");else{oa.value=!0;try{const a=new FormData;a.append("file",n);const l=await b.post("/upload/image",a,{headers:{"Content-Type":"multipart/form-data"}}),i=(null==(e=l.data)?void 0:e.url)||l.data,r=await b.post("/social/messages",{receiver_id:ea.value,content:i,message_type:"image"});ra.value.push({id:(null==(t=r.data)?void 0:t.message_id)||Date.now(),sender_id:null==(s=sa.value)?void 0:s.id,content:i,message_type:"image",is_mine:!0,created_at:(new Date).toISOString()}),await y(),Da(),C.success(`发送成功，消费${va.value}金币`)}catch(r){const a=(null==(i=null==(l=r.response)?void 0:l.data)?void 0:i.detail)||"发送图片失败，请重试";a.includes("金币余额不足")?D.confirm(`发送私信需要${va.value}金币，您的余额不足，是否前往充值？`,"金币不足",{confirmButtonText:"去充值",cancelButtonText:"取消",type:"warning"}).then(()=>{Z.push("/user/coins")}).catch(()=>{}):C.error(a)}finally{oa.value=!1,ma.value&&(ma.value.value="")}}else C.error("请选择图片文件")},Da=()=>{da.value&&(da.value.scrollTop=da.value.scrollHeight)},xa=a=>{if(!a)return"";const e=new Date(a),t=new Date,s=e.toDateString()===t.toDateString(),l=new Date(t);l.setDate(l.getDate()-1);const i=e.toDateString()===l.toDateString(),n=e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});return s?n:i?`昨天 ${n}`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})+" "+n},Ba=()=>{Z.back()},Sa=()=>{Z.push(`/user/member/${ea.value}`)};return s(async()=>{if(!aa.token)return C.warning("请先登录"),void Z.push("/user/settings/recovery");await(async()=>{var a;try{const e=await b.get("/social/messages/cost");(null==(a=e.data)?void 0:a.cost)&&(va.value=e.data.cost)}catch(e){}})(),await ya(),await ha(),(async()=>{try{await b.post(`/notifications/mark-read?notification_type=private&target_user_id=${ea.value}`)}catch(a){}})()}),i(ea,async a=>{a&&(await ya(),await ha())}),(a,e)=>(h(),n("div",x,[r("div",B,[r("div",{class:"back-btn",onClick:Ba},[...e[4]||(e[4]=[r("img",{src:_,alt:"返回",class:"back-icon"},null,-1)])]),r("div",S,[r("span",null,u(ta.value.nickname||"用户"),1),ta.value.vip_level>0?(h(),n("img",{key:0,src:na(ta.value.vip_level),class:"header-vip-badge",alt:"VIP"},null,8,$)):c("",!0)]),r("div",{class:"user-avatar",onClick:Sa},[r("img",{src:la(ta.value.avatar,ea.value),alt:"avatar"},null,8,I)])]),r("div",{class:"chat-messages",ref_key:"messagesContainer",ref:da},[ua.value?(h(),n("div",j,[...e[5]||(e[5]=[r("div",{class:"loading-spinner"},null,-1)])])):0===ra.value.length?(h(),n("div",E,[...e[6]||(e[6]=[r("p",null,"暂无消息，快来打个招呼吧~",-1)])])):(h(!0),n(o,{key:2},v(ra.value,a=>{var e,t,s,l,i;return h(),n("div",{key:a.id,class:g(["message-item",{"is-mine":a.is_mine}])},[a.is_mine?c("",!0):(h(),n("div",T,[r("img",{src:la(ta.value.avatar,ea.value),alt:""},null,8,z)])),r("div",M,[a.is_mine?(h(),n("div",q,[r("span",G,u((null==(e=sa.value)?void 0:e.nickname)||"我"),1),(null==(t=sa.value)?void 0:t.vip_level)>0?(h(),n("img",{key:0,src:na(null==(s=sa.value)?void 0:s.vip_level),class:"vip-badge",alt:"VIP"},null,8,H)):c("",!0)])):(h(),n("div",L,[r("span",P,u(ta.value.nickname||"用户"),1),ta.value.vip_level>0?(h(),n("img",{key:0,src:na(ta.value.vip_level),class:"vip-badge",alt:"VIP"},null,8,V)):c("",!0)])),"text"===a.message_type?(h(),n("div",W,u(a.content),1)):"image"===a.message_type?(h(),n("div",A,[r("img",{src:a.content,alt:"图片",onClick:e=>{return t=a.content,void(ga.value=t);var t}},null,8,J)])):c("",!0),r("div",N,u(xa(a.created_at)),1)]),a.is_mine?(h(),n("div",O,[r("img",{src:la(null==(l=sa.value)?void 0:l.avatar,(null==(i=sa.value)?void 0:i.id)||1),alt:""},null,8,U)])):c("",!0)],2)}),128))],512),r("div",F,[r("div",K,[d(r("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>ca.value=a),placeholder:"私信需要消费"+va.value+"金币",onKeydown:p(_a,["enter"]),disabled:oa.value},null,40,Q),[[m,ca.value]])]),r("div",{class:"action-btn",onClick:wa},[...e[7]||(e[7]=[r("img",{src:"/images/backgrounds/%E4%B8%8B%E8%BD%BD%20(5).webp",alt:"上传图片",class:"action-icon"},null,-1)])]),r("div",{class:g(["action-btn send-btn",{disabled:!ka.value}]),onClick:_a},[...e[8]||(e[8]=[r("img",{src:"/images/backgrounds/%E4%B8%8B%E8%BD%BD%20(4).webp",alt:"发送",class:"action-icon"},null,-1)])],2),r("input",{type:"file",ref_key:"imageInput",ref:ma,accept:"image/*",onChange:Ca,style:{display:"none"},capture:"environment"},null,544)]),pa.value?(h(),n("div",{key:0,class:"image-picker-modal",onClick:e[2]||(e[2]=k(a=>pa.value=!1,["self"]))},[r("div",R,[r("div",{class:"picker-option",onClick:fa},[...e[9]||(e[9]=[r("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none"},[r("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",stroke:"currentColor","stroke-width":"2"}),r("circle",{cx:"8.5",cy:"8.5",r:"1.5",fill:"currentColor"}),r("path",{d:"M21 15L16 10L5 21",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),r("span",null,"从相册选择",-1)])]),r("div",{class:"picker-option",onClick:ba},[...e[10]||(e[10]=[r("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none"},[r("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),r("circle",{cx:"12",cy:"13",r:"4",stroke:"currentColor","stroke-width":"2"})],-1),r("span",null,"拍照",-1)])]),r("div",{class:"picker-cancel",onClick:e[1]||(e[1]=a=>pa.value=!1)},"取消")])])):c("",!0),ga.value?(h(),n("div",{key:1,class:"image-preview-modal",onClick:e[3]||(e[3]=a=>ga.value=null)},[r("img",{src:ga.value,alt:"预览"},null,8,X)])):c("",!0)]))}},[["__scopeId","data-v-9a701836"]]);export{Y as default};
