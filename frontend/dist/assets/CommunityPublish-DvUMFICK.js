import{r as a,c as l,j as e,y as s,C as i,L as t,G as n,af as u,I as c,M as o,aa as v,aC as p,z as d,H as r,ab as m}from"./vue-vendor-Ba_vealp.js";import{_ as y,a as b}from"./index-C3P4JTuA.js";import"./element-plus-DlIn_qXi.js";import"./utils-DflAyOWx.js";const g={class:"publish-page"},f={class:"top-bar"},h=["disabled"],k={class:"content-area"},C={class:"char-count"},_={class:"images-section"},x={class:"images-grid"},j=["src"],w=["onClick"],I={class:"topics-section"},z={class:"topics-list"},U=["onClick"],V={class:"visibility-section"},A={class:"visibility-options"},D=["value"],F=y({__name:"CommunityPublish",setup(y){const F=p(),G=a(""),H=a([]),L=a([]),M=a("public"),O=a([]),P=a(!1),$=a(null),q=[{label:"公开",value:"public"},{label:"仅关注",value:"followers"},{label:"仅自己",value:"private"}],B=l(()=>G.value.trim()||H.value.length>0),E=()=>{var a;return null==(a=$.value)?void 0:a.click()},J=async a=>{const l=Array.from(a.target.files);if(l.length){for(const a of l){if(H.value.length>=9)break;const l=new FormData;l.append("file",a);try{const a=await b.post("/community/upload/image",l);H.value.push(a.data.url)}catch(e){}}a.target.value=""}},K=async()=>{var a,l;if(B.value&&!P.value){P.value=!0;try{await b.post("/community/posts",{content:G.value,images:H.value,topic_ids:L.value,visibility:M.value}),F.replace("/user/community")}catch(e){alert((null==(l=null==(a=e.response)?void 0:a.data)?void 0:l.detail)||"发布失败")}finally{P.value=!1}}};return e(async()=>{try{const a=await b.get("/community/topics",{params:{page_size:20}});O.value=a.data||[]}catch(a){}}),(a,l)=>(d(),s("div",g,[i("div",f,[i("span",{class:"back",onClick:l[0]||(l[0]=l=>a.$router.back())},"←"),l[3]||(l[3]=i("span",{class:"title"},"发布动态",-1)),i("button",{class:"publish-btn",disabled:!B.value||P.value,onClick:K},t(P.value?"发布中...":"发布"),9,h)]),i("div",k,[n(i("textarea",{"onUpdate:modelValue":l[1]||(l[1]=a=>G.value=a),placeholder:"分享你的想法...",maxlength:"2000"},null,512),[[u,G.value]]),i("div",C,t(G.value.length)+"/2000",1)]),i("div",_,[i("div",x,[(d(!0),s(o,null,v(H.value,(a,l)=>(d(),s("div",{key:l,class:"image-item"},[i("img",{src:a},null,8,j),i("span",{class:"remove",onClick:a=>(a=>H.value.splice(a,1))(l)},"×",8,w)]))),128)),H.value.length<9?(d(),s("div",{key:0,class:"add-image",onClick:E},[...l[4]||(l[4]=[i("span",null,"+",-1),i("span",{class:"text"},"添加图片",-1)])])):c("",!0)]),i("input",{type:"file",ref_key:"fileInput",ref:$,accept:"image/*",multiple:"",onChange:J,hidden:""},null,544)]),i("div",I,[l[5]||(l[5]=i("div",{class:"section-title"},"添加话题",-1)),i("div",z,[(d(!0),s(o,null,v(O.value,a=>(d(),s("span",{key:a.id,class:r(["topic-item",{selected:L.value.includes(a.id)}]),onClick:l=>(a=>{const l=L.value.indexOf(a);l>-1?L.value.splice(l,1):L.value.length<3&&L.value.push(a)})(a.id)}," #"+t(a.name),11,U))),128))])]),i("div",V,[l[6]||(l[6]=i("div",{class:"section-title"},"谁可以看",-1)),i("div",A,[(d(),s(o,null,v(q,a=>i("label",{key:a.value},[n(i("input",{type:"radio","onUpdate:modelValue":l[2]||(l[2]=a=>M.value=a),value:a.value},null,8,D),[[m,M.value]]),i("span",null,t(a.label),1)])),64))])])]))}},[["__scopeId","data-v-864c050f"]]);export{F as default};
