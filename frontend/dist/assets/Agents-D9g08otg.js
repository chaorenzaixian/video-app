/* empty css             *//* empty css                   *//* empty css                   *//* empty css                 *//* empty css                 *//* empty css                       *//* empty css                   *//* empty css                     *//* empty css                        *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  */import{bl as e,aM as l,bs as a,bt as t,bk as u,E as s,bh as n,bm as o,aQ as d,a6 as i,bi as r,bj as v,aR as m,aS as p,bv as c,bf as _,by as f,aT as g,bC as b,aL as y,a as h}from"./element-plus-DlIn_qXi.js";import{_ as w,a as V}from"./index-C3P4JTuA.js";import{r as k,j,y as x,C,G as U,O as R,L as $,F as z,E as F,z as Y,M,aa as L,K as O,u as q,I as D}from"./vue-vendor-Ba_vealp.js";import"./utils-DflAyOWx.js";const E={class:"agents-page"},H={class:"page-header"},I={class:"stats-cards"},S={class:"stat-card"},B={class:"stat-value"},G={class:"stat-card pending"},K={class:"stat-value"},A={class:"stat-card"},J={class:"stat-value"},P={class:"filter-bar"},Q={class:"filter-actions"},T={key:0,style:{color:"#999","margin-left":"8px"}},N=w({__name:"Agents",setup(w){const N=k(!1),W=k([]),X=k(1),Z=k(20),ee=k(0),le=k({status:"",level:""}),ae=k({total_agents:0,pending_agents:0,total_commission:0}),te=k([]),ue=k(!1),se=k(!1),ne=k(null),oe=k({level:1,customRate:null}),de=k({level:0,status:"active",customRate:null}),ie=k([{level:0,name:"普通用户",rate:0},{level:1,name:"普通级",rate:40},{level:2,name:"青铜级",rate:46},{level:3,name:"白银级",rate:52},{level:4,name:"黄金级",rate:58},{level:5,name:"铂金级",rate:64},{level:6,name:"钻石级",rate:70}]),re=e=>{if(-1!==e){ie.value.find(l=>l.level===e)&&(de.value.customRate=null)}else de.value.customRate=50},ve=k(!1),me=k(!1),pe=k(!1),ce=k([]),_e=k({mode:"new",username:"",password:"",phone:"",user_id:null,agent_level:2,commission_rate:null,remark:""}),fe=async()=>{try{const e=await V.get("/admin/promotion/stats");ae.value=e.data||e}catch(e){}},ge=async()=>{N.value=!0;try{const e=await V.get("/admin/agents",{params:{page:X.value,page_size:Z.value,status:le.value.status||void 0,level:le.value.level||void 0}}),l=e.data||e;W.value=l.items,ee.value=l.total}catch(e){s.error("获取代理列表失败")}finally{N.value=!1}},be=async()=>{var e,l;try{let e=null;oe.value.customRate&&(e=oe.value.customRate/100),await V.post(`/admin/agents/${ne.value.user_id}/approve`,null,{params:{level:oe.value.level,commission_rate:e}}),s.success("审批通过"),ue.value=!1,ge(),fe()}catch(a){s.error((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.detail)||"操作失败")}},ye=async()=>{var e,l;try{let e,l=de.value.level;if(-1===de.value.level&&de.value.customRate)e=de.value.customRate/100,l=ne.value.agent_level;else{const l=ie.value.find(e=>e.level===de.value.level);e=l?l.rate/100:.4}await V.post(`/admin/agents/${ne.value.user_id}/update`,null,{params:{level:l,status:de.value.status,commission_rate:e}}),s.success("保存成功"),se.value=!1,ge()}catch(a){s.error((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.detail)||"操作失败")}},he=e=>{const l=ie.value.find(l=>l.level===e);return l?l.name:"普通用户"},we=e=>({inactive:"未激活",pending:"待审核",active:"已激活",frozen:"已冻结",rejected:"已拒绝"}[e]||e),Ve=e=>y(e).format("YYYY-MM-DD HH:mm"),ke=e=>{te.value=e},je=async()=>{const e=te.value.filter(e=>"pending"===e.agent_status);if(0!==e.length)try{await h.confirm(`确定批量通过 ${e.length} 个代理申请？`,"确认");for(const l of e)await V.post(`/admin/agents/${l.user_id}/approve`,null,{params:{level:2}});s.success(`成功通过 ${e.length} 个代理`),ge(),fe()}catch(l){"cancel"!==l&&s.error("操作失败")}else s.warning("请选择待审核的代理")},xe=async()=>{const e=te.value.filter(e=>"pending"===e.agent_status);if(0!==e.length)try{await h.confirm(`确定批量拒绝 ${e.length} 个代理申请？`,"确认",{type:"warning"});for(const l of e)await V.post(`/admin/agents/${l.user_id}/reject`);s.success(`成功拒绝 ${e.length} 个代理`),ge(),fe()}catch(l){"cancel"!==l&&s.error("操作失败")}else s.warning("请选择待审核的代理")},Ce=()=>{const e=W.value.map(e=>({"用户名":e.username,"等级":he(e.agent_level),"状态":we(e.agent_status),"佣金比例":(100*e.commission_rate).toFixed(0)+"%","有效邀请":e.valid_invites,"累计佣金":e.total_commission.toFixed(2),"可提现":e.available_balance.toFixed(2),"申请时间":e.agent_applied_at?Ve(e.agent_applied_at):""})),l=[Object.keys(e[0]||{}).join(","),...e.map(e=>Object.values(e).join(","))].join("\n"),a=new Blob(["\ufeff"+l],{type:"text/csv;charset=utf-8"}),t=URL.createObjectURL(a),u=document.createElement("a");u.href=t,u.download=`代理列表_${y().format("YYYYMMDD")}.csv`,u.click(),URL.revokeObjectURL(t),s.success("导出成功")},Ue=async e=>{if(!e||e.length<1)ce.value=[];else{pe.value=!0;try{const l=await V.get("/admin/agents/search-users",{params:{keyword:e}});ce.value=l.data}catch(l){}finally{pe.value=!1}}},Re=async()=>{var e,l;if("new"===_e.value.mode){if(!_e.value.username||!_e.value.password)return void s.warning("请填写用户名和密码")}else if(!_e.value.user_id)return void s.warning("请选择一个用户");me.value=!0;try{const e={agent_level:_e.value.agent_level,commission_rate:_e.value.commission_rate,remark:_e.value.remark};"new"===_e.value.mode?(e.username=_e.value.username,e.password=_e.value.password,e.phone=_e.value.phone||null):e.user_id=_e.value.user_id,await V.post("/admin/agents/create",e),s.success("代理创建成功"),ve.value=!1,_e.value={mode:"new",username:"",password:"",phone:"",user_id:null,agent_level:2,commission_rate:null,remark:""},ce.value=[],ge(),fe()}catch(a){s.error((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.detail)||"创建失败")}finally{me.value=!1}};return j(()=>{fe(),ge(),(async()=>{try{const e=await V.get("/config/agent-levels"),l=e.data||e;l.levels&&l.levels.length>0&&(ie.value=[{level:0,name:"普通用户",rate:0},...l.levels.map(e=>({level:e.level,name:e.name,rate:parseInt(e.rate)})).reverse()])}catch(e){}})()}),(y,w)=>{const k=o,j=e,$e=d,ze=l,Fe=r,Ye=v,Me=n,Le=t,Oe=p,qe=c,De=m,Ee=u,He=f,Ie=_,Se=g,Be=b,Ge=a;return Y(),x("div",E,[C("div",H,[w[27]||(w[27]=C("h2",null,"代理管理",-1)),C("div",I,[C("div",S,[C("span",B,$(ae.value.total_agents),1),w[24]||(w[24]=C("span",{class:"stat-label"},"总代理数",-1))]),C("div",G,[C("span",K,$(ae.value.pending_agents),1),w[25]||(w[25]=C("span",{class:"stat-label"},"待审核",-1))]),C("div",A,[C("span",J,"¥"+$(ae.value.total_commission.toFixed(2)),1),w[26]||(w[26]=C("span",{class:"stat-label"},"总佣金",-1))])])]),C("div",P,[R(j,{modelValue:le.value.status,"onUpdate:modelValue":w[0]||(w[0]=e=>le.value.status=e),placeholder:"状态筛选",clearable:"",onChange:ge},{default:z(()=>[R(k,{label:"全部",value:""}),R(k,{label:"待审核",value:"pending"}),R(k,{label:"已激活",value:"active"}),R(k,{label:"已拒绝",value:"rejected"}),R(k,{label:"已冻结",value:"frozen"})]),_:1},8,["modelValue"]),R(j,{modelValue:le.value.level,"onUpdate:modelValue":w[1]||(w[1]=e=>le.value.level=e),placeholder:"等级筛选",clearable:"",onChange:ge},{default:z(()=>[R(k,{label:"全部等级",value:""}),(Y(!0),x(M,null,L(ie.value.filter(e=>e.level>0),e=>(Y(),F(k,{key:e.level,label:e.name,value:e.level},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),C("div",Q,[R(ze,{type:"primary",onClick:w[2]||(w[2]=e=>ve.value=!0)},{default:z(()=>[R($e,null,{default:z(()=>[R(q(i))]),_:1}),w[28]||(w[28]=O(" 添加代理 ",-1))]),_:1}),R(ze,{type:"success",disabled:!te.value.length,onClick:je},{default:z(()=>[O(" 批量通过 ("+$(te.value.length)+") ",1)]),_:1},8,["disabled"]),R(ze,{type:"danger",disabled:!te.value.length,onClick:xe},{default:z(()=>[...w[29]||(w[29]=[O(" 批量拒绝 ",-1)])]),_:1},8,["disabled"]),R(ze,{onClick:Ce},{default:z(()=>[...w[30]||(w[30]=[O("导出数据",-1)])]),_:1})])]),U((Y(),F(Me,{data:W.value,stripe:"",onSelectionChange:ke},{default:z(()=>[R(Fe,{type:"selection",width:"50"}),R(Fe,{prop:"username",label:"用户名",width:"120"}),R(Fe,{prop:"agent_level",label:"代理等级",width:"120"},{default:z(({row:e})=>{return[R(Ye,{type:(l=e.agent_level,["info","","success","warning","danger"][l]||"info")},{default:z(()=>[O($(he(e.agent_level)),1)]),_:2},1032,["type"])];var l}),_:1}),R(Fe,{prop:"agent_status",label:"状态",width:"100"},{default:z(({row:e})=>{return[R(Ye,{type:(l=e.agent_status,{inactive:"info",pending:"warning",active:"success",frozen:"danger",rejected:"info"}[l]||"info")},{default:z(()=>[O($(we(e.agent_status)),1)]),_:2},1032,["type"])];var l}),_:1}),R(Fe,{prop:"commission_rate",label:"佣金比例",width:"100"},{default:z(({row:e})=>[O($((100*e.commission_rate).toFixed(0))+"% ",1)]),_:1}),R(Fe,{prop:"valid_invites",label:"有效邀请",width:"100"}),R(Fe,{prop:"total_commission",label:"累计佣金",width:"120"},{default:z(({row:e})=>[O(" ¥"+$(e.total_commission.toFixed(2)),1)]),_:1}),R(Fe,{prop:"available_balance",label:"可提现",width:"120"},{default:z(({row:e})=>[O(" ¥"+$(e.available_balance.toFixed(2)),1)]),_:1}),R(Fe,{prop:"agent_applied_at",label:"申请时间",width:"160"},{default:z(({row:e})=>[O($(e.agent_applied_at?Ve(e.agent_applied_at):"-"),1)]),_:1}),R(Fe,{label:"操作",width:"180",fixed:"right"},{default:z(({row:e})=>["pending"===e.agent_status?(Y(),x(M,{key:0},[R(ze,{type:"success",size:"small",onClick:l=>{return a=e,ne.value=a,oe.value={level:1,customRate:null},void(ue.value=!0);var a}},{default:z(()=>[...w[31]||(w[31]=[O("通过",-1)])]),_:1},8,["onClick"]),R(ze,{type:"danger",size:"small",onClick:l=>(async e=>{try{await h.confirm("确定拒绝该代理申请?","提示",{type:"warning"}),await V.post(`/admin/agents/${e.user_id}/reject`),s.success("已拒绝"),ge(),fe()}catch(l){"cancel"!==l&&s.error("操作失败")}})(e)},{default:z(()=>[...w[32]||(w[32]=[O("拒绝",-1)])]),_:1},8,["onClick"])],64)):(Y(),F(ze,{key:1,type:"primary",size:"small",onClick:l=>(e=>{ne.value=e;const l=Math.round(100*e.commission_rate),a=ie.value.find(l=>l.level===e.agent_level),t=a&&a.rate!==l;de.value={level:t?-1:e.agent_level,status:e.agent_status,customRate:t?l:null},se.value=!0})(e)},{default:z(()=>[...w[33]||(w[33]=[O("编辑",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"])),[[Ge,N.value]]),R(Le,{"current-page":X.value,"onUpdate:currentPage":w[3]||(w[3]=e=>X.value=e),"page-size":Z.value,"onUpdate:pageSize":w[4]||(w[4]=e=>Z.value=e),total:ee.value,layout:"total, prev, pager, next",onCurrentChange:ge},null,8,["current-page","page-size","total"]),R(Ee,{modelValue:ue.value,"onUpdate:modelValue":w[8]||(w[8]=e=>ue.value=e),title:"审批代理",width:"400px"},{footer:z(()=>[R(ze,{onClick:w[7]||(w[7]=e=>ue.value=!1)},{default:z(()=>[...w[35]||(w[35]=[O("取消",-1)])]),_:1}),R(ze,{type:"primary",onClick:be},{default:z(()=>[...w[36]||(w[36]=[O("确认通过",-1)])]),_:1})]),default:z(()=>[R(De,{model:oe.value,"label-width":"80px"},{default:z(()=>[R(Oe,{label:"用户名"},{default:z(()=>{var e;return[C("span",null,$(null==(e=ne.value)?void 0:e.username),1)]}),_:1}),R(Oe,{label:"邀请人数"},{default:z(()=>{var e;return[C("span",null,$(null==(e=ne.value)?void 0:e.valid_invites),1)]}),_:1}),R(Oe,{label:"代理等级"},{default:z(()=>[R(j,{modelValue:oe.value.level,"onUpdate:modelValue":w[5]||(w[5]=e=>oe.value.level=e)},{default:z(()=>[(Y(!0),x(M,null,L(ie.value.filter(e=>e.level>0),e=>(Y(),F(k,{key:e.level,label:`${e.name} (${e.rate}%)`,value:e.level},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),R(Oe,{label:"自定义佣金"},{default:z(()=>[R(qe,{modelValue:oe.value.customRate,"onUpdate:modelValue":w[6]||(w[6]=e=>oe.value.customRate=e),min:1,max:100,precision:0,style:{width:"150px"}},null,8,["modelValue"]),w[34]||(w[34]=C("span",{style:{"margin-left":"8px"}},"% (留空使用等级默认)",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),R(Ee,{modelValue:se.value,"onUpdate:modelValue":w[13]||(w[13]=e=>se.value=e),title:"编辑代理",width:"450px"},{footer:z(()=>[R(ze,{onClick:w[12]||(w[12]=e=>se.value=!1)},{default:z(()=>[...w[39]||(w[39]=[O("取消",-1)])]),_:1}),R(ze,{type:"primary",onClick:ye},{default:z(()=>[...w[40]||(w[40]=[O("保存",-1)])]),_:1})]),default:z(()=>[R(De,{model:de.value,"label-width":"100px"},{default:z(()=>[R(Oe,{label:"用户名"},{default:z(()=>{var e;return[C("span",null,$(null==(e=ne.value)?void 0:e.username),1)]}),_:1}),R(Oe,{label:"代理等级"},{default:z(()=>[R(j,{modelValue:de.value.level,"onUpdate:modelValue":w[9]||(w[9]=e=>de.value.level=e),onChange:re},{default:z(()=>[(Y(!0),x(M,null,L(ie.value,e=>(Y(),F(k,{key:e.level,label:`${e.name} (${e.rate}%)`,value:e.level},null,8,["label","value"]))),128)),R(k,{label:"自定义",value:-1})]),_:1},8,["modelValue"])]),_:1}),-1===de.value.level||de.value.customRate?(Y(),F(Oe,{key:0,label:"自定义佣金"},{default:z(()=>[R(qe,{modelValue:de.value.customRate,"onUpdate:modelValue":w[10]||(w[10]=e=>de.value.customRate=e),min:1,max:100,precision:0,style:{width:"150px"}},null,8,["modelValue"]),w[37]||(w[37]=C("span",{style:{"margin-left":"8px"}},"%",-1)),w[38]||(w[38]=C("div",{style:{color:"#909399","font-size":"12px","margin-top":"4px"}}," 可设置1%-100%的自定义佣金比例 ",-1))]),_:1})):D("",!0),R(Oe,{label:"状态"},{default:z(()=>[R(j,{modelValue:de.value.status,"onUpdate:modelValue":w[11]||(w[11]=e=>de.value.status=e)},{default:z(()=>[R(k,{label:"已激活",value:"active"}),R(k,{label:"已冻结",value:"frozen"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),R(Ee,{modelValue:ve.value,"onUpdate:modelValue":w[23]||(w[23]=e=>ve.value=e),title:"添加代理",width:"500px"},{footer:z(()=>[R(ze,{onClick:w[22]||(w[22]=e=>ve.value=!1)},{default:z(()=>[...w[46]||(w[46]=[O("取消",-1)])]),_:1}),R(ze,{type:"primary",onClick:Re,loading:me.value},{default:z(()=>[...w[47]||(w[47]=[O("确认添加",-1)])]),_:1},8,["loading"])]),default:z(()=>[R(De,{model:_e.value,"label-width":"100px"},{default:z(()=>[R(Oe,{label:"选择方式"},{default:z(()=>[R(Ie,{modelValue:_e.value.mode,"onUpdate:modelValue":w[14]||(w[14]=e=>_e.value.mode=e)},{default:z(()=>[R(He,{value:"new"},{default:z(()=>[...w[41]||(w[41]=[O("新建账号",-1)])]),_:1}),R(He,{value:"existing"},{default:z(()=>[...w[42]||(w[42]=[O("选择现有用户",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"new"===_e.value.mode?(Y(),x(M,{key:0},[R(Oe,{label:"用户名",required:""},{default:z(()=>[R(Se,{modelValue:_e.value.username,"onUpdate:modelValue":w[15]||(w[15]=e=>_e.value.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),R(Oe,{label:"密码",required:""},{default:z(()=>[R(Se,{modelValue:_e.value.password,"onUpdate:modelValue":w[16]||(w[16]=e=>_e.value.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1}),R(Oe,{label:"手机号"},{default:z(()=>[R(Se,{modelValue:_e.value.phone,"onUpdate:modelValue":w[17]||(w[17]=e=>_e.value.phone=e),placeholder:"可选"},null,8,["modelValue"])]),_:1})],64)):(Y(),F(Oe,{key:1,label:"搜索用户",required:""},{default:z(()=>[R(j,{modelValue:_e.value.user_id,"onUpdate:modelValue":w[18]||(w[18]=e=>_e.value.user_id=e),filterable:"",remote:"","reserve-keyword":"",placeholder:"输入用户名或手机号搜索","remote-method":Ue,loading:pe.value,style:{width:"100%"}},{default:z(()=>[(Y(!0),x(M,null,L(ce.value,e=>(Y(),F(k,{key:e.id,label:e.username+(e.phone?" ("+e.phone+")":""),value:e.id,disabled:e.is_agent},{default:z(()=>[C("span",null,$(e.username),1),e.phone?(Y(),x("span",T,$(e.phone),1)):D("",!0),e.is_agent?(Y(),F(Ye,{key:1,size:"small",type:"warning",style:{"margin-left":"8px"}},{default:z(()=>[...w[43]||(w[43]=[O("已是代理",-1)])]),_:1})):D("",!0)]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})),R(Be,{"content-position":"left"},{default:z(()=>[...w[44]||(w[44]=[O("代理设置",-1)])]),_:1}),R(Oe,{label:"代理等级"},{default:z(()=>[R(j,{modelValue:_e.value.agent_level,"onUpdate:modelValue":w[19]||(w[19]=e=>_e.value.agent_level=e),style:{width:"100%"}},{default:z(()=>[(Y(!0),x(M,null,L(ie.value.filter(e=>e.level>0),e=>(Y(),F(k,{key:e.level,label:`${e.name} (${e.rate}%)`,value:e.level},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),R(Oe,{label:"自定义佣金"},{default:z(()=>[R(qe,{modelValue:_e.value.commission_rate,"onUpdate:modelValue":w[20]||(w[20]=e=>_e.value.commission_rate=e),min:1,max:100,precision:0},null,8,["modelValue"]),w[45]||(w[45]=C("span",{style:{"margin-left":"8px"}},"%（留空使用等级默认比例）",-1))]),_:1}),R(Oe,{label:"备注"},{default:z(()=>[R(Se,{modelValue:_e.value.remark,"onUpdate:modelValue":w[21]||(w[21]=e=>_e.value.remark=e),type:"textarea",rows:2,placeholder:"可选备注"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-551d8cc8"]]);export{N as default};
