# è§†é¢‘åº”ç”¨é¡¹ç›® - æ·±åº¦æ¶æ„åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹è§†é¢‘åº”ç”¨é¡¹ç›®è¿›è¡Œäº†å…¨é¢çš„ä»£ç æ¶æ„å’Œæ€§èƒ½åˆ†æï¼Œæ¶µç›–åç«¯APIã€æ•°æ®åº“è®¾è®¡ã€å‰ç«¯æ€§èƒ½ã€å®‰å…¨æ€§å’Œä»£ç è´¨é‡ç­‰äº”ä¸ªå…³é”®é¢†åŸŸã€‚

**å…³é”®å‘ç°ï¼š**
- ğŸ”´ **ä¸¥é‡é—®é¢˜**ï¼šN+1æŸ¥è¯¢é—®é¢˜ã€ç¼ºå°‘ç¼“å­˜ã€SQLæ³¨å…¥é£é™©ã€XSSæ¼æ´
- ğŸŸ  **é‡è¦é—®é¢˜**ï¼šæ•°æ®åº“ç´¢å¼•ç¼ºå¤±ã€å¤§å‹Vueç»„ä»¶ã€å†…å­˜æ³„æ¼é£é™©
- ğŸŸ¡ **æ”¹è¿›å»ºè®®**ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„ã€ä»£ç é‡å¤ã€è®¤è¯æœºåˆ¶ä¸å¤Ÿå®‰å…¨

---

## 1. åç«¯APIæ€§èƒ½é—®é¢˜

### 1.1 N+1æŸ¥è¯¢é—®é¢˜ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`backend/app/api/community.py`

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```python
# âŒ è·å–è¯„è®ºåˆ—è¡¨ - å­˜åœ¨N+1æŸ¥è¯¢
@router.get("/posts/{post_id}/comments")
async def get_comments(...):
    comments = result.scalars().all()
    
    response = []
    for comment in comments:  # å¾ªç¯ä¸­æŸ¥è¯¢
        user_result = await db.execute(select(User).where(User.id == comment.user_id))
        comment_user = user_result.scalar_one()  # N+1: æ¯æ¡è¯„è®ºéƒ½æŸ¥è¯¢ä¸€æ¬¡ç”¨æˆ·
        user_brief = await get_user_brief(db, comment_user)  # å†æŸ¥è¯¢VIPä¿¡æ¯
        
        reply_user_result = await db.execute(...)  # åˆæ˜¯N+1
        reply_user = reply_user_result.scalar_one()
```

**å½±å“èŒƒå›´ï¼š**
- `get_posts()` - æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ã€VIPã€ç‚¹èµçŠ¶æ€ï¼ˆå·²ä¼˜åŒ–ï¼‰
- `get_comments()` - æ¯æ¡è¯„è®ºæŸ¥è¯¢ç”¨æˆ·å’ŒVIPï¼ˆæœªä¼˜åŒ–ï¼‰
- `get_followers()` - æ¯ä¸ªç²‰ä¸æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆæœªä¼˜åŒ–ï¼‰
- `get_following()` - æ¯ä¸ªå…³æ³¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆæœªä¼˜åŒ–ï¼‰
- `get_topics()` - æ¯ä¸ªè¯é¢˜æŸ¥è¯¢å…³æ³¨çŠ¶æ€ï¼ˆæœªä¼˜åŒ–ï¼‰

**ä¿®å¤æ–¹æ¡ˆï¼š**
```python
# âœ… ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
async def get_comments(...):
    comments = result.scalars().all()
    
    # æ‰¹é‡è·å–ç”¨æˆ·ID
    user_ids = list(set(c.user_id for c in comments))
    
    # ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    users_result = await db.execute(select(User).where(User.id.in_(user_ids)))
    users_map = {u.id: u for u in users_result.scalars().all()}
    
    # ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰VIPä¿¡æ¯
    vip_result = await db.execute(
        select(UserVIP).where(UserVIP.user_id.in_(user_ids))
    )
    vip_map = {v.user_id: v for v in vip_result.scalars().all()}
    
    # æ„å»ºå“åº”ï¼ˆæ— é¢å¤–æŸ¥è¯¢ï¼‰
    for comment in comments:
        user = users_map[comment.user_id]
        vip = vip_map.get(comment.user_id)
```

**æ€§èƒ½å½±å“ï¼š**
- å½“å‰ï¼šè·å–20æ¡è¯„è®º = 1æ¬¡æŸ¥è¯¢è¯„è®º + 20æ¬¡æŸ¥è¯¢ç”¨æˆ· + 20æ¬¡æŸ¥è¯¢VIP = **41æ¬¡æŸ¥è¯¢**
- ä¼˜åŒ–åï¼š1æ¬¡æŸ¥è¯¢è¯„è®º + 1æ¬¡æŸ¥è¯¢ç”¨æˆ· + 1æ¬¡æŸ¥è¯¢VIP = **3æ¬¡æŸ¥è¯¢**
- **æ€§èƒ½æå‡ï¼š93%**

---

### 1.2 ç¼ºå°‘ç¼“å­˜ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ä½ç½®ï¼šå¤šä¸ªAPIç«¯ç‚¹

**ç¼ºå°‘ç¼“å­˜çš„å…³é”®æ•°æ®ï¼š**

| æ•°æ®ç±»å‹ | å½“å‰çŠ¶æ€ | å»ºè®®TTL | é¢„æœŸQPSæå‡ |
|---------|--------|--------|-----------|
| è§†é¢‘åˆ—è¡¨ | âŒ æ— ç¼“å­˜ | 60s | 10å€ |
| åˆ†ç±»åˆ—è¡¨ | âŒ æ— ç¼“å­˜ | 3600s | 100å€ |
| çƒ­é—¨è§†é¢‘ | âŒ æ— ç¼“å­˜ | 300s | 50å€ |
| ç”¨æˆ·VIPä¿¡æ¯ | âŒ æ— ç¼“å­˜ | 300s | 20å€ |
| è¯é¢˜åˆ—è¡¨ | âŒ æ— ç¼“å­˜ | 600s | 30å€ |

**å®ç°å»ºè®®ï¼š**
```python
# âœ… ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
from app.services.cache_service import cached, CacheTTL

@router.get("/categories")
@cached("categories:all", ttl=CacheTTL.LONG)
async def list_categories(db: AsyncSession):
    # æŸ¥è¯¢é€»è¾‘
    pass

# âœ… æ‰‹åŠ¨ç¼“å­˜ç®¡ç†
@router.get("/videos")
async def list_videos(...):
    cache_key = f"videos:list:{category_id}:{page}"
    
    # å°è¯•ä»ç¼“å­˜è·å–
    cached_data = await CacheService.get(cache_key)
    if cached_data:
        return cached_data
    
    # æŸ¥è¯¢æ•°æ®åº“
    videos = await db.execute(...)
    
    # å­˜å…¥ç¼“å­˜
    await CacheService.set(cache_key, videos, CacheTTL.SHORT)
    return videos
```

---

### 1.3 æ…¢æŸ¥è¯¢é—®é¢˜

#### é—®é¢˜ä½ç½®ï¼š`backend/app/api/videos.py`

**é—®é¢˜ä»£ç ï¼š**
```python
# âŒ æ²¡æœ‰ä½¿ç”¨é¢„åŠ è½½ï¼Œå¯¼è‡´å…³ç³»æŸ¥è¯¢ç¼“æ…¢
@router.get("")
async def list_videos(...):
    result = await db.execute(query)
    videos = result.scalars().all()
    
    for video in videos:
        # è®¿é—® video.tags æ—¶è§¦å‘é¢å¤–æŸ¥è¯¢
        tags = [tag.name for tag in video.tags]
```

**ä¿®å¤æ–¹æ¡ˆï¼š**
```python
# âœ… ä½¿ç”¨ selectinload é¢„åŠ è½½å…³ç³»
query = query.options(
    selectinload(Video.tags),
    selectinload(Video.uploader),
    selectinload(Video.category)
)
```

---

## 2. æ•°æ®åº“è®¾è®¡é—®é¢˜

### 2.1 ç´¢å¼•ç¼ºå¤±ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`backend/app/models/`

**ç¼ºå¤±çš„å…³é”®ç´¢å¼•ï¼š**

```python
# âŒ Post è¡¨ - ç¼ºå°‘å¤åˆç´¢å¼•
class Post(Base):
    __tablename__ = "posts"
    
    # ç°æœ‰ç´¢å¼•ä¸è¶³
    __table_args__ = (
        Index('idx_post_user_created', 'user_id', 'created_at'),
        Index('idx_post_status_created', 'status', 'created_at'),
    )
    
    # âŒ ç¼ºå°‘è¿™äº›ç´¢å¼•ï¼š
    # - æŒ‰è¯é¢˜æŸ¥è¯¢ï¼štopic_ids
    # - æŒ‰å¯è§æ€§æŸ¥è¯¢ï¼švisibility
    # - çƒ­é—¨æ’åºï¼šlike_count, view_count
```

**å»ºè®®æ·»åŠ çš„ç´¢å¼•ï¼š**

```python
# âœ… æ”¹è¿›çš„ç´¢å¼•ç­–ç•¥
class Post(Base):
    __table_args__ = (
        # ç°æœ‰ç´¢å¼•
        Index('idx_post_user_created', 'user_id', 'created_at'),
        Index('idx_post_status_created', 'status', 'created_at'),
        
        # æ–°å¢ç´¢å¼•
        Index('idx_post_visibility_created', 'visibility', 'created_at'),
        Index('idx_post_is_hot_created', 'is_hot', 'created_at'),
        Index('idx_post_like_count', 'like_count', 'created_at'),
        Index('idx_post_view_count', 'view_count', 'created_at'),
    )

class VideoView(Base):
    __table_args__ = (
        # ç°æœ‰ç´¢å¼•
        Index('idx_view_video_created', 'video_id', 'created_at'),
        Index('idx_view_user_video', 'user_id', 'video_id'),
        Index('idx_view_user_created', 'user_id', 'created_at'),
        
        # æ–°å¢ç´¢å¼•
        Index('idx_view_created', 'created_at'),  # ç”¨äºç»Ÿè®¡æŸ¥è¯¢
    )

class Comment(Base):
    __table_args__ = (
        Index('idx_comment_video_created', 'video_id', 'created_at'),
        Index('idx_comment_user_created', 'user_id', 'created_at'),
        Index('idx_comment_parent_id', 'parent_id'),
    )
```

**æ€§èƒ½å½±å“ï¼š**
- è§†é¢‘åˆ—è¡¨æŸ¥è¯¢ï¼šä» 2-3 ç§’ â†’ 100-200ms
- ç”¨æˆ·åŠ¨æ€æŸ¥è¯¢ï¼šä» 1-2 ç§’ â†’ 50-100ms

---

### 2.2 è¡¨ç»“æ„è®¾è®¡é—®é¢˜

#### é—®é¢˜1ï¼šJSONå­—æ®µå­˜å‚¨æ•°ç»„ï¼ˆä¸æ¨èï¼‰

```python
# âŒ ä½¿ç”¨ JSON å­˜å‚¨æ•°ç»„
class Post(Base):
    topic_ids = Column(JSON, default=list)  # å­˜å‚¨ [1, 2, 3]
    images = Column(JSON, default=list)     # å­˜å‚¨ ["url1", "url2"]
```

**é—®é¢˜ï¼š**
- æ— æ³•æœ‰æ•ˆç´¢å¼•
- æŸ¥è¯¢æ€§èƒ½å·®
- æ— æ³•è¿›è¡Œå…³ç³»çº¦æŸ

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```python
# âœ… ä½¿ç”¨å…³è”è¡¨
class PostTopic(Base):
    __tablename__ = "post_topics"
    post_id = Column(Integer, ForeignKey("posts.id"), primary_key=True)
    topic_id = Column(Integer, ForeignKey("topics.id"), primary_key=True)

class PostImage(Base):
    __tablename__ = "post_images"
    id = Column(Integer, primary_key=True)
    post_id = Column(Integer, ForeignKey("posts.id"))
    image_url = Column(String(500))
    sort_order = Column(Integer)
```

#### é—®é¢˜2ï¼šç¼ºå°‘è½¯åˆ é™¤æ ‡è®°

```python
# âŒ ç›´æ¥åˆ é™¤æ•°æ®
post.status = "deleted"  # åªæ˜¯æ ‡è®°ï¼Œæ²¡æœ‰çœŸæ­£åˆ é™¤

# âœ… åº”è¯¥æ·»åŠ  deleted_at å­—æ®µ
class Post(Base):
    deleted_at = Column(DateTime, nullable=True, index=True)
    
    # æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤
    @classmethod
    def active(cls):
        return cls.deleted_at == None
```

---

## 3. å‰ç«¯æ€§èƒ½é—®é¢˜

### 3.1 å¤§å‹Vueç»„ä»¶ï¼ˆé‡è¦ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`frontend/src/views/user/CommunityDetail.vue`

**é—®é¢˜åˆ†æï¼š**
```vue
<!-- âŒ å•ä¸ªæ–‡ä»¶åŒ…å«æ‰€æœ‰åŠŸèƒ½ -->
<template>
  <!-- å¸–å­è¯¦æƒ… -->
  <!-- è¯„è®ºåˆ—è¡¨ -->
  <!-- è¯„è®ºè¾“å…¥æ¡† -->
  <!-- å›¾ç‰‡é¢„è§ˆ -->
  <!-- åº•éƒ¨æ“ä½œæ  -->
</template>

<script setup>
// æ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ·
const post = ref(null)
const comments = ref([])
const commentText = ref('')
const replyTarget = ref(null)
const loadingComments = ref(false)
const hasMoreComments = ref(true)
const commentPage = ref(1)
const sortBy = ref('hot')
const showCommentInput = ref(false)
const previewVisible = ref(false)
// ... æ›´å¤šçŠ¶æ€
</script>
```

**é—®é¢˜ï¼š**
- å•ä¸ªç»„ä»¶è¶…è¿‡ 400 è¡Œä»£ç 
- çŠ¶æ€ç®¡ç†æ··ä¹±
- éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•
- å†…å­˜å ç”¨å¤§

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```
CommunityDetail.vue (ä¸»å®¹å™¨)
â”œâ”€â”€ PostHeader.vue (å¸–å­å¤´éƒ¨)
â”œâ”€â”€ PostContent.vue (å¸–å­å†…å®¹)
â”œâ”€â”€ CommentsList.vue (è¯„è®ºåˆ—è¡¨)
â”‚   â””â”€â”€ CommentItem.vue (å•æ¡è¯„è®º)
â”œâ”€â”€ CommentInput.vue (è¯„è®ºè¾“å…¥)
â””â”€â”€ ImagePreview.vue (å›¾ç‰‡é¢„è§ˆ)
```

---

### 3.2 é‡å¤è¯·æ±‚é—®é¢˜

#### é—®é¢˜ä»£ç ï¼š
```javascript
// âŒ æ¯æ¬¡æ’åºåˆ‡æ¢éƒ½é‡æ–°åŠ è½½æ‰€æœ‰è¯„è®º
const sortBy = ref('hot')

watch(sortBy, () => {
  fetchComments(true)  // é‡æ–°åŠ è½½
})

// âŒ æ²¡æœ‰è¯·æ±‚å»é‡
const likeComment = async (comment) => {
  const res = await api.post(`/community/comments/${comment.id}/like`)
  // å¦‚æœç”¨æˆ·å¿«é€Ÿç‚¹å‡»ï¼Œä¼šå‘é€å¤šä¸ªè¯·æ±‚
}
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```javascript
// âœ… ä½¿ç”¨é˜²æŠ–
import { debounce } from 'lodash-es'

const handleSortChange = debounce(() => {
  fetchComments(true)
}, 300)

// âœ… ä½¿ç”¨è¯·æ±‚å»é‡
const likeComment = async (comment) => {
  if (comment._liking) return  // é˜²æ­¢é‡å¤ç‚¹å‡»
  
  comment._liking = true
  try {
    const res = await api.post(`/community/comments/${comment.id}/like`)
    comment.is_liked = res.data.liked
  } finally {
    comment._liking = false
  }
}
```

---

### 3.3 å†…å­˜æ³„æ¼é£é™©

#### é—®é¢˜ä»£ç ï¼š
```javascript
// âŒ æ²¡æœ‰æ¸…ç†äº‹ä»¶ç›‘å¬
onMounted(() => {
  window.addEventListener('scroll', handleScroll)
  // ç»„ä»¶å¸è½½æ—¶æ²¡æœ‰ç§»é™¤ç›‘å¬
})

// âŒ æ²¡æœ‰æ¸…ç†å®šæ—¶å™¨
onMounted(() => {
  const timer = setInterval(() => {
    fetchComments()
  }, 5000)
  // ç»„ä»¶å¸è½½æ—¶æ²¡æœ‰æ¸…ç†å®šæ—¶å™¨
})

// âŒ æ²¡æœ‰æ¸…ç†APIè¯·æ±‚
const fetchComments = async () => {
  const res = await api.get(...)
  // å¦‚æœç»„ä»¶å¸è½½ï¼Œä»ç„¶ä¼šæ›´æ–°çŠ¶æ€
  comments.value = res.data
}
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```javascript
// âœ… æ­£ç¡®çš„æ¸…ç†
onMounted(() => {
  const handleScroll = () => { ... }
  window.addEventListener('scroll', handleScroll)
  
  onBeforeUnmount(() => {
    window.removeEventListener('scroll', handleScroll)
  })
})

// âœ… ä½¿ç”¨ AbortController å–æ¶ˆè¯·æ±‚
const controller = new AbortController()

const fetchComments = async () => {
  try {
    const res = await api.get(..., {
      signal: controller.signal
    })
    comments.value = res.data
  } catch (e) {
    if (e.name !== 'AbortError') {
      console.error(e)
    }
  }
}

onBeforeUnmount(() => {
  controller.abort()
})
```

---

## 4. å®‰å…¨é—®é¢˜

### 4.1 SQLæ³¨å…¥é£é™©ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`backend/app/api/community.py`

**é—®é¢˜ä»£ç ï¼š**
```python
# âŒ è™½ç„¶ä½¿ç”¨äº† SQLAlchemy ORMï¼Œä½†ä»æœ‰é£é™©
if search:
    query = query.where(Topic.name.contains(search))  # ç›¸å¯¹å®‰å…¨

# âŒ ä½†åœ¨æŸäº›åœ°æ–¹å¯èƒ½ä½¿ç”¨åŸç”ŸSQL
await db.execute(text(
    "INSERT INTO video_tags_association (video_id, tag_id) VALUES (:video_id, :tag_id)"
), {"video_id": video.id, "tag_id": tag.id})  # ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ˜¯å®‰å…¨çš„
```

**æ”¹è¿›å»ºè®®ï¼š**
```python
# âœ… å§‹ç»ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
from sqlalchemy import text

# å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
await db.execute(
    text("SELECT * FROM users WHERE username = :username"),
    {"username": username}
)

# âœ… ä½¿ç”¨ ORM è€Œä¸æ˜¯åŸç”Ÿ SQL
result = await db.execute(
    select(User).where(User.username == username)
)
```

---

### 4.2 XSSæ¼æ´ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`frontend/src/views/user/CommunityDetail.vue`

**é—®é¢˜ä»£ç ï¼š**
```vue
<!-- âŒ ç›´æ¥æ¸²æŸ“ç”¨æˆ·è¾“å…¥ -->
<p class="content-text">{{ post.content }}</p>

<!-- âŒ å¦‚æœ content åŒ…å« HTMLï¼Œä¼šè¢«æ‰§è¡Œ -->
<!-- ä¾‹å¦‚ï¼š<img src=x onerror="alert('XSS')"> -->
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```vue
<!-- âœ… Vue é»˜è®¤ä¼šè½¬ä¹‰ï¼Œä½†è¦ç¡®ä¿ -->
<p class="content-text">{{ post.content }}</p>

<!-- âœ… å¦‚æœéœ€è¦æ¸²æŸ“ HTMLï¼Œä½¿ç”¨ DOMPurify -->
<script setup>
import DOMPurify from 'dompurify'

const sanitizedContent = computed(() => {
  return DOMPurify.sanitize(post.value.content)
})
</script>

<p class="content-text" v-html="sanitizedContent"></p>
```

**åç«¯é˜²æŠ¤ï¼š**
```python
# âœ… åœ¨åç«¯è¿›è¡Œè¾“å…¥éªŒè¯å’Œæ¸…ç†
from bleach import clean

@router.post("/posts")
async def create_post(post_in: PostCreate, ...):
    # æ¸…ç† HTML æ ‡ç­¾
    post_in.content = clean(
        post_in.content,
        tags=[],  # ä¸å…è®¸ä»»ä½• HTML æ ‡ç­¾
        strip=True
    )
    
    # éªŒè¯é•¿åº¦
    if len(post_in.content) > 10000:
        raise HTTPException(status_code=400, detail="å†…å®¹è¿‡é•¿")
```

---

### 4.3 è®¤è¯æ¼æ´ï¼ˆé‡è¦ï¼‰

#### é—®é¢˜ä½ç½®ï¼š`backend/app/api/deps.py`

**é—®é¢˜åˆ†æï¼š**
```python
# âŒ ç¼ºå°‘é€Ÿç‡é™åˆ¶
@router.post("/login")
async def login(credentials: LoginRequest):
    # æ²¡æœ‰é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°
    # å®¹æ˜“è¢«æš´åŠ›ç ´è§£
    pass

# âŒ Token è¿‡æœŸæ—¶é—´å¤ªé•¿
ACCESS_TOKEN_EXPIRE_MINUTES: int = 30  # 30åˆ†é’Ÿå¯ä»¥æ¥å—
REFRESH_TOKEN_EXPIRE_DAYS: int = 7     # 7å¤©å¤ªé•¿äº†

# âŒ æ²¡æœ‰ Token é»‘åå•
# ç”¨æˆ·ç™»å‡ºåï¼ŒToken ä»ç„¶æœ‰æ•ˆ
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```python
# âœ… æ·»åŠ é€Ÿç‡é™åˆ¶
from app.core.rate_limit import rate_limit

@router.post("/login")
@rate_limit("5/minute")  # æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡
async def login(credentials: LoginRequest):
    pass

# âœ… ç¼©çŸ­ Token è¿‡æœŸæ—¶é—´
ACCESS_TOKEN_EXPIRE_MINUTES: int = 15  # 15åˆ†é’Ÿ
REFRESH_TOKEN_EXPIRE_DAYS: int = 3     # 3å¤©

# âœ… å®ç° Token é»‘åå•
class TokenBlacklist:
    def __init__(self):
        self.blacklist = set()
    
    async def add(self, token: str, expire_at: datetime):
        self.blacklist.add(token)
        # ä½¿ç”¨ Redis å­˜å‚¨ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
        await redis.setex(f"token:blacklist:{token}", expire_at, "1")
    
    async def is_blacklisted(self, token: str) -> bool:
        return await redis.exists(f"token:blacklist:{token}")

# ç™»å‡ºæ—¶æ·»åŠ åˆ°é»‘åå•
@router.post("/logout")
async def logout(current_user: User = Depends(get_current_user)):
    token = request.headers.get("Authorization", "").replace("Bearer ", "")
    await token_blacklist.add(token, datetime.utcnow() + timedelta(minutes=15))
```

---

## 5. ä»£ç è´¨é‡é—®é¢˜

### 5.1 é‡å¤ä»£ç ï¼ˆé‡è¦ï¼‰

#### é—®é¢˜ä½ç½®ï¼šå¤šä¸ªæ–‡ä»¶

**é‡å¤çš„ç”¨æˆ·VIPæŸ¥è¯¢é€»è¾‘ï¼š**
```python
# âŒ åœ¨å¤šä¸ªåœ°æ–¹é‡å¤
async def get_user_brief(db: AsyncSession, user: User) -> UserBriefResponse:
    vip_result = await db.execute(
        select(UserVIP).where(UserVIP.user_id == user.id, UserVIP.is_active == True)
    )
    vip = vip_result.scalar_one_or_none()
    is_vip = vip is not None and vip.expire_date and vip.expire_date > datetime.utcnow()
    vip_level = vip.vip_level if (is_vip and vip) else 0
    
    return UserBriefResponse(...)

# åŒæ ·çš„é€»è¾‘åœ¨ comments.py ä¸­é‡å¤
async def get_user_vip_level(db: AsyncSession, user_id: int) -> int:
    result = await db.execute(select(UserVIP).where(UserVIP.user_id == user_id))
    vip = result.scalar_one_or_none()
    if vip and vip.is_active and vip.expire_date and vip.expire_date > datetime.utcnow():
        return getattr(vip, 'vip_level', 0) or 0
    return 0
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```python
# âœ… åˆ›å»ºç»Ÿä¸€çš„å·¥å…·å‡½æ•°
# backend/app/services/user_service.py

class UserService:
    @staticmethod
    async def get_user_brief(db: AsyncSession, user: User) -> UserBriefResponse:
        vip = await UserService.get_user_vip(db, user.id)
        is_vip = vip and vip.is_active and vip.expire_date > datetime.utcnow()
        vip_level = vip.vip_level if is_vip else 0
        
        return UserBriefResponse(
            id=user.id,
            username=user.username,
            nickname=user.nickname,
            avatar=user.avatar,
            is_vip=is_vip,
            vip_level=vip_level
        )
    
    @staticmethod
    async def get_user_vip(db: AsyncSession, user_id: int) -> Optional[UserVIP]:
        result = await db.execute(
            select(UserVIP).where(UserVIP.user_id == user_id)
        )
        return result.scalar_one_or_none()
    
    @staticmethod
    async def is_user_vip(db: AsyncSession, user_id: int) -> bool:
        vip = await UserService.get_user_vip(db, user_id)
        return vip and vip.is_active and vip.expire_date > datetime.utcnow()
```

---

### 5.2 é”™è¯¯å¤„ç†ä¸å®Œå–„ï¼ˆé‡è¦ï¼‰

#### é—®é¢˜ä»£ç ï¼š
```python
# âŒ ç¼ºå°‘é”™è¯¯å¤„ç†
@router.post("/posts")
async def create_post(post_in: PostCreate, ...):
    post = Post(...)
    db.add(post)
    await db.commit()  # å¦‚æœå¤±è´¥ï¼Œæ²¡æœ‰å¤„ç†
    await db.refresh(post)
    
    # æ›´æ–°è¯é¢˜è®¡æ•°
    await db.execute(
        Topic.__table__.update()
        .where(Topic.id.in_(post_in.topic_ids))
        .values(post_count=Topic.post_count + 1)
    )
    await db.commit()  # å¦‚æœå¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´

# âŒ æ²¡æœ‰éªŒè¯è¾“å…¥
if not post_in.content.strip() and not post_in.images and not post_in.video_url:
    raise HTTPException(status_code=400, detail="åŠ¨æ€å†…å®¹ä¸èƒ½ä¸ºç©º")
# ä½†æ²¡æœ‰æ£€æŸ¥å†…å®¹é•¿åº¦ã€å›¾ç‰‡æ•°é‡ç­‰
```

**æ”¹è¿›æ–¹æ¡ˆï¼š**
```python
# âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
@router.post("/posts")
async def create_post(post_in: PostCreate, ...):
    # éªŒè¯è¾“å…¥
    if not post_in.content.strip() and not post_in.images and not post_in.video_url:
        raise HTTPException(status_code=400, detail="åŠ¨æ€å†…å®¹ä¸èƒ½ä¸ºç©º")
    
    if len(post_in.content) > 10000:
        raise HTTPException(status_code=400, detail="å†…å®¹è¿‡é•¿")
    
    if len(post_in.images) > 9:
        raise HTTPException(status_code=400, detail="æœ€å¤šä¸Šä¼ 9å¼ å›¾ç‰‡")
    
    try:
        # åˆ›å»ºå¸–å­
        post = Post(...)
        db.add(post)
        await db.flush()  # è·å– ID
        
        # æ›´æ–°è¯é¢˜è®¡æ•°
        if post_in.topic_ids:
            await db.execute(
                Topic.__table__.update()
                .where(Topic.id.in_(post_in.topic_ids))
                .values(post_count=Topic.post_count + 1)
            )
        
        await db.commit()
        
    except IntegrityError as e:
        await db.rollback()
        logger.error(f"åˆ›å»ºå¸–å­å¤±è´¥: {e}")
        raise HTTPException(status_code=400, detail="åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•")
    except Exception as e:
        await db.rollback()
        logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
        raise HTTPException(status_code=500, detail="æœåŠ¡å™¨é”™è¯¯")
```

---

## 6. ä¼˜åŒ–å»ºè®®æ€»ç»“

### ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | é—®é¢˜ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ |
|------|------|--------|------|
| ğŸ”´ P0 | N+1æŸ¥è¯¢ä¼˜åŒ– | æ€§èƒ½æå‡ 90% | ä¸­ |
| ğŸ”´ P0 | æ·»åŠ ç¼“å­˜å±‚ | QPSæå‡ 10-100å€ | ä¸­ |
| ğŸ”´ P0 | å®‰å…¨åŠ å›ºï¼ˆSQLæ³¨å…¥ã€XSSï¼‰ | é˜²æ­¢æ•°æ®æ³„éœ² | å° |
| ğŸŸ  P1 | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | æŸ¥è¯¢é€Ÿåº¦æå‡ 10å€ | å° |
| ğŸŸ  P1 | å‰ç«¯ç»„ä»¶æ‹†åˆ† | ä»£ç å¯ç»´æŠ¤æ€§æå‡ | å¤§ |
| ğŸŸ  P1 | è®¤è¯æœºåˆ¶åŠ å›º | é˜²æ­¢æš´åŠ›ç ´è§£ | å° |
| ğŸŸ¡ P2 | ä»£ç é‡æ„ï¼ˆæ¶ˆé™¤é‡å¤ï¼‰ | ä»£ç è´¨é‡æå‡ | ä¸­ |
| ğŸŸ¡ P2 | é”™è¯¯å¤„ç†å®Œå–„ | ç³»ç»Ÿç¨³å®šæ€§æå‡ | ä¸­ |

### å¿«é€Ÿèµ¢ï¼ˆå¯ç«‹å³å®æ–½ï¼‰

1. **æ·»åŠ ç¼“å­˜** - 30åˆ†é’Ÿå†…å¯å®æ–½ï¼Œæ€§èƒ½æå‡æ˜¾è‘—
2. **ä¿®å¤N+1æŸ¥è¯¢** - 1-2å°æ—¶ï¼Œæ€§èƒ½æå‡ 90%
3. **æ·»åŠ æ•°æ®åº“ç´¢å¼•** - 15åˆ†é’Ÿï¼ŒæŸ¥è¯¢é€Ÿåº¦æå‡ 10å€
4. **å®‰å…¨åŠ å›º** - 1å°æ—¶ï¼Œé˜²æ­¢å…³é”®æ¼æ´

---

## 7. å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼ˆç¬¬1-2å‘¨ï¼‰- æ€§èƒ½ä¼˜åŒ–
- [ ] ä¿®å¤æ‰€æœ‰ N+1 æŸ¥è¯¢
- [ ] å®ç°ç¼“å­˜å±‚
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
- [ ] æ€§èƒ½æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼ˆç¬¬3-4å‘¨ï¼‰- å®‰å…¨åŠ å›º
- [ ] ä¿®å¤ SQL æ³¨å…¥é£é™©
- [ ] ä¿®å¤ XSS æ¼æ´
- [ ] åŠ å¼ºè®¤è¯æœºåˆ¶
- [ ] å®‰å…¨å®¡è®¡

### ç¬¬ä¸‰é˜¶æ®µï¼ˆç¬¬5-8å‘¨ï¼‰- ä»£ç è´¨é‡
- [ ] å‰ç«¯ç»„ä»¶æ‹†åˆ†
- [ ] ä»£ç é‡æ„ï¼ˆæ¶ˆé™¤é‡å¤ï¼‰
- [ ] å®Œå–„é”™è¯¯å¤„ç†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–

---

## é™„å½•ï¼šå…³é”®ä»£ç ç‰‡æ®µ

### A. æ‰¹é‡æŸ¥è¯¢æ¨¡æ¿
```python
# è·å–æ‰€æœ‰ç›¸å…³ID
ids = list(set(item.related_id for item in items))

# æ‰¹é‡æŸ¥è¯¢
results = await db.execute(select(Model).where(Model.id.in_(ids)))
result_map = {r.id: r for r in results.scalars().all()}

# æ„å»ºå“åº”ï¼ˆæ— é¢å¤–æŸ¥è¯¢ï¼‰
for item in items:
    related = result_map.get(item.related_id)
```

### B. ç¼“å­˜ä½¿ç”¨æ¨¡æ¿
```python
cache_key = f"key:{param1}:{param2}"
cached = await CacheService.get(cache_key)
if cached:
    return cached

result = await fetch_data()
await CacheService.set(cache_key, result, ttl=300)
return result
```

### C. å®‰å…¨è¾“å…¥éªŒè¯
```python
from bleach import clean
from pydantic import validator

class PostCreate(BaseModel):
    content: str
    
    @validator('content')
    def validate_content(cls, v):
        if not v or len(v.strip()) == 0:
            raise ValueError('å†…å®¹ä¸èƒ½ä¸ºç©º')
        if len(v) > 10000:
            raise ValueError('å†…å®¹è¿‡é•¿')
        return clean(v, tags=[], strip=True)
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2024å¹´
**åˆ†æèŒƒå›´ï¼š** å®Œæ•´ä»£ç åº“
**å»ºè®®é‡‡çº³ç‡ï¼š** å»ºè®®ç«‹å³é‡‡çº³ P0 çº§åˆ«å»ºè®®
